<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ğŸ‘¶ ë§ˆì´ ë² ì´ë¹„ ì²´í¬ë¦¬ìŠ¤íŠ¸ (V23)</title>
    <link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        :root {
            --primary: #FF878D;
            --primary-bg: #FFF0F5;
            --bg-color: #F9FAFB;
            --card-bg: #FFFFFF;
            --text-main: #333333;
            --text-sub: #888888;
            --line: #EEEEEE;
            --danger: #FF5252;
        }
        
        [data-theme="dark"] {
            --bg-color: #111111;
            --card-bg: #1E1E1E;
            --text-main: #EEEEEE;
            --text-sub: #AAAAAA;
            --line: #333333;
            --primary-bg: #332222;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
        body { font-family: 'Pretendard', sans-serif; background-color: var(--bg-color); color: var(--text-main); margin: 0; padding: 0; padding-bottom: 150px; }
        .container { max-width: 600px; margin: 0 auto; }

        /* í—¤ë” */
        .header { background: rgba(255,255,255,0.8); backdrop-filter: blur(10px); padding: 15px 20px; position: sticky; top: 0; z-index: 100; border-bottom: 1px solid var(--line); }
        [data-theme="dark"] .header { background: rgba(30,30,30,0.8); }
        .header-top { display: flex; justify-content: space-between; align-items: center; }
        .app-title { font-size: 20px; font-weight: 800; color: var(--text-main); }
        .header-actions { display: flex; gap: 10px; }
        .icon-btn { width: 36px; height: 36px; border-radius: 10px; background: var(--bg-color); border: 1px solid var(--line); display: flex; align-items: center; justify-content: center; cursor: pointer; color: var(--text-main); font-size: 16px; }

        /* ì§„í–‰ë¥  */
        .progress-area { padding: 20px; background: var(--card-bg); margin: 15px 20px; border-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.03); }
        .progress-info { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 14px; font-weight: 600; color: var(--text-sub); }
        .total-price { color: var(--primary); font-weight: 800; }
        .progress-bar-bg { height: 10px; background: var(--line); border-radius: 5px; overflow: hidden; }
        .progress-bar { height: 100%; background: var(--primary); width: 0%; transition: width 0.5s; }

        /* ì¹´í…Œê³ ë¦¬ ì¹´ë“œ */
        .category-card { background: var(--card-bg); margin: 15px 20px; border-radius: 16px; border: 1px solid var(--line); overflow: hidden; transition: transform 0.2s; }
        .category-card.collapsed .item-list, .category-card.collapsed .add-btn-area { display: none; }
        
        .cat-header { padding: 15px; display: flex; align-items: center; justify-content: space-between; cursor: pointer; background: var(--card-bg); }
        .cat-info { display: flex; align-items: center; gap: 12px; }
        .cat-icon { width: 40px; height: 40px; border-radius: 12px; background: var(--primary-bg); display: flex; align-items: center; justify-content: center; font-size: 20px; }
        .cat-title { font-size: 16px; font-weight: 700; }
        .cat-sub { font-size: 12px; color: var(--text-sub); margin-top: 2px; }
        
        /* ì•„ì´í…œ ë¦¬ìŠ¤íŠ¸ */
        .item-list { list-style: none; padding: 0; margin: 0; }
        .item { padding: 12px 15px; border-top: 1px solid var(--line); display: flex; align-items: center; gap: 12px; background: var(--card-bg); }
        .item:active { background-color: var(--bg-color); }
        .item.completed .item-name { text-decoration: line-through; color: var(--text-sub); opacity: 0.6; }
        
        /* ì»¤ìŠ¤í…€ ì²´í¬ë°•ìŠ¤ */
        .chk-wrap { position: relative; width: 22px; height: 22px; flex-shrink: 0; }
        .chk-input { position: absolute; width: 100%; height: 100%; opacity: 0; cursor: pointer; z-index: 2; }
        .chk-box { width: 100%; height: 100%; border: 2px solid #DDD; border-radius: 6px; display: flex; align-items: center; justify-content: center; transition: 0.2s; }
        .chk-input:checked + .chk-box { background: var(--primary); border-color: var(--primary); }
        .chk-box::after { content: 'âœ”'; color: white; font-size: 12px; display: none; }
        .chk-input:checked + .chk-box::after { display: block; }

        .item-content { flex: 1; min-width: 0; }
        .item-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; }
        .item-name { font-size: 15px; font-weight: 600; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .item-tags { display: flex; gap: 5px; flex-wrap: wrap; }
        .tag { font-size: 10px; padding: 3px 6px; border-radius: 4px; background: var(--bg-color); color: var(--text-sub); font-weight: 500; }
        .tag.price { background: #FFF5F5; color: var(--primary); font-weight: 700; }
        .tag.carrot { background: #FFF3E0; color: #FF9800; }
        .tag.gift { background: #F3E5F5; color: #9C27B0; }

        /* âœ¨ ì„¸ë ¨ëœ ìˆ˜ì •/ì‚­ì œ ë²„íŠ¼ (SVG ì‚¬ìš©) */
        .item-actions { display: none; gap: 12px; margin-left: 8px; }
        body.is-edit-mode .item-actions { display: flex; }
        
        .action-btn { 
            width: 28px; height: 28px; border-radius: 6px; border: none; 
            background: transparent; cursor: pointer; display: flex; align-items: center; justify-content: center;
            transition: background 0.2s;
        }
        .action-btn:hover { background: var(--bg-color); }
        .action-btn svg { width: 16px; height: 16px; stroke: var(--text-sub); stroke-width: 2; fill: none; }
        .action-btn.del:hover svg { stroke: var(--danger); }
        .action-btn.edit:hover svg { stroke: var(--primary); }

        /* ì¶”ê°€ ë²„íŠ¼ */
        .add-btn-area { padding: 12px; }
        .btn-add { width: 100%; padding: 12px; background: var(--primary-bg); color: var(--primary); border: none; border-radius: 10px; font-weight: 700; cursor: pointer; font-size: 14px; }
        .fab { position: fixed; bottom: 30px; right: 25px; width: 56px; height: 56px; border-radius: 50%; background: var(--primary); color: white; border: none; font-size: 28px; box-shadow: 0 4px 15px rgba(255, 135, 141, 0.4); cursor: pointer; z-index: 90; display: flex; align-items: center; justify-content: center; }

        /* ğŸ’¾ ì‹¤í–‰ì·¨ì†Œ ìŠ¤ë‚µë°” (ìì²´ êµ¬í˜„) */
        #undoBar {
            position: fixed; bottom: -60px; left: 50%; transform: translateX(-50%);
            background: #333; color: white; padding: 14px 20px; border-radius: 30px;
            display: flex; gap: 20px; align-items: center; font-size: 14px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3); transition: bottom 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 200; width: 90%; max-width: 400px; justify-content: space-between;
        }
        #undoBar.show { bottom: 30px; }
        .undo-btn { color: var(--primary); font-weight: 700; cursor: pointer; text-transform: uppercase; }

        /* ëª¨ë‹¬ ê³µí†µ */
        .modal-wrap { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 300; align-items: center; justify-content: center; backdrop-filter: blur(3px); }
        .modal { background: var(--card-bg); width: 90%; max-width: 400px; padding: 25px; border-radius: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); max-height: 90vh; overflow-y: auto; }
        .input-box { margin-bottom: 15px; }
        .label { display: block; font-size: 12px; color: var(--text-sub); margin-bottom: 5px; font-weight: 600; }
        .input { width: 100%; padding: 12px; border: 1px solid var(--line); border-radius: 10px; background: var(--bg-color); color: var(--text-main); font-size: 15px; outline: none; }
        .btn-row { display: flex; gap: 10px; margin-top: 20px; }
        .btn-full { flex: 1; padding: 14px; border: none; border-radius: 12px; font-weight: 700; cursor: pointer; }
        .btn-gray { background: var(--bg-color); color: var(--text-sub); }
        .btn-primary { background: var(--primary); color: white; }

        /* ì•„ì´ì½˜ ê·¸ë¦¬ë“œ */
        .icon-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 5px; max-height: 150px; overflow-y: auto; padding: 5px; border: 1px solid var(--line); border-radius: 10px; margin-top: 5px; }
        .icon-item { font-size: 22px; text-align: center; padding: 8px; border-radius: 8px; cursor: pointer; }
        .icon-item.selected { background: var(--primary-bg); border: 1px solid var(--primary); }

        /* ê²€ìƒ‰ì°½ ë“± */
        .filter-bar { padding: 0 20px; margin-bottom: 10px; display: none; }
        .search-input { width: 100%; padding: 12px; border: none; border-radius: 12px; background: var(--card-bg); box-shadow: 0 2px 10px rgba(0,0,0,0.05); outline: none; }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-top">
            <span class="app-title">ğŸ‘¶ ë§ˆì´ ë² ì´ë¹„ ì²´í¬ë¦¬ìŠ¤íŠ¸</span>
            <div class="header-actions">
                <button class="icon-btn" onclick="toggleSearch()">ğŸ”</button>
                <button class="icon-btn" onclick="toggleEditMode()" id="editToggle">âœï¸</button>
                <button class="icon-btn" onclick="toggleTheme()">ğŸŒ“</button>
            </div>
        </div>
    </div>

    <div class="filter-bar" id="searchBar">
        <input type="text" class="search-input" placeholder="ë¬¼í’ˆëª… ê²€ìƒ‰..." onkeyup="filterList(this.value)">
    </div>

    <div class="progress-area">
        <div class="progress-info">
            <span>ì¤€ë¹„ìœ¨ <span id="percentTxt">0%</span></span>
            <span>ì´ ì§€ì¶œ <span class="total-price" id="totalBudget">0</span>ì›</span>
        </div>
        <div class="progress-bar-bg"><div class="progress-bar" id="progressBar"></div></div>
    </div>

    <div class="container" id="listContainer">
        <div style="text-align:center; padding:50px; color:#aaa;">
            <p>ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
            <button class="btn-primary btn-full" style="width:auto; margin-top:20px;" onclick="initData()">ğŸ“ ê¸°ë³¸ ë¦¬ìŠ¤íŠ¸ 80ì¢… ë“±ë¡</button>
        </div>
    </div>

    <div id="undoBar">
        <span>ğŸ—‘ï¸ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.</span>
        <span class="undo-btn" onclick="executeUndo()">ì‹¤í–‰ì·¨ì†Œ</span>
    </div>

    <button class="fab" onclick="openCatModal()">+</button>

    <div class="modal-wrap" id="catModal">
        <div class="modal">
            <h3>ğŸ“‚ ì¹´í…Œê³ ë¦¬</h3>
            <input type="hidden" id="cId">
            <div class="input-box">
                <span class="label">ì´ë¦„</span>
                <input type="text" id="cName" class="input">
            </div>
            <div class="input-box">
                <span class="label">ì•„ì´ì½˜ ê²€ìƒ‰</span>
                <input type="text" class="input" placeholder="ê²€ìƒ‰ì–´ ì…ë ¥ (ì˜ˆ: ë³‘ì›)" onkeyup="renderIcons(this.value, 'cIcons')">
                <div class="icon-grid" id="cIcons"></div>
                <input type="hidden" id="cIconVal">
            </div>
            <div class="btn-row">
                <button class="btn-full btn-gray" onclick="closeModal('catModal')">ì·¨ì†Œ</button>
                <button class="btn-full btn-primary" onclick="saveCat()">ì €ì¥</button>
            </div>
        </div>
    </div>

    <div class="modal-wrap" id="itemModal">
        <div class="modal">
            <h3>âœ¨ ë¬¼í’ˆ ë“±ë¡</h3>
            <input type="hidden" id="targetCId"><input type="hidden" id="targetIId">
            <div class="input-box">
                <span class="label">ë¬¼í’ˆëª…</span>
                <input type="text" id="iName" class="input">
            </div>
            <div style="display:flex; gap:10px;">
                <div class="input-box" style="width:100px;">
                    <span class="label">ìˆ˜ëŸ‰</span>
                    <input type="number" id="iCount" class="input" value="1" style="text-align:center;">
                </div>
                <div class="input-box" style="flex:1;">
                    <span class="label">ê°€ê²©</span>
                    <input type="text" id="iPrice" class="input" placeholder="ì›">
                </div>
            </div>
            <div class="input-box">
                <span class="label">ë¸Œëœë“œ/ë©”ëª¨</span>
                <input type="text" id="iBrand" class="input" placeholder="ë¸Œëœë“œ">
                <input type="text" id="iMemo" class="input" placeholder="ë©”ëª¨" style="margin-top:5px;">
            </div>
            <div class="input-box">
                <span class="label">ì•„ì´ì½˜</span>
                <div class="icon-grid" id="iIcons"></div>
                <input type="hidden" id="iIconVal">
            </div>
            <div class="input-box">
                <span class="label">ì˜µì…˜</span>
                <label style="display:flex; gap:8px; align-items:center; margin-bottom:5px;">
                    <input type="checkbox" id="iGift"> ğŸ ì„ ë¬¼ ë°›ìŒ (ì§€ì¶œ ì œì™¸)
                </label>
                <label style="display:flex; gap:8px; align-items:center;">
                    <input type="checkbox" id="iCarrot"> ğŸ¥• ë‹¹ê·¼ë§ˆì¼“/ì¤‘ê³ 
                </label>
            </div>
            <div class="btn-row">
                <button class="btn-full btn-gray" onclick="closeModal('itemModal')">ì·¨ì†Œ</button>
                <button class="btn-full btn-primary" onclick="saveItem()">ì €ì¥</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getDatabase, ref, onValue, push, update, remove } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCovHk7sYoMTkZ8H5RwKjUWMXAqi50l2L-k",
            authDomain: "checklist-3c59d.firebaseapp.com",
            databaseURL: "https://checklist-3c59d-default-rtdb.firebaseio.com",
            projectId: "checklist-3c59d",
            storageBucket: "checklist-3c59d.firebasestorage.app",
            messagingSenderId: "624967682899",
            appId: "1:624967682899:web:a6640fa7b63ee2eab9afa6"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const dbRef = ref(db, 'baby_checklist_v6');

        let currentData = {};
        let isEditMode = false;
        let lastDeleted = null;
        let undoTimer = null;

        // âœ… 1. í™•ì‹¤í•œ ì•„ì´ì½˜ DB
        const iconList = [
            {c:'ğŸ‘¶',k:'ì•„ê¸°'},{c:'ğŸ¥',k:'ë³‘ì›'},{c:'ğŸ’Š',k:'ì•½'},{c:'ğŸ’‰',k:'ì£¼ì‚¬'},{c:'ğŸŒ¡ï¸',k:'ì²´ì˜¨ê³„'},{c:'ğŸ¼',k:'ì –ë³‘'},{c:'ğŸ§¼',k:'ë¹„ëˆ„'},
            {c:'ğŸ›',k:'ìš•ì¡°'},{c:'ğŸ¥£',k:'ì´ìœ ì‹'},{c:'ğŸ§´',k:'ë¡œì…˜'},{c:'ğŸ§»',k:'íœ´ì§€'},{c:'ğŸ‘•',k:'ì˜·'},{c:'ğŸ§¦',k:'ì–‘ë§'},{c:'ğŸ§¢',k:'ëª¨ì'},
            {c:'ğŸ›ï¸',k:'ì¹¨ëŒ€'},{c:'ğŸ§¸',k:'ì¥ë‚œê°'},{c:'ğŸš—',k:'ì°¨'},{c:'ğŸšŒ',k:'ë²„ìŠ¤'},{c:'ğŸ',k:'ì„ ë¬¼'},{c:'ğŸ“¸',k:'ì‚¬ì§„'},{c:'ğŸ“±',k:'í°'},
            {c:'ğŸ ',k:'ì§‘'},{c:'ğŸ¤°',k:'ì„ì‹ '},{c:'ğŸ¥„',k:'ìˆŸê°€ë½'},{c:'ğŸ¥¢',k:'ì “ê°€ë½'},{c:'âœ‚ï¸',k:'ê°€ìœ„'},{c:'ğŸ–Šï¸',k:'íœ'},{c:'ğŸ“',k:'ë©”ëª¨'},
            {c:'â­',k:'ë³„'},{c:'â¤ï¸',k:'í•˜íŠ¸'},{c:'ğŸ¥›',k:'ìš°ìœ '},{c:'ğŸ§Š',k:'ì–¼ìŒ'},{c:'ğŸ',k:'ì‚¬ê³¼'},{c:'ğŸŒ',k:'ë°”ë‚˜ë‚˜'},{c:'ğŸ¥•',k:'ë‹¹ê·¼'},
            {c:'ğŸ¶',k:'ê°•ì•„ì§€'},{c:'ğŸ±',k:'ê³ ì–‘ì´'},{c:'ğŸ˜·',k:'ë§ˆìŠ¤í¬'},{c:'ğŸ§¹',k:'ì²­ì†Œ'},{c:'ğŸ§º',k:'ë¹¨ë˜'},{c:'ğŸš½',k:'ë³€ê¸°'},{c:'ğŸš¿',k:'ìƒ¤ì›Œ'}
        ];

        onValue(dbRef, (snap) => {
            currentData = snap.val() || {};
            render();
        });

        function render() {
            const list = document.getElementById('listContainer');
            list.innerHTML = '';
            
            let total = 0;
            let checked = 0;
            let cnt = 0;

            const cats = Object.entries(currentData).map(([id,v])=>({id,...v})).sort((a,b)=>(a.order||0)-(b.order||0));
            
            if(cats.length === 0) {
                list.innerHTML = `<div style="text-align:center; padding:50px; color:#aaa;"><p>ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p><button class="btn-primary btn-full" style="width:auto; margin-top:20px;" onclick="window.initData()">ğŸ“ ê¸°ë³¸ ë¦¬ìŠ¤íŠ¸ 80ì¢… ë“±ë¡</button></div>`;
                return;
            }

            cats.forEach(c => {
                const items = Object.entries(c.items||{}).map(([id,v])=>({id,...v})).sort((a,b)=>(a.order||0)-(b.order||0));
                let cTotal = 0;
                let itemsHtml = '';

                items.forEach(i => {
                    const price = Number((i.price+'').replace(/,/g,'')) || 0;
                    if(!i.isGift) cTotal += price * (i.count||1);
                    if(!i.isGift) total += price * (i.count||1);
                    if(i.checked) checked++;
                    cnt++;

                    let tags = '';
                    if(i.isGift) tags += `<span class="tag gift">ğŸ ì„ ë¬¼</span>`;
                    else if(price>0) tags += `<span class="tag price">${price.toLocaleString()}ì›</span>`;
                    if(i.isCarrot) tags += `<span class="tag carrot">ğŸ¥• ë‹¹ê·¼</span>`;
                    if(i.brand) tags += `<span class="tag">${i.brand}</span>`;

                    // âœ¨ ë””ìì¸ ê°œì„ : SVG ìˆ˜ì •/ì‚­ì œ ì•„ì´ì½˜
                    itemsHtml += `
                        <li class="item ${i.checked?'completed':''}" data-id="${i.id}">
                            <div class="chk-wrap">
                                <input type="checkbox" class="chk-input" ${i.checked?'checked':''} onchange="window.toggleCheck('${c.id}','${i.id}',this.checked)">
                                <div class="chk-box"></div>
                            </div>
                            <div class="item-content" onclick="window.editItem('${c.id}','${i.id}')">
                                <div class="item-row">
                                    <div class="item-name">${i.icon||'ğŸ‘¶'} ${i.name} ${i.count>1 ? `<small>x${i.count}</small>` : ''}</div>
                                    <div class="item-actions">
                                        <button class="action-btn edit" onclick="event.stopPropagation(); window.editItem('${c.id}','${i.id}')">
                                            <svg viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0115.75 21H5.25A2.25 2.25 0 013 18.75V8.25A2.25 2.25 0 015.25 6H10"></path></svg>
                                        </button>
                                        <button class="action-btn del" onclick="event.stopPropagation(); window.delItem('${c.id}','${i.id}')">
                                            <svg viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0"></path></svg>
                                        </button>
                                    </div>
                                </div>
                                <div class="item-tags">${tags}</div>
                            </div>
                        </li>
                    `;
                });

                const div = document.createElement('div');
                div.className = 'category-card';
                div.innerHTML = `
                    <div class="cat-header" onclick="this.parentElement.classList.toggle('collapsed')">
                        <div class="cat-info">
                            <div class="cat-icon">${c.icon||'ğŸ“'}</div>
                            <div>
                                <div class="cat-title">${c.name}</div>
                                <div class="cat-sub">${cTotal.toLocaleString()}ì›</div>
                            </div>
                        </div>
                        <div style="display:flex; align-items:center; gap:5px;">
                            <div class="item-actions">
                                <button class="action-btn edit" onclick="event.stopPropagation(); window.editCat('${c.id}')">
                                    <svg viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0115.75 21H5.25A2.25 2.25 0 013 18.75V8.25A2.25 2.25 0 015.25 6H10"></path></svg>
                                </button>
                                <button class="action-btn del" onclick="event.stopPropagation(); window.delCat('${c.id}')">
                                    <svg viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0"></path></svg>
                                </button>
                            </div>
                            <div style="font-size:12px; color:#ccc;">â–¼</div>
                        </div>
                    </div>
                    <ul class="item-list">${itemsHtml}</ul>
                    <div class="add-btn-area">
                        <button class="btn-add" onclick="window.addItem('${c.id}')">+ ë¬¼í’ˆ ì¶”ê°€</button>
                    </div>
                `;
                list.appendChild(div);
                
                // Sortable
                new Sortable(div.querySelector('.item-list'), { 
                    animation: 150, handle: '.item-content', disabled: !isEditMode,
                    onEnd: (evt) => {
                        const ids = Array.from(evt.to.children).map(li => li.getAttribute('data-id'));
                        const updates = {};
                        ids.forEach((id, idx) => updates[`baby_checklist_v6/${c.id}/items/${id}/order`] = idx);
                        update(ref(db), updates);
                    }
                });
            });

            // Progress Update
            const percent = cnt === 0 ? 0 : Math.round((checked / cnt) * 100);
            document.getElementById('progressBar').style.width = `${percent}%`;
            document.getElementById('percentTxt').innerText = `${percent}%`;
            document.getElementById('totalBudget').innerText = total.toLocaleString();
            
            document.body.classList.toggle('is-edit-mode', isEditMode);
        }

        // Global functions
        window.toggleEditMode = () => { isEditMode = !isEditMode; render(); };
        window.toggleTheme = () => {
            const isDark = document.body.getAttribute('data-theme') === 'dark';
            document.body.setAttribute('data-theme', isDark ? '' : 'dark');
            localStorage.setItem('theme', isDark ? 'light' : 'dark');
        };
        window.toggleSearch = () => {
            const bar = document.getElementById('searchBar');
            bar.style.display = bar.style.display === 'block' ? 'none' : 'block';
            if(bar.style.display === 'block') bar.querySelector('input').focus();
        };
        window.filterList = (k) => {
            document.querySelectorAll('.item').forEach(el => {
                el.style.display = el.innerText.includes(k) ? 'flex' : 'none';
            });
        };
        window.toggleCheck = (c, i, v) => update(ref(db, `baby_checklist_v6/${c}/items/${i}`), { checked: v });

        // ğŸ—‘ï¸ ì‚­ì œ ë° ì‹¤í–‰ ì·¨ì†Œ (ìŠ¤ë‚µë°” êµ¬í˜„)
        window.delItem = (c, i) => {
            if(!confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            const data = currentData[c].items[i];
            lastDeleted = { path: `baby_checklist_v6/${c}/items/${i}`, data: data };
            remove(ref(db, lastDeleted.path));
            showUndo();
        };
        window.delCat = (c) => {
            if(!confirm('ì¹´í…Œê³ ë¦¬ê°€ ì‚­ì œë©ë‹ˆë‹¤.')) return;
            const data = currentData[c];
            lastDeleted = { path: `baby_checklist_v6/${c}`, data: data };
            remove(ref(db, lastDeleted.path));
            showUndo();
        };
        function showUndo() {
            const bar = document.getElementById('undoBar');
            bar.classList.add('show');
            if(undoTimer) clearTimeout(undoTimer);
            undoTimer = setTimeout(() => { bar.classList.remove('show'); lastDeleted = null; }, 4000);
        }
        window.executeUndo = () => {
            if(lastDeleted) update(ref(db), { [lastDeleted.path]: lastDeleted.data });
            document.getElementById('undoBar').classList.remove('show');
        };

        // Modal Logic
        window.closeModal = (id) => document.getElementById(id).style.display = 'none';
        
        // ì•„ì´ì½˜ ë Œë”ë§ (í™•ì‹¤í•˜ê²Œ ìˆ˜ì •ë¨)
        window.renderIcons = (k, target) => {
            const grid = document.getElementById(target);
            grid.innerHTML = '';
            const filtered = k ? iconList.filter(x => x.k.includes(k)) : iconList;
            filtered.forEach(x => {
                const el = document.createElement('div');
                el.className = 'icon-item';
                el.innerText = x.c;
                el.onclick = () => {
                    const inputId = target === 'cIcons' ? 'cIconVal' : 'iIconVal';
                    document.getElementById(inputId).value = x.c; // ê°’ ì €ì¥
                    Array.from(grid.children).forEach(c => c.classList.remove('selected'));
                    el.classList.add('selected');
                };
                grid.appendChild(el);
            });
        };

        // Category Modal
        window.openCatModal = () => {
            document.getElementById('catModal').style.display = 'flex';
            document.getElementById('cId').value = '';
            document.getElementById('cName').value = '';
            window.renderIcons('', 'cIcons');
        };
        window.editCat = (id) => {
            document.getElementById('catModal').style.display = 'flex';
            const d = currentData[id];
            document.getElementById('cId').value = id;
            document.getElementById('cName').value = d.name;
            window.renderIcons('', 'cIcons');
        };
        window.saveCat = () => {
            const id = document.getElementById('cId').value;
            const name = document.getElementById('cName').value;
            const icon = document.getElementById('cIconVal').value || 'ğŸ“';
            if(!name) return alert('ì´ë¦„ ì…ë ¥');
            if(id) update(ref(db, `baby_checklist_v6/${id}`), { name, icon });
            else push(ref(db, 'baby_checklist_v6'), { name, icon, order: 999 });
            window.closeModal('catModal');
        };

        // Item Modal
        window.addItem = (cId) => {
            document.getElementById('itemModal').style.display = 'flex';
            document.getElementById('targetCId').value = cId;
            document.getElementById('targetIId').value = '';
            // ì´ˆê¸°í™”
            document.getElementById('iName').value = '';
            document.getElementById('iCount').value = 1;
            document.getElementById('iPrice').value = '';
            document.getElementById('iBrand').value = '';
            document.getElementById('iMemo').value = '';
            document.getElementById('iGift').checked = false;
            document.getElementById('iCarrot').checked = false;
            window.renderIcons('', 'iIcons');
        };
        window.editItem = (c, i) => {
            const d = currentData[c].items[i];
            document.getElementById('itemModal').style.display = 'flex';
            document.getElementById('targetCId').value = c;
            document.getElementById('targetIId').value = i;
            document.getElementById('iName').value = d.name;
            document.getElementById('iCount').value = d.count || 1;
            document.getElementById('iPrice').value = d.price || '';
            document.getElementById('iBrand').value = d.brand || '';
            document.getElementById('iMemo').value = d.memo || '';
            document.getElementById('iGift').checked = d.isGift || false;
            document.getElementById('iCarrot').checked = d.isCarrot || false;
            window.renderIcons('', 'iIcons');
        };
        window.saveItem = () => {
            const c = document.getElementById('targetCId').value;
            const i = document.getElementById('targetIId').value;
            const data = {
                name: document.getElementById('iName').value,
                count: Number(document.getElementById('iCount').value),
                price: document.getElementById('iPrice').value,
                brand: document.getElementById('iBrand').value,
                memo: document.getElementById('iMemo').value,
                icon: document.getElementById('iIconVal').value || 'ğŸ‘¶',
                isGift: document.getElementById('iGift').checked,
                isCarrot: document.getElementById('iCarrot').checked,
                checked: false, order: 999
            };
            if(!data.name) return alert('ì´ë¦„ ì…ë ¥');
            
            if(i) {
                const old = currentData[c].items[i];
                data.checked = old.checked;
                data.order = old.order !== undefined ? old.order : 999;
                update(ref(db, `baby_checklist_v6/${c}/items/${i}`), data);
            } else {
                push(ref(db, `baby_checklist_v6/${c}/items`), data);
            }
            window.closeModal('itemModal');
        };

        // ì´ˆê¸° ë°ì´í„° (ë³µêµ¬)
        window.initData = async () => {
            if(!confirm('ë¦¬ìŠ¤íŠ¸ë¥¼ ë“±ë¡í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            const d = [
                {name:"ì¶œì‚°ê°€ë°©",icon:"ğŸ¥",items:[{name:"ì‚°ëª¨ìˆ˜ì²©",icon:"ğŸ“’"},{name:"ì‹ ë¶„ì¦",icon:"ğŸ’³"},{name:"ì¶©ì „ê¸°",icon:"âš¡"}]},
                {name:"ìˆ˜ìœ ìš©í’ˆ",icon:"ğŸ¼",items:[{name:"ì –ë³‘",icon:"ğŸ¼"},{name:"ë¶„ìœ ",icon:"ğŸ¥«"},{name:"ì –ë³‘ì†”",icon:"ğŸ–Œï¸"}]},
                {name:"ìœ„ìƒìš©í’ˆ",icon:"ğŸ©¹",items:[{name:"ì²´ì˜¨ê³„",icon:"ğŸŒ¡ï¸"},{name:"ì†ìˆ˜ê±´",icon:"ğŸ§£"},{name:"ê¸°ì €ê·€",icon:"ğŸ©²"}]}
            ];
            for(const c of d){
                const r = await push(ref(db, 'baby_checklist_v6'), {name:c.name, icon:c.icon, order:999});
                for(const i of c.items) await push(ref(db, `baby_checklist_v6/${r.key}/items`), {...i, checked:false});
            }
            alert("ì™„ë£Œ!");
        };
    </script>
</body>
</html>
