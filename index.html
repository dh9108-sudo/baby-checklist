<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ğŸ‘¶ ìš°ë¦¬ ì•„ê¸° ë§ì´ ì¤€ë¹„ë¬¼ (V12)</title>
    <link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        :root {
            --main-color: #FF878D;
            --sub-color: #FFF0F5;
            --bg-color: #F7F8FA;
            --text-color: #333;
            --price-color: #FF6B6B;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Pretendard', sans-serif; background-color: var(--bg-color); margin: 0; padding: 0; color: var(--text-color); }
        .container { max-width: 600px; margin: 0 auto; padding-bottom: 150px; }

        /* í—¤ë” */
        .header { background: linear-gradient(120deg, #ff9a9e 0%, #fecfef 100%); padding: 20px 20px 25px; color: white; border-radius: 0 0 25px 25px; box-shadow: 0 4px 20px rgba(255, 154, 158, 0.3); }
        .header-top-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .header h2 { margin: 0; font-size: 20px; font-weight: 800; }
        
        .edit-toggle-wrap { display: flex; align-items: center; gap: 8px; font-size: 13px; font-weight: 600; }
        .switch { position: relative; display: inline-block; width: 44px; height: 24px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(255,255,255,0.4); transition: .4s; border-radius: 24px; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: rgba(255,255,255,0.95); }
        input:checked + .slider:before { transform: translateX(20px); background-color: var(--main-color); }

        .total-budget-badge { background: rgba(255,255,255,0.95); color: var(--main-color); padding: 6px 12px; border-radius: 15px; font-weight: bold; font-size: 13px; display: inline-block; }
        .progress-box { background: rgba(255,255,255,0.25); backdrop-filter: blur(5px); padding: 15px; border-radius: 12px; display: flex; align-items: center; justify-content: space-between; margin-top: 10px; }
        .progress-circle { width: 45px; height: 45px; border-radius: 50%; background: white; color: var(--main-color); display: flex; align-items: center; justify-content: center; font-weight: 800; font-size: 13px; }
        .progress-bar-bg { flex: 1; height: 6px; background: rgba(255,255,255,0.5); border-radius: 4px; margin: 0 15px; overflow: hidden; }
        .progress-bar { height: 100%; background: white; width: 0%; transition: width 0.5s ease; }
        .total-info { font-size: 12px; font-weight: 600; text-align: right;}

        /* ì¹´í…Œê³ ë¦¬ & ì•„ì´í…œ */
        .category-card { background: white; margin: 20px; border-radius: 16px; box-shadow: 0 2px 10px rgba(0,0,0,0.03); overflow: hidden; position: relative; }
        .category-card.sortable-ghost { opacity: 0.4; background: #eee; }
        
        .cat-header { padding: 15px 20px; background: #fff; border-bottom: 1px solid #f0f0f0; display: flex; justify-content: space-between; align-items: center; }
        .cat-left { display: flex; align-items: center; gap: 10px; }
        .drag-handle-cat { display: none; color: var(--main-color); font-size: 22px; cursor: grab; margin-right: 5px; font-weight: bold; }
        
        .cat-icon { font-size: 18px; background: var(--sub-color); width: 32px; height: 32px; border-radius: 8px; display: flex; align-items: center; justify-content: center; }
        .cat-title { font-size: 16px; font-weight: 700; }
        .cat-sum { font-size: 12px; color: #888; font-weight: 500; margin-left: 5px; }
        .btn-delete-cat { font-size: 12px; color: #ddd; cursor: pointer; padding: 5px; display: none; }

        .item-list { list-style: none; padding: 0; margin: 0; min-height: 10px; }
        .item { padding: 15px 20px; border-bottom: 1px solid #f9f9f9; background: white; }
        .item.sortable-ghost { opacity: 0.4; background: #eee; }
        .item-top { display: flex; align-items: flex-start; }
        .drag-handle { display: none; color: #ccc; font-size: 20px; margin-right: 15px; cursor: grab; padding-top: 2px; }

        .chk-wrap { width: 22px; height: 22px; margin-right: 12px; position: relative; flex-shrink: 0; margin-top: 2px;}
        .chk-wrap input { position: absolute; width: 100%; height: 100%; opacity: 0; cursor: pointer; z-index: 2;}
        .chk-box { width: 100%; height: 100%; border: 2px solid #ddd; border-radius: 6px; display: flex; align-items: center; justify-content: center; transition: 0.2s; }
        .chk-wrap input:checked + .chk-box { background: var(--main-color); border-color: var(--main-color); }
        .chk-box::after { content: 'âœ”'; color: white; font-size: 12px; display: none; }
        .chk-wrap input:checked + .chk-box::after { display: block; }

        .item-icon { font-size: 20px; margin-right: 12px; width: 25px; text-align: center; flex-shrink: 0;}
        .item-content { flex: 1; }
        .item-name { font-size: 15px; font-weight: 600; color: #333; margin-bottom: 6px; display: block;}
        
        .tag-row { display: flex; flex-wrap: wrap; gap: 6px; align-items: center; }
        .tag { padding: 3px 6px; border-radius: 4px; font-size: 11px; color: #666; background: #f0f0f0; }
        .tag.brand { background: #FFF3E0; color: #E65100; font-weight: 600; }
        .tag.model { background: #ECEFF1; color: #455A64; font-weight: 600; }
        .tag.price { background: #fff0f0; color: var(--price-color); font-weight: 600; }
        .tag.count { background: #e8f5e9; color: #2e7d32; }
        
        .link-btn { text-decoration: none; background: #E3F2FD; color: #1565C0; padding: 3px 6px; border-radius: 4px; font-size: 11px; font-weight: bold; }
        .naver-btn { text-decoration: none; background: #03C75A; color: white; padding: 3px 6px; border-radius: 4px; font-size: 11px; font-weight: bold; display: inline-flex; align-items: center; gap: 2px; }
        .item-memo { margin-top: 8px; padding: 8px 10px; background: #FAFAFA; border-radius: 6px; font-size: 12px; color: #777; line-height: 1.4; display: block; border-left: 2px solid #eee; }
        .item-actions { display: none; gap: 8px; margin-left: 10px; align-self: flex-start; }
        .btn-icon { color: #ddd; font-size: 16px; cursor: pointer; padding: 2px; }
        
        body.is-edit-mode .btn-delete-cat { display: block; }
        body.is-edit-mode .item-actions { display: flex; }
        body.is-edit-mode .drag-handle { display: block; }
        body.is-edit-mode .drag-handle-cat { display: block; }
        body.is-edit-mode .chk-wrap { display: none; }

        .item.completed .item-name { text-decoration: line-through; color: #ccc; }
        .item.completed .item-icon { opacity: 0.5; }
        .btn-add-item { width: 100%; padding: 12px; background: white; border: none; color: var(--main-color); font-weight: bold; cursor: pointer; border-top: 1px solid #f0f0f0; font-size: 13px; }
        .fab-btn { position: fixed; bottom: 30px; right: 25px; background: var(--main-color); color: white; width: 55px; height: 55px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 28px; box-shadow: 0 4px 15px rgba(255, 135, 141, 0.4); border: none; cursor: pointer; z-index: 99; }

        /* ì—‘ì…€ ê´€ë¦¬ ì˜ì—­ */
        .excel-zone {
            background: white; margin: 20px; padding: 20px; border-radius: 16px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.03); text-align: center;
        }
        .excel-btn {
            background: #27ae60; color: white; border: none; padding: 10px 15px;
            border-radius: 8px; font-weight: bold; cursor: pointer; margin: 5px;
            font-size: 14px; box-shadow: 0 4px 10px rgba(39, 174, 96, 0.3);
        }
        .excel-btn.upload { background: #2980b9; box-shadow: 0 4px 10px rgba(41, 128, 185, 0.3); }
        .file-input-hidden { display: none; }

        /* ëª¨ë‹¬ */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 200; align-items: center; justify-content: center; }
        .modal { background: white; width: 90%; max-width: 400px; padding: 25px; border-radius: 20px; max-height: 90vh; overflow-y: auto; }
        .input-group { margin-bottom: 12px; }
        .input-label { display: block; font-size: 12px; color: #888; margin-bottom: 5px; }
        .input-field { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 10px; font-size: 15px; outline: none; }
        .icon-grid { height: 160px; overflow-y: scroll; border: 1px solid #eee; border-radius: 10px; padding: 10px; display: grid; grid-template-columns: repeat(6, 1fr); gap: 5px; margin-bottom: 15px; }
        .icon-opt { font-size: 22px; text-align: center; padding: 8px; border-radius: 8px; cursor: pointer; }
        .icon-opt.selected { background: var(--sub-color); border: 1px solid var(--main-color); }
        .btn-row { display: flex; gap: 10px; margin-top: 20px; }
        .btn { flex: 1; padding: 14px; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; }
        .btn-cancel { background: #f5f5f5; color: #666; }
        .btn-confirm { background: var(--main-color); color: white; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-top-row">
                <h2>ğŸ‘¶ ìœ¡ì•„ ì¤€ë¹„ ë¦¬ìŠ¤íŠ¸</h2>
                <div class="edit-toggle-wrap">
                    <span>í¸ì§‘ ëª¨ë“œ</span>
                    <label class="switch">
                        <input type="checkbox" id="editModeSwitch" onchange="window.toggleEditMode(this.checked)">
                        <span class="slider"></span>
                    </label>
                </div>
            </div>
            <div style="text-align: right;"><div class="total-budget-badge">ì´ ì˜ˆì‚° <span id="grandTotal">0</span>ì›</div></div>
            <div class="progress-box">
                <div class="progress-circle" id="percentTxt">0%</div>
                <div class="progress-bar-bg"><div class="progress-bar" id="progressBar"></div></div>
                <div class="total-info"><div id="checkCount">0 / 0 ì™„ë£Œ</div></div>
            </div>
        </div>

        <div id="contentArea"></div>
        
        <div id="emptyGuide" style="text-align:center; padding:60px; color:#aaa; display:none; font-size:14px;">
            <p>ì•„ì§ ë“±ë¡ëœ í•­ëª©ì´ ì—†ì–´ìš”.</p>
        </div>

        <div class="excel-zone">
            <h3>ğŸ“Š ì—‘ì…€ ëŒ€ëŸ‰ ë“±ë¡</h3>
            <p style="font-size:12px; color:#666; margin-bottom:15px;">
                PCì—ì„œ ì—‘ì…€ë¡œ í¸í•˜ê²Œ ì‘ì„±í•´ì„œ ì˜¬ë¦¬ì„¸ìš”.<br>
                1. ì–‘ì‹ ë‹¤ìš´ë¡œë“œ â†’ 2. ì‘ì„± â†’ 3. ì—…ë¡œë“œ
            </p>
            <button class="excel-btn" onclick="downloadTemplate()">ğŸ“¥ ì–‘ì‹ ë‹¤ìš´ë¡œë“œ</button>
            <button class="excel-btn upload" onclick="document.getElementById('excelInput').click()">ğŸ“¤ ì‘ì„±í•œ ì—‘ì…€ ì—…ë¡œë“œ</button>
            <input type="file" id="excelInput" class="file-input-hidden" accept=".xlsx, .xls" onchange="handleExcelUpload(this)">
        </div>
    </div>

    <button class="fab-btn" onclick="openCatModal()">+</button>

    <div id="catModal" class="modal-overlay">
        <div class="modal">
            <h3>ğŸ“‚ ì¹´í…Œê³ ë¦¬ ì¶”ê°€</h3>
            <div class="input-label">ì•„ì´ì½˜ ì„ íƒ</div>
            <div class="icon-grid" id="catIconGrid"></div>
            <div class="input-group"><input type="text" id="catName" class="input-field" placeholder="ì´ë¦„ (ì˜ˆ: ëª©ìš•/ìœ„ìƒ)"></div>
            <div class="btn-row">
                <button class="btn btn-cancel" onclick="closeModal('catModal')">ì·¨ì†Œ</button>
                <button class="btn btn-confirm" onclick="saveCategory()">ì¶”ê°€í•˜ê¸°</button>
            </div>
        </div>
    </div>

    <div id="itemModal" class="modal-overlay">
        <div class="modal">
            <h3 id="itemModalTitle">âœ¨ ë¬¼í’ˆ ë“±ë¡</h3>
            <input type="hidden" id="targetCatId"><input type="hidden" id="targetItemId">
            <div class="input-label">ì•„ì´ì½˜ ì„ íƒ</div>
            <div class="icon-grid" id="itemIconGrid"></div>
            <div class="input-group"><input type="text" id="itemName" class="input-field" placeholder="ë¬¼í’ˆëª… (ì˜ˆ: ì²´ì˜¨ê³„)"></div>
            <div style="display:flex; gap:10px; margin-bottom:12px;">
                <div style="flex:1"><label class="input-label">ë¸Œëœë“œ</label><input type="text" id="itemBrand" class="input-field" placeholder="ì˜ˆ: ë¸Œë¼ìš´"></div>
                <div style="flex:1"><label class="input-label">ëª¨ë¸ëª…</label><input type="text" id="itemModel" class="input-field" placeholder="ì˜ˆ: IRT-6520"></div>
            </div>
            <div style="display:flex; gap:10px; margin-bottom:12px;">
                <div style="width: 80px;"><label class="input-label">ìˆ˜ëŸ‰</label><input type="number" id="itemCount" class="input-field" placeholder="1" value="1"></div>
                <div style="flex:1"><label class="input-label">ì˜ˆìƒ ê°€ê²©</label><input type="text" id="itemPrice" class="input-field" placeholder="ìˆ«ìë§Œ ì…ë ¥"></div>
            </div>
            <div class="input-group"><input type="url" id="itemLink" class="input-field" placeholder="êµ¬ë§¤ ë§í¬ (URL)"></div>
            <div class="input-group"><label class="input-label">ìƒì„¸ ë©”ëª¨</label><textarea id="itemMemo" class="input-field" placeholder="ë©”ëª¨ ì…ë ¥..."></textarea></div>
            
            <div style="background:#f9f9f9; padding:10px; border-radius:10px; margin-bottom:15px; display:flex; align-items:center;">
                <input type="checkbox" id="itemShowNaver" style="width:20px; height:20px; margin-right:10px; cursor:pointer;" checked>
                <label for="itemShowNaver" style="font-size:14px; cursor:pointer;">ë„¤ì´ë²„ ìµœì €ê°€ ê²€ìƒ‰ ë²„íŠ¼ í‘œì‹œ</label>
            </div>

            <div style="text-align:center; margin-top:10px;">
                <button class="naver-btn" style="padding:10px; font-size:13px; width:100%; justify-content:center;" onclick="window.searchNaver()">ğŸ” ì§€ê¸ˆ ê²€ìƒ‰í•´ë³´ê¸°</button>
            </div>
            <div class="btn-row">
                <button class="btn btn-cancel" onclick="closeModal('itemModal')">ì·¨ì†Œ</button>
                <button class="btn btn-confirm" onclick="saveItem()">ì €ì¥í•˜ê¸°</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getDatabase, ref, onValue, push, update, remove } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

        // ğŸ”´ğŸ”´ ë³¸ì¸ í‚¤ê°’ êµì²´ ğŸ”´ğŸ”´
        const firebaseConfig = {
            apiKey: "AIzaSyCovHk7sYoMTkZ8H5RwKjUWMXAqi50l2L-k",
            authDomain: "checklist-3c59d.firebaseapp.com",
            databaseURL: "https://checklist-3c59d-default-rtdb.firebaseio.com",
            projectId: "checklist-3c59d",
            storageBucket: "checklist-3c59d.firebasestorage.app",
            messagingSenderId: "624967682899",
            appId: "1:624967682899:web:a6640fa7b63ee2eab9afa6"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const dbRef = ref(db, 'baby_checklist_v6'); 

        const babyIcons = ['ğŸ‘¶','ğŸ‘§','ğŸ§’','ğŸ‘¦','ğŸ¤°','ğŸ¤±','ğŸ‘¼','ğŸ¥','ğŸš‘','ğŸ©º','ğŸ’Š','ğŸ’‰','ğŸ©¹','ğŸŒ¡ï¸','ğŸ˜·','ğŸ¼','ğŸ¥£','ğŸ¥„','ğŸ¥¡','ğŸª','ğŸ¥›','ğŸ§Š','ğŸ¥¢','ğŸ½ï¸','ğŸ§‚','ğŸ','ğŸŒ','ğŸ¥¦','ğŸ¥•','ğŸŒ½','ğŸ¥©','ğŸ—','ğŸ','ğŸ¥¨','ğŸ©','ğŸ¦','ğŸ°','ğŸ«','ğŸ¬','ğŸ­','ğŸ§ƒ','â˜•','ğŸ›','ğŸš¿','ğŸ§¼','ğŸ§½','ğŸ§»','ğŸ§´','ğŸª¥','ğŸš½','ğŸ’©','ğŸ§¹','ğŸ—‘ï¸','ğŸ§º','ğŸ‘•','ğŸ‘–','ğŸ§¦','ğŸ§¢','ğŸ§¤','ğŸ§£','ğŸ‘Ÿ','ğŸ€','ğŸ‘—','ğŸ§¥','ğŸ‘™','ğŸ‘š','ğŸ‘”','ğŸ©³','ğŸ‘“','ğŸ•¶ï¸','ğŸ’','ğŸ’','ğŸ‘œ','ğŸ‘›','ğŸ›ï¸','ğŸ›Œ','ğŸ§¸','ğŸª','âš½','ğŸ¨','ğŸ“š','ğŸ ','ğŸ¡','ğŸˆ','ğŸ‰','ğŸ®','ğŸ²','ğŸ§©','ğŸ¹','ğŸ¥','ğŸ·','ğŸº','ğŸ¸','ğŸ»','ğŸš—','ğŸš•','ğŸšŒ','âœˆï¸','ğŸš²','ğŸ›µ','ğŸ›´','ğŸš¤','ğŸš€','ğŸ›’','ğŸ›ï¸','ğŸ“·','ğŸ“¹','ğŸ“±','ğŸ’»','ğŸ”‹','ğŸ”Œ','ğŸ ','ğŸ›‹ï¸','ğŸª‘','ğŸšª','ğŸ”‘','ğŸ›Œ','ğŸ–¼ï¸','ğŸª´','ğŸŒµ','ğŸ’','ğŸ•°ï¸','ğŸ’¡','ğŸ•¯ï¸','ğŸ“¦','âœ‰ï¸','âœ‚ï¸','ğŸ“Œ','ğŸ“','ğŸ“','â˜€ï¸','â˜ï¸','â˜”','â„ï¸','âš¡','ğŸŒˆ','â­','ğŸŒ™','ğŸ”¥','ğŸ’§','â¤ï¸','ğŸ§¡','ğŸ’›','ğŸ’š','ğŸ’™','ğŸ’œ','ğŸ–¤','ğŸ¤','ğŸ¤','ğŸ’”','ğŸ’¯','âœ…','âŒ','â“','â—ï¸','ğŸ’°','ğŸ’³','ğŸ“…','ğŸ“','ğŸ','ğŸ””','ğŸµ','ğŸ¶'];
        
        let selectedIcon = 'ğŸ‘¶';
        let currentData = {};
        let catSortable = null;

        onValue(dbRef, (snapshot) => {
            currentData = snapshot.val() || {};
            renderApp(currentData);
        });

        function renderApp(data) {
            const contentArea = document.getElementById('contentArea');
            if(document.body.classList.contains('is-dragging')) return;
            contentArea.innerHTML = '';
            
            let totalCount = 0; let checkedCount = 0; let grandTotalPrice = 0;
            const isEmpty = Object.keys(data).length === 0;
            document.getElementById('emptyGuide').style.display = isEmpty ? 'block' : 'none';

            let catArray = Object.keys(data).map(key => ({...data[key], id: key}));
            catArray.sort((a, b) => (a.order || 0) - (b.order || 0));

            catArray.forEach(cat => {
                const itemsObj = cat.items || {};
                let itemsArray = Object.keys(itemsObj).map(key => ({...itemsObj[key], id: key}));
                itemsArray.sort((a, b) => (a.order || 0) - (b.order || 0));

                let catTotalPrice = 0;
                let itemListHTML = '';

                itemsArray.forEach(item => {
                    totalCount++;
                    if(item.checked) checkedCount++;
                    const price = parseInt((item.price || '0').toString().replace(/,/g, '')) || 0;
                    const count = parseInt(item.count) || 1;
                    catTotalPrice += (price * count);

                    let tags = '';
                    if(item.brand) tags += `<span class="tag brand">${item.brand}</span> `;
                    if(item.model) tags += `<span class="tag model">${item.model}</span> `;
                    if(item.price) tags += `<span class="tag price">${Number(price).toLocaleString()}ì›</span> `;
                    if(item.link) tags += `<a href="${item.link}" target="_blank" class="link-btn">ğŸ”— êµ¬ë§¤</a>`;

                    // ë„¤ì´ë²„ ë²„íŠ¼ í‘œì‹œ ì—¬ë¶€
                    const showNaver = (item.showNaver !== false); 
                    if(showNaver) {
                        let queryParts = [item.brand, item.model, item.name].filter(Boolean);
                        const searchUrl = `https://search.shopping.naver.com/search/all?query=${encodeURIComponent(queryParts.join(' '))}`;
                        tags += `<a href="${searchUrl}" target="_blank" class="naver-btn">N ìµœì €ê°€</a>`;
                    }

                    let memoHTML = item.memo ? `<div class="item-memo">${item.memo.replace(/\n/g, '<br>')}</div>` : '';

                    itemListHTML += `
                    <li class="item ${item.checked ? 'completed' : ''}" data-id="${item.id}">
                        <div class="item-top">
                            <div class="drag-handle">â˜°</div>
                            <div class="chk-wrap">
                                <input type="checkbox" ${item.checked ? 'checked' : ''} onchange="window.toggleCheck('${cat.id}', '${item.id}', this.checked)">
                                <div class="chk-box"></div>
                            </div>
                            <div class="item-icon">${item.icon || 'ğŸ‘¶'}</div>
                            <div class="item-content">
                                <span class="item-name">${item.name}</span>
                                <div class="tag-row">${tags}</div>
                                ${memoHTML}
                            </div>
                            <div class="item-actions">
                                <span class="btn-icon btn-edit" onclick="window.openEditItem('${cat.id}', '${item.id}')">âœï¸</span>
                                <span class="btn-icon btn-del" onclick="window.deleteItem('${cat.id}', '${item.id}')">ğŸ—‘ï¸</span>
                            </div>
                        </div>
                    </li>`;
                });

                grandTotalPrice += catTotalPrice;
                const catDiv = document.createElement('div');
                catDiv.className = 'category-card';
                catDiv.setAttribute('data-id', cat.id);
                catDiv.innerHTML = `
                    <div class="cat-header">
                        <div class="cat-left">
                            <div class="drag-handle-cat">â˜°</div>
                            <div class="cat-icon">${cat.icon}</div>
                            <div>
                                <span class="cat-title">${cat.name}</span>
                                <span class="cat-sum">(${catTotalPrice.toLocaleString()}ì›)</span>
                            </div>
                        </div>
                        <div class="btn-delete-cat" onclick="window.deleteCategory('${cat.id}')">âŒ ì‚­ì œ</div>
                    </div>
                    <ul class="item-list" id="list-${cat.id}" data-cat-id="${cat.id}">${itemListHTML}</ul>
                    <button class="btn-add-item" onclick="window.openAddItem('${cat.id}')">+ ë¬¼í’ˆ ì¶”ê°€í•˜ê¸°</button>
                `;
                contentArea.appendChild(catDiv);
                initItemSortable(catDiv.querySelector(`#list-${cat.id}`), cat.id);
            });

            if(!catSortable) initCategorySortable();
            const percent = totalCount === 0 ? 0 : Math.round((checkedCount / totalCount) * 100);
            document.getElementById('progressBar').style.width = `${percent}%`;
            document.getElementById('percentTxt').innerText = `${percent}%`;
            document.getElementById('checkCount').innerText = `${checkedCount} / ${totalCount} ì™„ë£Œ`;
            document.getElementById('grandTotal').innerText = grandTotalPrice.toLocaleString();
            
            window.toggleEditMode(document.getElementById('editModeSwitch').checked);
        }

        // ==========================================
        // ğŸš€ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ & ì—…ë¡œë“œ ë¡œì§
        // ==========================================
        
        // 1. ì—‘ì…€ ì–‘ì‹ ë‹¤ìš´ë¡œë“œ
        window.downloadTemplate = () => {
            // í—¤ë” ì •ì˜
            const header = ["ì¹´í…Œê³ ë¦¬", "ë¬¼í’ˆëª…", "ë¸Œëœë“œ", "ëª¨ë¸ëª…", "ìˆ˜ëŸ‰", "ì˜ˆìƒê°€ê²©", "êµ¬ë§¤ë§í¬", "ë©”ëª¨"];
            // ì˜ˆì‹œ ë°ì´í„°
            const example = ["ìœ„ìƒ/ì¼€ì–´", "ì•„ê¸° ë©´ë´‰", "ë§ˆì´ë¹„", "", 1, 5000, "http://...", "ì‹ ìƒì•„ìš© ì–‡ì€ê±°"];
            
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet([header, example]);
            XLSX.utils.book_append_sheet(wb, ws, "ìœ¡ì•„í…œ_ì–‘ì‹");
            XLSX.writeFile(wb, "ìœ¡ì•„ì¤€ë¹„ë¬¼_ì–‘ì‹.xlsx");
        };

        // 2. ì—‘ì…€ íŒŒì¼ ì½ì–´ì„œ DB ë“±ë¡
        window.handleExcelUpload = (input) => {
            const file = input.files[0];
            if(!file) return;

            const reader = new FileReader();
            reader.onload = async (e) => {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const rows = XLSX.utils.sheet_to_json(firstSheet, { header: 1 }); // ë°°ì—´ì˜ ë°°ì—´ë¡œ ì½ê¸°

                // í—¤ë” ì œì™¸í•˜ê³  ë°ì´í„°ë§Œ ì¶”ì¶œ
                if(rows.length < 2) { alert("ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤."); return; }
                const dataRows = rows.slice(1); // ì²«ì¤„(í—¤ë”) ë¹¼ê³ 

                // ì¹´í…Œê³ ë¦¬ë³„ë¡œ ê·¸ë£¹í™”
                const grouped = {};
                
                dataRows.forEach(row => {
                    // row[0]:ì¹´í…Œê³ ë¦¬, row[1]:ë¬¼í’ˆëª… ...
                    const catName = row[0];
                    const itemName = row[1];
                    if(!catName || !itemName) return; // í•„ìˆ˜ê°’ ì—†ìœ¼ë©´ íŒ¨ìŠ¤

                    if(!grouped[catName]) grouped[catName] = [];
                    grouped[catName].push({
                        name: itemName,
                        brand: row[2] || "",
                        model: row[3] || "",
                        count: row[4] || 1,
                        price: row[5] || "",
                        link: row[6] || "",
                        memo: row[7] || "",
                        showNaver: true // ê¸°ë³¸ê°’
                    });
                });

                // Firebaseì— ë“±ë¡
                if(confirm(`${Object.keys(grouped).length}ê°œ ì¹´í…Œê³ ë¦¬ì˜ ë¬¼í’ˆì„ ë“±ë¡í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                    for(const catName of Object.keys(grouped)) {
                        // ì¹´í…Œê³ ë¦¬ ìƒì„±
                        const newCatRef = await push(ref(db, 'baby_checklist_v6'), {
                            name: catName,
                            icon: "ğŸ‘¶", // ê¸°ë³¸ ì•„ì´ì½˜
                            order: 999
                        });
                        const catId = newCatRef.key;

                        // ì•„ì´í…œë“¤ ìƒì„±
                        for(const item of grouped[catName]) {
                            await push(ref(db, `baby_checklist_v6/${catId}/items`), {
                                ...item,
                                checked: false,
                                order: 999
                            });
                        }
                    }
                    alert("âœ… ì—‘ì…€ ì—…ë¡œë“œ ì™„ë£Œ!");
                    input.value = ""; // ì´ˆê¸°í™”
                }
            };
            reader.readAsArrayBuffer(file);
        };

        // ... ê¸°ì¡´ í•¨ìˆ˜ë“¤ ...
        function initCategorySortable() {
            const el = document.getElementById('contentArea');
            catSortable = new Sortable(el, {
                handle: '.drag-handle-cat', animation: 150, ghostClass: 'sortable-ghost',
                disabled: !document.getElementById('editModeSwitch').checked,
                onStart: () => { document.body.classList.add('is-dragging'); },
                onEnd: () => {
                    document.body.classList.remove('is-dragging');
                    updateCategoryOrder(Array.from(el.children).map(div => div.getAttribute('data-id')));
                }
            });
        }
        function updateCategoryOrder(newIds) {
            const updates = {}; newIds.forEach((catId, index) => { updates[`baby_checklist_v6/${catId}/order`] = index; }); update(ref(db), updates);
        }
        function initItemSortable(el, catId) {
            const sortable = new Sortable(el, {
                handle: '.drag-handle', animation: 150, ghostClass: 'sortable-ghost',
                disabled: !document.getElementById('editModeSwitch').checked,
                onStart: () => { document.body.classList.add('is-dragging'); },
                onEnd: () => {
                    document.body.classList.remove('is-dragging');
                    updateItemOrder(catId, Array.from(el.children).map(li => li.getAttribute('data-id')));
                }
            });
            el.sortableInstance = sortable;
        }
        function updateItemOrder(catId, newIds) {
            const updates = {}; newIds.forEach((itemId, index) => { updates[`baby_checklist_v6/${catId}/items/${itemId}/order`] = index; }); update(ref(db), updates);
        }

        window.searchNaver = () => {
            const name = document.getElementById('itemName').value;
            const brand = document.getElementById('itemBrand').value;
            const model = document.getElementById('itemModel').value;
            if(!name) return alert('ë¬¼í’ˆëª…ì„ ì…ë ¥í•´ì•¼ ê²€ìƒ‰í•  ìˆ˜ ìˆì–´ìš”!');
            let queryParts = [brand, model, name].filter(Boolean);
            window.open(`https://search.shopping.naver.com/search/all?query=${encodeURIComponent(queryParts.join(' '))}`, '_blank');
        };

        window.toggleEditMode = (isChecked) => {
            if(isChecked) {
                document.body.classList.add('is-edit-mode');
                if(catSortable) catSortable.option("disabled", false);
                document.querySelectorAll('.item-list').forEach(el => el.sortableInstance?.option("disabled", false));
            } else {
                document.body.classList.remove('is-edit-mode');
                if(catSortable) catSortable.option("disabled", true);
                document.querySelectorAll('.item-list').forEach(el => el.sortableInstance?.option("disabled", true));
            }
        };

        window.toggleCheck = (catId, itemId, checked) => update(ref(db, `baby_checklist_v6/${catId}/items/${itemId}`), { checked });
        
        window.openCatModal = () => { document.getElementById('catModal').style.display = 'flex'; document.getElementById('catName').value = ''; renderIcons('catIconGrid'); };
        window.saveCategory = () => {
            const name = document.getElementById('catName').value;
            if(!name) return alert('ì´ë¦„ ì…ë ¥!');
            push(ref(db, 'baby_checklist_v6'), { name, icon: selectedIcon, order: 999 });
            window.closeModal('catModal');
        };
        window.deleteCategory = (id) => { if(confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) remove(ref(db, `baby_checklist_v6/${id}`)); };

        window.openAddItem = (catId) => {
            document.getElementById('itemModal').style.display = 'flex';
            document.getElementById('itemModalTitle').innerText = 'âœ¨ ë¬¼í’ˆ ë“±ë¡';
            document.getElementById('targetCatId').value = catId;
            document.getElementById('targetItemId').value = '';
            document.getElementById('itemName').value = '';
            document.getElementById('itemBrand').value = '';
            document.getElementById('itemModel').value = '';
            document.getElementById('itemMemo').value = '';
            document.getElementById('itemCount').value = '1';
            document.getElementById('itemPrice').value = '';
            document.getElementById('itemLink').value = '';
            document.getElementById('itemShowNaver').checked = true;
            renderIcons('itemIconGrid');
        };

        window.openEditItem = (catId, itemId) => {
            const item = currentData[catId].items[itemId];
            if(!item) return;
            document.getElementById('itemModal').style.display = 'flex';
            document.getElementById('itemModalTitle').innerText = 'âœï¸ ë¬¼í’ˆ ìˆ˜ì •';
            document.getElementById('targetCatId').value = catId;
            document.getElementById('targetItemId').value = itemId;
            document.getElementById('itemName').value = item.name;
            document.getElementById('itemBrand').value = item.brand || '';
            document.getElementById('itemModel').value = item.model || '';
            document.getElementById('itemMemo').value = item.memo || '';
            document.getElementById('itemCount').value = item.count || 1;
            document.getElementById('itemPrice').value = item.price || '';
            document.getElementById('itemLink').value = item.link || '';
            document.getElementById('itemShowNaver').checked = (item.showNaver !== false);
            selectedIcon = item.icon || 'ğŸ‘¶';
            renderIcons('itemIconGrid');
        };

        window.saveItem = () => {
            const catId = document.getElementById('targetCatId').value;
            const itemId = document.getElementById('targetItemId').value;
            const newData = {
                name: document.getElementById('itemName').value,
                brand: document.getElementById('itemBrand').value,
                model: document.getElementById('itemModel').value,
                memo: document.getElementById('itemMemo').value,
                count: document.getElementById('itemCount').value,
                price: document.getElementById('itemPrice').value,
                link: document.getElementById('itemLink').value,
                icon: selectedIcon,
                checked: false,
                order: 999,
                showNaver: document.getElementById('itemShowNaver').checked
            };
            if(!newData.name) return alert('ì´ë¦„ ì…ë ¥!');
            if(itemId) {
                const existing = currentData[catId].items[itemId];
                newData.checked = existing.checked;
                newData.order = existing.order || 999;
                update(ref(db, `baby_checklist_v6/${catId}/items/${itemId}`), newData);
            } else {
                push(ref(db, `baby_checklist_v6/${catId}/items`), newData);
            }
            window.closeModal('itemModal');
        };

        window.deleteItem = (catId, itemId) => { if(confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) remove(ref(db, `baby_checklist_v6/${catId}/items/${itemId}`)); };
        window.closeModal = (id) => document.getElementById(id).style.display = 'none';

        function renderIcons(targetGridId) {
            const grid = document.getElementById(targetGridId);
            grid.innerHTML = '';
            babyIcons.forEach(icon => {
                const el = document.createElement('div');
                el.className = `icon-opt ${icon === selectedIcon ? 'selected' : ''}`;
                el.innerText = icon;
                el.onclick = () => { selectedIcon = icon; renderIcons(targetGridId); };
                grid.appendChild(el);
            });
        }
    </script>
</body>
</html>
