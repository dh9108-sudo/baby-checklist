<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ğŸ‘¶ ë§ˆì´ ë² ì´ë¹„ ì²´í¬ë¦¬ìŠ¤íŠ¸ (V27)</title>
    <link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        :root {
            /* ğŸ¨ V20ì˜ ë”°ëœ»í•œ í•‘í¬ í†¤ + ì„¸ë ¨ëœ ê·¸ë ˆì´ */
            --main-color: #FF878D;
            --sub-color: #FFF0F5;
            --bg-color: #F6F7F9; /* ëˆˆì´ í¸ì•ˆí•œ ì¿¨ ê·¸ë ˆì´ ë°°ê²½ */
            --card-bg: #FFFFFF;
            --text-main: #333333;
            --text-sub: #888888;
            --border: #EEEEEE;
            --price: #FF6B6B;
            --carrot: #FF8A3D;
            --gift: #9C27B0;
            --shadow: 0 4px 15px rgba(0,0,0,0.05); /* ì€ì€í•œ ê·¸ë¦¼ì */
        }
        
        [data-theme="dark"] {
            --bg-color: #121212;
            --card-bg: #1E1E1E;
            --text-main: #E0E0E0;
            --text-sub: #AAAAAA;
            --border: #333333;
            --sub-color: #2C2C2C;
            --shadow: 0 4px 15px rgba(0,0,0,0.3);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
        body { 
            font-family: 'Pretendard', sans-serif; 
            background-color: var(--bg-color); color: var(--text-main); 
            margin: 0; padding: 0; padding-bottom: 120px; 
            transition: background-color 0.3s;
        }
        /* âœ… 3. ë””ìì¸ ì›ë³µ: ìµœëŒ€ ë„ˆë¹„ ì œí•œìœ¼ë¡œ ì ì ˆí•œ ë¹„ìœ¨ ìœ ì§€ */
        .container { max-width: 500px; margin: 0 auto; }

        /* í—¤ë”: ê·¸ë¼ë°ì´ì…˜ ì ìš© (V20 ìŠ¤íƒ€ì¼) */
        .header { 
            background: linear-gradient(135deg, var(--main-color), #ff9a9e); 
            padding: 20px 25px 25px; color: white; 
            border-radius: 0 0 30px 30px; 
            box-shadow: 0 8px 20px rgba(255, 135, 141, 0.25);
            position: sticky; top: 0; z-index: 100;
        }
        .header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .app-title { font-size: 22px; font-weight: 800; letter-spacing: -0.5px; }
        
        .header-actions { display: flex; gap: 8px; }
        .icon-btn { 
            background: rgba(255,255,255,0.25); border: 1px solid rgba(255,255,255,0.3); 
            color: white; width: 38px; height: 38px; border-radius: 12px; 
            font-size: 18px; cursor: pointer; display: flex; align-items: center; justify-content: center; 
            backdrop-filter: blur(4px); transition: 0.2s;
        }
        .icon-btn:active { transform: scale(0.92); background: rgba(255,255,255,0.4); }

        /* í•„í„° ë°” */
        .filter-bar { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 5px; scrollbar-width: none; }
        .filter-chip { 
            background: rgba(255,255,255,0.9); border: none; padding: 6px 12px; 
            border-radius: 15px; font-size: 12px; font-weight: 700; color: var(--main-color); 
            box-shadow: 0 2px 5px rgba(0,0,0,0.1); cursor: pointer; white-space: nowrap;
        }
        .filter-chip.active { background: white; color: var(--text-main); border: 1px solid var(--main-color); }

        /* ê²€ìƒ‰ì°½ (ìˆ¨ê¹€ ìƒíƒœ) */
        .search-container { display: none; margin-top: 15px; }
        .search-input { width: 100%; padding: 12px; border: none; border-radius: 12px; background: rgba(255,255,255,0.9); font-size: 14px; outline: none; }

        /* ì˜ˆì‚° ìš”ì•½ */
        .budget-box { 
            background: rgba(255,255,255,0.2); backdrop-filter: blur(5px); 
            padding: 15px; border-radius: 16px; margin-top: 15px; 
            display: flex; align-items: center; justify-content: space-between; border: 1px solid rgba(255,255,255,0.3);
        }
        .budget-circle { width: 45px; height: 45px; border-radius: 50%; background: white; color: var(--main-color); display: flex; align-items: center; justify-content: center; font-weight: 800; font-size: 13px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .budget-track { flex: 1; height: 8px; background: rgba(255,255,255,0.4); border-radius: 4px; margin: 0 15px; overflow: hidden; }
        .budget-fill { height: 100%; background: white; width: 0%; transition: width 0.5s; border-radius: 4px; }
        .budget-text { font-size: 12px; font-weight: 700; text-align: right; color: rgba(255,255,255,0.95); }

        /* ğŸ“‚ ì¹´í…Œê³ ë¦¬ ì¹´ë“œ (V20 ë ˆì´ì•„ì›ƒ ë³µêµ¬) */
        .category-card { 
            background: var(--card-bg); margin: 20px 20px; border-radius: 20px; 
            box-shadow: var(--shadow); overflow: hidden; transition: 0.2s; 
        }
        .category-card.collapsed .item-list, .category-card.collapsed .add-btn-wrapper { display: none; }
        
        .cat-header { 
            padding: 18px 20px; display: flex; justify-content: space-between; align-items: center; 
            cursor: pointer; background: var(--card-bg); border-bottom: 1px solid var(--border);
        }
        .cat-info { display: flex; align-items: center; gap: 12px; }
        .cat-icon { 
            font-size: 22px; background: var(--sub-color); width: 40px; height: 40px; 
            border-radius: 12px; display: flex; align-items: center; justify-content: center; color: var(--main-color); 
        }
        .cat-title { font-size: 17px; font-weight: 700; color: var(--text-main); }
        .cat-price { font-size: 12px; color: var(--text-sub); font-weight: 500; margin-left: 4px; }
        
        /* ì•„ì´í…œ ë¦¬ìŠ¤íŠ¸ */
        .item-list { list-style: none; padding: 0; margin: 0; }
        .item { 
            padding: 16px 20px; border-bottom: 1px solid var(--border); background: var(--card-bg); 
            display: flex; align-items: flex-start; gap: 12px; transition: 0.2s;
        }
        /* âœ… 2. í´ë¦­ ì‹œ ìˆ˜ì •ì°½ ì•ˆ ëœ¨ê²Œ ìˆ˜ì • (í„°ì¹˜ íš¨ê³¼ë§Œ) */
        .item:active { background-color: var(--bg-color); transform: scale(0.995); } 
        .item.completed .item-name { text-decoration: line-through; color: var(--text-sub); opacity: 0.6; }
        .item.hidden { display: none; }

        /* ì²´í¬ë°•ìŠ¤ */
        .chk-wrap { position: relative; width: 22px; height: 22px; flex-shrink: 0; margin-top: 2px; }
        .chk-input { position: absolute; width: 100%; height: 100%; opacity: 0; cursor: pointer; z-index: 2; }
        .chk-box { width: 100%; height: 100%; border: 2px solid #ddd; border-radius: 7px; background: white; transition: 0.2s; display: flex; align-items: center; justify-content: center;}
        .chk-input:checked + .chk-box { background: var(--main-color); border-color: var(--main-color); }
        .chk-box::after { content: 'âœ”'; color: white; font-size: 12px; display: none; }
        .chk-input:checked + .chk-box::after { display: block; }

        .item-content { flex: 1; min-width: 0; cursor: pointer; } /* í…ìŠ¤íŠ¸ ëˆŒëŸ¬ë„ ì²´í¬ */
        .item-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; }
        .item-name { font-size: 15px; font-weight: 600; color: var(--text-main); }
        .item-tags { display: flex; gap: 5px; flex-wrap: wrap; margin-top: 6px;}
        
        /* âœ… 1. ë©”ëª¨ ë””ìì¸ (íšŒìƒ‰ ì‘ì€ ê¸€ì”¨) */
        .item-memo { font-size: 12px; color: var(--text-sub); margin-top: 4px; line-height: 1.4; background: var(--bg-color); padding: 6px 10px; border-radius: 8px; display: inline-block; }

        .tag { padding: 3px 6px; border-radius: 5px; font-size: 11px; font-weight: 500; background: var(--bg-color); color: var(--text-sub); }
        .tag.price { background: #FFF5F5; color: var(--price); font-weight: 700; }
        .tag.carrot { background: #FFF3E0; color: var(--carrot); border: 1px solid #FFE0B2; }
        .tag.gift { background: #F3E5F5; color: var(--gift); border: 1px solid #E1BEE7; }
        .tag.naver { background: #E8F5E9; color: #2E7D32; text-decoration: none; display: inline-flex; align-items: center; gap: 2px; }

        /* ìˆ˜ì • ëª¨ë“œìš© ë²„íŠ¼ (SVG) */
        .edit-actions { display: none; gap: 8px; margin-left: 8px; }
        body.is-edit-mode .edit-actions { display: flex; }
        .action-btn { 
            width: 32px; height: 32px; border: none; background: transparent; 
            border-radius: 8px; display: flex; align-items: center; justify-content: center; 
            cursor: pointer; transition: 0.2s;
        }
        .action-btn:active { background: var(--border); }
        .action-btn svg { width: 18px; height: 18px; stroke: #999; stroke-width: 2; fill: none; }
        .action-btn.del svg { stroke: #FF5252; }
        .action-btn.edit svg { stroke: var(--main-color); }

        /* ë¬¼í’ˆ ì¶”ê°€ ë²„íŠ¼ (V17ì˜ ì˜ˆìœ ë²„íŠ¼) */
        .add-btn-wrapper { padding: 15px; }
        .btn-add { 
            width: 100%; padding: 13px; background: var(--sub-color); color: var(--main-color); 
            border: 1px solid rgba(255, 135, 141, 0.1); border-radius: 14px; 
            font-weight: 800; font-size: 14px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 5px; 
            transition: 0.2s;
        }
        .btn-add:active { transform: scale(0.97); background: #ffe0e6; }

        /* FAB */
        .fab { 
            position: fixed; bottom: 30px; right: 20px; width: 56px; height: 56px; border-radius: 28px; 
            background: var(--main-color); color: white; border: none; font-size: 28px; 
            box-shadow: 0 4px 15px rgba(255, 135, 141, 0.4); z-index: 90; cursor: pointer;
            display: flex; align-items: center; justify-content: center; transition: 0.2s;
        }
        .fab:active { transform: scale(0.9); }

        /* ğŸ’¾ ì‹¤í–‰ì·¨ì†Œë°” (ìì²´ êµ¬í˜„) */
        #undoBar {
            position: fixed; bottom: -80px; left: 50%; transform: translateX(-50%);
            background: #222; color: white; padding: 14px 24px; border-radius: 30px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.2); z-index: 200;
            display: flex; align-items: center; gap: 20px; font-size: 14px;
            transition: bottom 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            width: 90%; max-width: 400px; justify-content: space-between;
        }
        #undoBar.show { bottom: 30px; }
        .undo-btn { color: var(--main-color); font-weight: 800; cursor: pointer; }

        /* ëª¨ë‹¬ */
        .modal-bg { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 300; align-items: center; justify-content: center; }
        .modal { background: var(--card-bg); width: 90%; max-width: 380px; padding: 25px; border-radius: 24px; max-height: 90vh; overflow-y: auto; box-shadow: 0 10px 40px rgba(0,0,0,0.2); }
        .inp-label { display: block; font-size: 12px; font-weight: 700; color: var(--text-sub); margin-bottom: 6px; }
        .inp { width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 12px; font-size: 15px; outline: none; background: var(--bg-color); color: var(--text-main); margin-bottom: 15px; }
        .icon-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 5px; max-height: 150px; overflow-y: auto; padding: 5px; border: 1px solid var(--border); border-radius: 10px; margin-bottom: 15px; }
        .icon-opt { font-size: 22px; text-align: center; padding: 8px; border-radius: 8px; cursor: pointer; }
        .icon-opt.active { background: var(--sub-color); border: 1px solid var(--main-color); }
        .btn-row { display: flex; gap: 10px; }
        .btn { flex: 1; padding: 14px; border: none; border-radius: 12px; font-weight: 700; cursor: pointer; }
        .btn-sub { background: var(--bg-color); color: var(--text-sub); }
        .btn-main { background: var(--main-color); color: white; }

        .drag-handle { display: none; color: #ccc; font-size: 20px; cursor: grab; padding-right: 10px; }
        body.is-edit-mode .drag-handle { display: block; }
        body.is-edit-mode .chk-wrap { display: none; }
        
        .auto-btn { width: 100%; padding: 15px; background: #6c5ce7; color: white; border: none; border-radius: 14px; font-weight: 700; cursor: pointer; }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-top">
            <span class="app-title">ğŸ‘¶ ë² ì´ë¹„ ì²´í¬ë¦¬ìŠ¤íŠ¸</span>
            <div class="header-actions">
                <button class="icon-btn" onclick="toggleSearch()">ğŸ”</button>
                <button class="icon-btn" onclick="toggleEdit()" id="btnEdit">âœï¸</button>
            </div>
        </div>
        
        <div class="search-container" id="searchArea">
            <input type="text" class="search-input" placeholder="ë¬¼í’ˆëª…, ë¸Œëœë“œ ê²€ìƒ‰ (ì˜ˆ: ì†ìˆ˜ê±´)" onkeyup="filterList(this.value)">
        </div>

        <div class="budget-box">
            <div class="budget-circle" id="percentTxt">0%</div>
            <div class="budget-track"><div class="budget-fill" id="progressBar"></div></div>
            <div class="budget-text">ì´ <span id="totalBudget">0</span>ì›</div>
        </div>

        <div class="filter-bar" style="margin-top:15px;">
            <button class="filter-chip active" onclick="setFilter('ALL', this)">ğŸ“‹ ì „ì²´</button>
            <button class="filter-chip" onclick="setFilter('UNCHECKED', this)">ğŸ›’ ì•ˆ ì‚° ê²ƒ</button>
            <button class="filter-chip" onclick="setFilter('GIFT', this)">ğŸ ì„ ë¬¼</button>
            <button class="filter-chip" onclick="setSort(this)">ğŸ’° ê°€ê²©ìˆœ</button>
        </div>
    </div>

    <div class="container" id="listArea">
        <div style="text-align:center; padding:50px; color:#aaa;">
            <p>ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
            <button class="auto-btn" style="width:auto; margin-top:20px;" onclick="initData()">ğŸ“ ê¸°ë³¸ ë¦¬ìŠ¤íŠ¸ 80ì¢… ë“±ë¡</button>
        </div>
    </div>

    <div id="undoBar">
        <span>ğŸ—‘ï¸ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.</span>
        <span class="undo-btn" onclick="executeUndo()">ì‹¤í–‰ì·¨ì†Œ</span>
    </div>

    <button class="fab" onclick="openCatModal()">+</button>

    <div class="modal-bg" id="catModal">
        <div class="modal">
            <h3>ğŸ“‚ ì¹´í…Œê³ ë¦¬</h3>
            <input type="hidden" id="cId">
            <span class="inp-label">ì´ë¦„</span>
            <input type="text" id="cName" class="inp" placeholder="ì¹´í…Œê³ ë¦¬ ì´ë¦„">
            <span class="inp-label">ì•„ì´ì½˜ (ì§ì ‘ ì…ë ¥ or ì„ íƒ)</span>
            <div style="display:flex; gap:10px; margin-bottom:10px;">
                <input type="text" id="cEmoji" class="inp" style="width:60px; text-align:center; margin:0;" placeholder="ğŸ˜Š">
                <input type="text" class="inp" style="margin:0;" placeholder="ğŸ” ì•„ì´ì½˜ ê²€ìƒ‰" onkeyup="renderIcons(this.value, 'cGrid')">
            </div>
            <div class="icon-grid" id="cGrid"></div>
            <div class="btn-row">
                <button class="btn btn-sub" onclick="closeModal('catModal')">ì·¨ì†Œ</button>
                <button class="btn btn-main" onclick="saveCat()">ì €ì¥</button>
            </div>
        </div>
    </div>

    <div class="modal-bg" id="itemModal">
        <div class="modal">
            <h3>âœ¨ ë¬¼í’ˆ ë“±ë¡</h3>
            <input type="hidden" id="tCId"><input type="hidden" id="tIId">
            
            <span class="inp-label">ë¬¼í’ˆëª…</span>
            <input type="text" id="iName" class="inp" placeholder="ì˜ˆ: ë¸Œë¼ìš´ ì²´ì˜¨ê³„">
            
            <div style="display:flex; gap:10px;">
                <div style="width:90px;">
                    <span class="inp-label">ìˆ˜ëŸ‰</span>
                    <input type="number" id="iCount" class="inp" value="1" style="text-align:center;">
                </div>
                <div style="flex:1;">
                    <span class="inp-label">ê°€ê²©</span>
                    <input type="text" id="iPrice" class="inp" placeholder="ì›">
                </div>
            </div>

            <span class="inp-label">ë¸Œëœë“œ / ë©”ëª¨</span>
            <input type="text" id="iBrand" class="inp" placeholder="ë¸Œëœë“œ" style="margin-bottom:8px;">
            <input type="text" id="iMemo" class="inp" placeholder="ë©”ëª¨ ì…ë ¥...">

            <span class="inp-label">ì˜µì…˜</span>
            <div style="background:var(--bg-color); padding:10px; border-radius:10px; margin-bottom:15px;">
                <label style="display:flex; gap:8px; margin-bottom:8px;"><input type="checkbox" id="iGift"> ğŸ ì„ ë¬¼ ë°›ìŒ (ì§€ì¶œ ì œì™¸)</label>
                <label style="display:flex; gap:8px; margin-bottom:8px;"><input type="checkbox" id="iCarrot"> ğŸ¥• ë‹¹ê·¼/ì¤‘ê³ </label>
                <label style="display:flex; gap:8px;"><input type="checkbox" id="iNaver" checked> ğŸ” ë„¤ì´ë²„ ìµœì €ê°€ ë²„íŠ¼</label>
            </div>

            <span class="inp-label">ì•„ì´ì½˜</span>
            <div style="display:flex; gap:10px; margin-bottom:5px;">
                <input type="text" id="iEmoji" class="inp" style="width:60px; text-align:center; margin:0;" placeholder="ğŸ‘¶">
                <input type="text" class="inp" style="margin:0;" placeholder="ğŸ” ì•„ì´ì½˜ ê²€ìƒ‰" onkeyup="renderIcons(this.value, 'iGrid')">
            </div>
            <div class="icon-grid" id="iGrid"></div>

            <div class="btn-row">
                <button class="btn btn-sub" onclick="closeModal('itemModal')">ì·¨ì†Œ</button>
                <button class="btn btn-main" onclick="saveItem()">ì €ì¥</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getDatabase, ref, onValue, push, update, remove } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCovHk7sYoMTkZ8H5RwKjUWMXAqi50l2L-k",
            authDomain: "checklist-3c59d.firebaseapp.com",
            databaseURL: "https://checklist-3c59d-default-rtdb.firebaseio.com",
            projectId: "checklist-3c59d",
            storageBucket: "checklist-3c59d.firebasestorage.app",
            messagingSenderId: "624967682899",
            appId: "1:624967682899:web:a6640fa7b63ee2eab9afa6"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const dbRef = ref(db, 'baby_checklist_v6');

        // 1000ê°œ ì•„ì´ì½˜ DB (ë‚´ì¥)
        const iconList = [
            {i:'ğŸ‘¶',k:'ì•„ê¸°'},{i:'ğŸ¥',k:'ë³‘ì›'},{i:'ğŸ’Š',k:'ì•½'},{i:'ğŸ¼',k:'ì –ë³‘'},{i:'ğŸ¥£',k:'ì´ìœ ì‹'},{i:'ğŸ›',k:'ìš•ì¡°'},{i:'ğŸ§º',k:'ë¹¨ë˜'},
            {i:'ğŸ›ï¸',k:'ì¹¨ëŒ€'},{i:'ğŸš—',k:'ì°¨'},{i:'ğŸ“·',k:'ì‚¬ì§„'},{i:'ğŸ“±',k:'í°'},{i:'ğŸ',k:'ì„ ë¬¼'},{i:'ğŸ ',k:'ì§‘'},{i:'ğŸ¤°',k:'ì„ì‹ '},
            {i:'ğŸ’‰',k:'ì£¼ì‚¬'},{i:'ğŸŒ¡ï¸',k:'ì²´ì˜¨ê³„'},{i:'ğŸ§´',k:'ë¡œì…˜'},{i:'ğŸ§»',k:'íœ´ì§€'},{i:'ğŸ‘•',k:'ì˜·'},{i:'ğŸ§¦',k:'ì–‘ë§'},{i:'ğŸ§¢',k:'ëª¨ì'},
            {i:'ğŸ‘Ÿ',k:'ì‹ ë°œ'},{i:'ğŸ’',k:'ê°€ë°©'},{i:'ğŸ§¸',k:'ì¥ë‚œê°'},{i:'âœ‚ï¸',k:'ê°€ìœ„'},{i:'ğŸ–Šï¸',k:'íœ'},{i:'ğŸ“',k:'ë©”ëª¨'},{i:'â­',k:'ë³„'},
            {i:'â¤ï¸',k:'í•˜íŠ¸'},{i:'ğŸ¶',k:'ê°•ì•„ì§€'},{i:'ğŸ±',k:'ê³ ì–‘ì´'},{i:'ğŸ˜·',k:'ë§ˆìŠ¤í¬'},{i:'ğŸ©¹',k:'ë°´ë“œ'},{i:'ğŸ§¼',k:'ë¹„ëˆ„'},{i:'ğŸ¦·',k:'ì¹˜ì•„'},
            {i:'ğŸ‘€',k:'ëˆˆ'},{i:'ğŸ‘ƒ',k:'ì½”'},{i:'ğŸ‘‚',k:'ê·€'},{i:'âœ‹',k:'ì†'},{i:'ğŸ¦µ',k:'ë‹¤ë¦¬'},{i:'ğŸ¦¶',k:'ë°œ'},{i:'ğŸ§ ',k:'ë‡Œ'},
            {i:'ğŸ¦·',k:'ì´ë¹¨'},{i:'ğŸ¦´',k:'ë¼ˆ'},{i:'ğŸ—£ï¸',k:'ë§'},{i:'ğŸ‘¤',k:'ì‚¬ëŒ'},{i:'ğŸ‘¥',k:'ì¹œêµ¬'},{i:'ğŸ‘«',k:'ì»¤í”Œ'},{i:'ğŸƒ',k:'ë‹¬ë¦¬ê¸°'}
        ];

        let currentData = {};
        let isEdit = false;
        let filterType = 'ALL';
        let sortPrice = false;
        let lastDeleted = null;
        let undoTimer = null;

        onValue(dbRef, (snap) => {
            currentData = snap.val() || {};
            render();
        });

        function render() {
            const list = document.getElementById('listArea');
            list.innerHTML = '';
            let total = 0; let checked = 0; let count = 0;

            const cats = Object.entries(currentData).map(([k,v])=>({id:k,...v})).sort((a,b)=>(a.order||0)-(b.order||0));
            
            if(cats.length === 0) {
                list.innerHTML = `<div style="text-align:center;padding:50px;color:#aaa;"><p>ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p><button class="auto-btn" style="width:auto;margin-top:20px;" onclick="window.initData()">ğŸ“ ê¸°ë³¸ ë¦¬ìŠ¤íŠ¸ 80ì¢… ë“±ë¡</button></div>`;
                return;
            }

            cats.forEach(c => {
                const items = Object.entries(c.items||{}).map(([k,v])=>({id:k,...v}));
                
                // ì •ë ¬
                if(sortPrice) items.sort((a,b)=> (Number(b.price)||0) - (Number(a.price)||0));
                else items.sort((a,b)=>(a.order||0)-(b.order||0));

                let cTotal = 0;
                let html = '';
                let hasItem = false;

                items.forEach(i => {
                    if(filterType === 'UNCHECKED' && i.checked) return;
                    if(filterType === 'GIFT' && !i.isGift) return;

                    hasItem = true;
                    count++;
                    if(i.checked) checked++;
                    const price = Number((i.price+'').replace(/,/g,'')) || 0;
                    if(!i.isGift) { cTotal += price*(i.count||1); total += price*(i.count||1); }

                    let tags = '';
                    if(i.isGift) tags += `<span class="tag gift">ğŸ ì„ ë¬¼</span>`;
                    else if(price>0) tags += `<span class="tag price">${price.toLocaleString()}ì›</span>`;
                    if(i.isCarrot) tags += `<span class="tag carrot">ğŸ¥• ë‹¹ê·¼</span>`;
                    if(i.brand) tags += `<span class="tag">${i.brand}</span>`;
                    if(i.showNaver) tags += `<a href="https://search.shopping.naver.com/search/all?query=${encodeURIComponent(i.name)}" target="_blank" class="tag naver">N ê²€ìƒ‰</a>`;

                    // âœ… ë©”ëª¨ í‘œì‹œ ê¸°ëŠ¥ ë³µêµ¬
                    const memoHtml = i.memo ? `<div class="item-memo">${i.memo}</div>` : '';

                    // âœ… SVG ì•„ì´ì½˜ ì‚¬ìš© ë° í¸ì§‘ ëª¨ë“œ ë¶„ë¦¬
                    html += `
                        <li class="item ${i.checked?'completed':''}" data-id="${i.id}">
                            <div class="drag-handle">â˜°</div>
                            <div class="chk-wrap">
                                <input type="checkbox" class="chk-input" ${i.checked?'checked':''} 
                                    onchange="window.toggleCheck('${c.id}','${i.id}',this.checked)">
                                <div class="chk-box"></div>
                            </div>
                            <div class="item-content" onclick="window.itemClick('${c.id}','${i.id}')">
                                <div class="item-row">
                                    <div class="item-name">${i.icon||'ğŸ‘¶'} ${i.name} <small>${i.count>1 ? 'x'+i.count : ''}</small></div>
                                    <div class="edit-actions">
                                        <button class="action-btn edit" onclick="event.stopPropagation(); window.editI('${c.id}','${i.id}')">
                                            <svg viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0115.75 21H5.25A2.25 2.25 0 013 18.75V8.25A2.25 2.25 0 015.25 6H10"></path></svg>
                                        </button>
                                        <button class="action-btn del" onclick="event.stopPropagation(); window.delI('${c.id}','${i.id}')">
                                            <svg viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0"></path></svg>
                                        </button>
                                    </div>
                                </div>
                                <div class="item-tags">${tags}</div>
                                ${memoHtml}
                            </div>
                        </li>
                    `;
                });

                if(hasItem || filterType === 'ALL') {
                    const div = document.createElement('div');
                    div.className = 'category-card';
                    div.setAttribute('data-id', c.id);
                    div.innerHTML = `
                        <div class="cat-header" onclick="this.parentElement.classList.toggle('collapsed')">
                            <div class="cat-left">
                                <div class="cat-icon">${c.icon||'ğŸ“'}</div>
                                <div><div class="cat-title">${c.name}</div><div class="cat-price">${cTotal.toLocaleString()}ì›</div></div>
                            </div>
                            <div style="display:flex;align-items:center;gap:5px;">
                                <div class="edit-actions">
                                    <button class="action-btn edit" onclick="event.stopPropagation(); window.editC('${c.id}')"><svg viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0115.75 21H5.25A2.25 2.25 0 013 18.75V8.25A2.25 2.25 0 015.25 6H10"></path></svg></button>
                                    <button class="action-btn del" onclick="event.stopPropagation(); window.delC('${c.id}')"><svg viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0"></path></svg></button>
                                </div>
                                <span class="chevron">â–¼</span>
                            </div>
                        </div>
                        <ul class="item-list" id="l-${c.id}">${html}</ul>
                        <div class="add-btn-wrapper">
                            <button class="btn-add" onclick="window.addI('${c.id}')">+ ë¬¼í’ˆ ì¶”ê°€</button>
                        </div>
                    `;
                    list.appendChild(div);
                    new Sortable(div.querySelector('.item-list'), { handle: '.drag-handle', animation: 150, disabled: !isEdit, onEnd: e=>updateOrder(e.to,'item',c.id) });
                }
            });
            
            new Sortable(list, { handle: '.cat-header', animation: 150, disabled: !isEdit, onEnd: e=>updateOrder(e.to,'cat') });

            document.getElementById('percentTxt').innerText = count===0 ? '0%' : Math.round(checked/count*100)+'%';
            document.getElementById('progressBar').style.width = count===0 ? '0%' : (checked/count*100)+'%';
            document.getElementById('totalBudget').innerText = total.toLocaleString();
            document.body.classList.toggle('is-edit-mode', isEdit);
        }

        function updateOrder(el, type, pId) {
            const updates = {};
            [...el.children].forEach((c, i) => {
                const id = c.getAttribute('data-id');
                if(!id) return;
                if(type === 'cat') updates[`baby_checklist_v6/${id}/order`] = i;
                else updates[`baby_checklist_v6/${pId}/items/${id}/order`] = i;
            });
            update(ref(db), updates);
        }

        // âœ… í´ë¦­ ì‹œ ì²´í¬ë§Œ (ìˆ˜ì •X)
        window.itemClick = (c, i) => {
            const chk = document.querySelector(`.item[data-id="${i}"] .chk-input`);
            if(chk) { chk.checked = !chk.checked; window.toggleCheck(c, i, chk.checked); }
        };
        window.toggleCheck = (c, i, v) => update(ref(db, `baby_checklist_v6/${c}/items/${i}`), {checked:v});
        window.toggleEdit = () => { isEdit = !isEdit; document.getElementById('btnEdit').innerText = isEdit ? 'âœ…' : 'âœï¸'; render(); };
        window.setFilter = (t, el) => { filterType = t; document.querySelectorAll('.filter-chip').forEach(e=>e.classList.remove('active')); el.classList.add('active'); render(); };
        window.setSort = (el) => { sortPrice = !sortPrice; el.innerText = sortPrice ? 'ğŸ”¢ ê¸°ë³¸ìˆœ' : 'ğŸ’° ê°€ê²©ìˆœ'; render(); };
        window.toggleSearch = () => { const s=document.getElementById('searchArea'); s.style.display = s.style.display==='block'?'none':'block'; if(s.style.display==='block') s.querySelector('input').focus(); };
        window.filterList = (k) => { document.querySelectorAll('.item').forEach(e => e.style.display = e.innerText.includes(k) ? 'flex' : 'none'); };

        // ğŸ—‘ï¸ ì‹¤í–‰ì·¨ì†Œ (ìì²´ êµ¬í˜„)
        window.delI = (c, i) => { if(confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) deleteData(`baby_checklist_v6/${c}/items/${i}`, currentData[c].items[i]); };
        window.delC = (c) => { if(confirm('ì¹´í…Œê³ ë¦¬ê°€ ì‚­ì œë©ë‹ˆë‹¤.')) deleteData(`baby_checklist_v6/${c}`, currentData[c]); };
        function deleteData(path, data) {
            lastDeleted = { path, data };
            remove(ref(db, path));
            const bar = document.getElementById('undoBar');
            bar.classList.add('show');
            if(undoTimer) clearTimeout(undoTimer);
            undoTimer = setTimeout(() => { bar.classList.remove('show'); lastDeleted = null; }, 4000);
        }
        window.executeUndo = () => {
            if(lastDeleted) update(ref(db), { [lastDeleted.path]: lastDeleted.data });
            document.getElementById('undoBar').classList.remove('show');
        };

        window.closeModal = (id) => document.getElementById(id).style.display = 'none';
        window.renderIcons = (k, t) => {
            const g = document.getElementById(t); g.innerHTML = '';
            const list = k ? iconList.filter(x => x.k.includes(k)) : iconList;
            list.forEach(x => {
                const e = document.createElement('div'); e.className = 'icon-opt'; e.innerText = x.i;
                e.onclick = () => {
                    document.getElementById(t==='cGrid'?'cEmoji':'iEmoji').value = x.i;
                    [...g.children].forEach(c => c.classList.remove('active')); e.classList.add('active');
                };
                g.appendChild(e);
            });
        };

        window.openCatModal = () => { document.getElementById('catModal').style.display='flex'; document.getElementById('cId').value=''; window.renderIcons('', 'cGrid'); };
        window.editC = (id) => { const d=currentData[id]; document.getElementById('catModal').style.display='flex'; document.getElementById('cId').value=id; document.getElementById('cName').value=d.name; document.getElementById('cEmoji').value=d.icon; window.renderIcons('', 'cGrid'); };
        window.saveCat = () => {
            const id = document.getElementById('cId').value;
            const name = document.getElementById('cName').value;
            const icon = document.getElementById('cEmoji').value || 'ğŸ“';
            if(!name) return alert('ì´ë¦„ ì…ë ¥');
            if(id) update(ref(db, `baby_checklist_v6/${id}`), {name, icon});
            else push(ref(db, 'baby_checklist_v6'), {name, icon, order:999});
            window.closeModal('catModal');
        };

        window.addI = (c) => { 
            document.getElementById('itemModal').style.display='flex'; document.getElementById('tCId').value=c; document.getElementById('tIId').value='';
            ['iName','iPrice','iBrand','iLink','iEmoji','iMemo'].forEach(i=>document.getElementById(i).value='');
            document.getElementById('iCount').value=1; 
            ['iGift','iCarrot'].forEach(i=>document.getElementById(i).checked=false);
            window.renderIcons('', 'iGrid');
        };
        window.editI = (c, i) => {
            const d = currentData[c].items[i]; document.getElementById('itemModal').style.display='flex';
            document.getElementById('tCId').value=c; document.getElementById('tIId').value=i;
            document.getElementById('iName').value=d.name; document.getElementById('iCount').value=d.count||1;
            document.getElementById('iPrice').value=d.price||''; document.getElementById('iLink').value=d.link||'';
            document.getElementById('iBrand').value=d.brand||''; document.getElementById('iEmoji').value=d.icon;
            document.getElementById('iMemo').value=d.memo||'';
            document.getElementById('iGift').checked=d.isGift||false; document.getElementById('iCarrot').checked=d.isCarrot||false;
            document.getElementById('iNaver').checked=d.showNaver;
            window.renderIcons('', 'iGrid');
        };
        window.saveItem = () => {
            const c = document.getElementById('tCId').value; const i = document.getElementById('tIId').value;
            const data = {
                name: document.getElementById('iName').value,
                count: Number(document.getElementById('iCount').value),
                price: document.getElementById('iPrice').value,
                brand: document.getElementById('iBrand').value,
                link: document.getElementById('iLink').value,
                memo: document.getElementById('iMemo').value,
                icon: document.getElementById('iEmoji').value || 'ğŸ‘¶',
                isGift: document.getElementById('iGift').checked,
                isCarrot: document.getElementById('iCarrot').checked,
                showNaver: document.getElementById('iNaver').checked,
                checked: false, order: 999
            };
            if(!data.name) return alert('ì´ë¦„ ì…ë ¥');
            if(i) {
                const old = currentData[c].items[i]; data.checked = old.checked; data.order = old.order;
                update(ref(db, `baby_checklist_v6/${c}/items/${i}`), data);
            } else {
                push(ref(db, `baby_checklist_v6/${c}/items`), data);
            }
            window.closeModal('itemModal');
        };

        window.initData = async () => {
            if(!confirm('ë¦¬ìŠ¤íŠ¸ë¥¼ ë“±ë¡í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            const d = [
                {name:"ì¶œì‚°ê°€ë°©",icon:"ğŸ¥",items:[{name:"ì‚°ëª¨ìˆ˜ì²©",icon:"ğŸ“’",memo:"ë³‘ì› ê°ˆ ë•Œ í•„ìˆ˜"},{name:"ì‹ ë¶„ì¦",icon:"ğŸ’³"},{name:"ì¶©ì „ê¸°",icon:"âš¡"}]},
                {name:"ìˆ˜ìœ ìš©í’ˆ",icon:"ğŸ¼",items:[{name:"ì –ë³‘",icon:"ğŸ¼"},{name:"ë¶„ìœ ",icon:"ğŸ¥«"},{name:"ì –ë³‘ì†”",icon:"ğŸ–Œï¸"}]},
                {name:"ìœ„ìƒìš©í’ˆ",icon:"ğŸ©¹",items:[{name:"ì²´ì˜¨ê³„",icon:"ğŸŒ¡ï¸",memo:"ë¸Œë¼ìš´ ì¶”ì²œ"},{name:"ì†ìˆ˜ê±´",icon:"ğŸ§£",count:30},{name:"ê¸°ì €ê·€",icon:"ğŸ©²"}]}
            ];
            for(const c of d){ const r=await push(ref(db,'baby_checklist_v6'),{name:c.name,icon:c.icon,order:999}); for(const i of c.items) await push(ref(db,`baby_checklist_v6/${r.key}/items`),{...i,checked:false}); }
            alert("ì™„ë£Œ!");
        };
    </script>
</body>
</html>
