<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ğŸ‘¶ ë§ˆì´ ë² ì´ë¹„ ì²´í¬ë¦¬ìŠ¤íŠ¸ (Pro)</title>
    <link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        :root {
            /* ğŸ¨ í”„ë¦¬ë¯¸ì—„ ì»¬ëŸ¬ íŒ”ë ˆíŠ¸ */
            --primary: #FF8A92;       /* ë©”ì¸ ì½”ë„ í•‘í¬ */
            --primary-light: #FFEBEE; /* ì—°í•œ ë°°ê²½ìš© */
            --bg-color: #F2F4F6;      /* ê³ ê¸‰ìŠ¤ëŸ¬ìš´ íšŒìƒ‰ ë°°ê²½ */
            --card-bg: #FFFFFF;
            --text-main: #191F28;     /* ì§„í•œ ê²€ì • (ê°€ë…ì„±) */
            --text-sub: #8B95A1;      /* ì—°í•œ íšŒìƒ‰ */
            --line-color: #E5E8EB;
            
            --price-color: #FF4D4F;
            --link-color: #3182F6;
            --star-color: #FFC107;
            
            /* ê·¸ë¦¼ì (Shadow) */
            --shadow-sm: 0 2px 8px rgba(0,0,0,0.04);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.08);
            --shadow-float: 0 8px 20px rgba(255, 138, 146, 0.3);
        }

        /* ë‹¤í¬ ëª¨ë“œ (ìë™ ëŒ€ì‘) */
        [data-theme="dark"] {
            --bg-color: #101010;
            --card-bg: #1C1C1E;
            --text-main: #F5F5F5;
            --text-sub: #8E8E93;
            --line-color: #2C2C2E;
            --primary-light: #2C2C2E;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
        body { 
            font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, system-ui, Roboto, sans-serif;
            background-color: var(--bg-color); color: var(--text-main);
            margin: 0; padding: 0; padding-bottom: 120px;
            transition: background-color 0.3s ease;
        }
        
        .container { max-width: 600px; margin: 0 auto; }

        /* âœ¨ í—¤ë” ë””ìì¸ (ê¸€ë˜ìŠ¤ëª¨í”¼ì¦˜) */
        .header {
            position: sticky; top: 0; z-index: 100;
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            padding: 15px 20px;
            border-bottom: 1px solid var(--line-color);
        }
        [data-theme="dark"] .header { background: rgba(28, 28, 30, 0.85); }

        .header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .app-title { font-size: 22px; font-weight: 800; color: var(--text-main); letter-spacing: -0.5px; }
        
        .header-actions { display: flex; gap: 8px; }
        .icon-btn {
            width: 36px; height: 36px; border-radius: 12px;
            border: none; background: var(--bg-color); color: var(--text-main);
            font-size: 18px; cursor: pointer; display: flex; align-items: center; justify-content: center;
            transition: transform 0.1s;
        }
        .icon-btn:active { transform: scale(0.92); }

        /* ì§„í–‰ë¥  ë°” */
        .progress-area { margin-top: 5px; }
        .budget-info { display: flex; justify-content: space-between; font-size: 13px; font-weight: 600; color: var(--text-sub); margin-bottom: 6px; }
        .budget-val { color: var(--primary); font-weight: 800; }
        
        .progress-track { height: 8px; background: var(--line-color); border-radius: 4px; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--primary); width: 0%; transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1); }

        /* ğŸ” ê²€ìƒ‰ì°½ */
        .search-container {
            display: none; padding: 10px 20px; background: var(--bg-color);
            animation: slideDown 0.3s ease;
        }
        @keyframes slideDown { from{opacity:0; transform:translateY(-10px);} to{opacity:1; transform:translateY(0);} }
        .search-input {
            width: 100%; padding: 12px; border: none; border-radius: 12px;
            background: var(--card-bg); font-size: 15px; color: var(--text-main);
            box-shadow: var(--shadow-sm); outline: none;
        }

        /* ğŸ“‚ ì¹´í…Œê³ ë¦¬ ì¹´ë“œ */
        .category-card {
            background: var(--card-bg); margin: 15px 20px; border-radius: 20px;
            box-shadow: var(--shadow-sm); overflow: hidden;
            transition: transform 0.2s;
        }
        /* 4. í„°ì¹˜ ì• ë‹ˆë©”ì´ì…˜ íš¨ê³¼ */
        .category-card:active { transform: scale(0.995); } 

        .cat-header {
            padding: 18px; display: flex; align-items: center; justify-content: space-between;
            cursor: pointer; border-bottom: 1px solid transparent;
        }
        .cat-info { display: flex; align-items: center; gap: 12px; }
        .cat-icon {
            width: 40px; height: 40px; border-radius: 14px;
            background: var(--primary-light); color: var(--primary);
            font-size: 22px; display: flex; align-items: center; justify-content: center;
        }
        .cat-text h3 { margin: 0; font-size: 17px; font-weight: 700; color: var(--text-main); }
        .cat-text p { margin: 2px 0 0; font-size: 12px; color: var(--text-sub); font-weight: 500; }
        .chevron { color: var(--text-sub); transition: transform 0.3s; }
        
        /* ì ‘ê¸°/í¼ì¹˜ê¸° */
        .category-card.collapsed .item-list,
        .category-card.collapsed .btn-add-wrapper { display: none; }
        .category-card.collapsed .chevron { transform: rotate(-90deg); }
        .category-card:not(.collapsed) .cat-header { border-bottom: 1px solid var(--line-color); }

        /* ğŸ›’ ì•„ì´í…œ ë¦¬ìŠ¤íŠ¸ */
        .item-list { list-style: none; padding: 0; margin: 0; }
        .item {
            padding: 16px; background: var(--card-bg);
            border-bottom: 1px solid var(--line-color);
            display: flex; align-items: flex-start; gap: 12px;
            transition: background 0.1s;
        }
        /* 4. í„°ì¹˜ ì‹œ ëˆŒë¦¬ëŠ” íš¨ê³¼ (ë¦¬í”Œ íš¨ê³¼ ëŒ€ì²´) */
        .item:active { background-color: var(--bg-color); transform: scale(0.99); }
        .item.completed .item-name { text-decoration: line-through; color: var(--text-sub); opacity: 0.7; }
        .item.completed .item-content { opacity: 0.6; }
        .item.hidden { display: none; }

        /* ì²´í¬ë°•ìŠ¤ ì»¤ìŠ¤í…€ */
        .chk-label { position: relative; width: 24px; height: 24px; flex-shrink: 0; margin-top: 2px; }
        .chk-input { position: absolute; opacity: 0; width: 100%; height: 100%; cursor: pointer; z-index: 2; }
        .chk-box {
            width: 100%; height: 100%; border: 2px solid #D1D6DB; border-radius: 8px;
            transition: 0.2s; display: flex; align-items: center; justify-content: center;
        }
        .chk-input:checked + .chk-box { background: var(--primary); border-color: var(--primary); }
        .chk-box::after { content: 'âœ”'; color: white; font-size: 14px; font-weight: bold; display: none; }
        .chk-input:checked + .chk-box::after { display: block; }

        .item-content { flex: 1; min-width: 0; }
        .item-row-1 { display: flex; justify-content: space-between; margin-bottom: 6px; align-items: center; }
        .item-name { font-size: 16px; font-weight: 600; color: var(--text-main); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .item-star { font-size: 12px; color: var(--star-color); margin-left: 5px; }
        
        .tag-row { display: flex; flex-wrap: wrap; gap: 6px; }
        .tag { padding: 4px 8px; border-radius: 6px; font-size: 11px; font-weight: 600; background: var(--bg-color); color: var(--text-sub); }
        .tag.brand { color: #E65100; background: #FFF3E0; }
        .tag.price { color: var(--price-color); background: #FFF0F0; }
        .tag.gift { color: #7B1FA2; background: #F3E5F5; }
        .tag.carrot { color: #E64A19; background: #FFCCBC; }
        .tag-link { text-decoration: none; color: var(--link-color); background: #E3F2FD; }

        .btn-icon { font-size: 18px; color: var(--text-sub); cursor: pointer; padding: 4px; }

        /* ì•„ì´í…œ ì¶”ê°€ ë²„íŠ¼ Wrapper */
        .btn-add-wrapper { padding: 15px; }
        .btn-add-item {
            width: 100%; padding: 14px; border: none; border-radius: 14px;
            background: var(--primary-light); color: var(--primary);
            font-size: 15px; font-weight: 700; cursor: pointer;
            display: flex; align-items: center; justify-content: center; gap: 6px;
            transition: 0.2s;
        }
        .btn-add-item:active { transform: scale(0.98); opacity: 0.8; }

        /* FAB (í”Œë¡œíŒ… ë²„íŠ¼) */
        .fab {
            position: fixed; bottom: 30px; right: 25px;
            width: 56px; height: 56px; border-radius: 28px;
            background: var(--primary); color: white; border: none;
            font-size: 30px; box-shadow: var(--shadow-float);
            cursor: pointer; z-index: 90; display: flex; align-items: center; justify-content: center;
            transition: transform 0.2s;
        }
        .fab:active { transform: scale(0.9); }

        /* 1. ì‹¤í–‰ ì·¨ì†Œ ìŠ¤ë‚µë°” (Undo) */
        .undo-snackbar {
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
            background: #333; color: white; padding: 14px 24px; border-radius: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3); z-index: 200;
            display: flex; align-items: center; gap: 15px;
            font-size: 14px; opacity: 0; pointer-events: none; transition: 0.3s;
        }
        .undo-snackbar.show { opacity: 1; pointer-events: auto; bottom: 40px; }
        .undo-btn { color: var(--primary); font-weight: bold; cursor: pointer; text-transform: uppercase; }

        /* ëª¨ë‹¬ (íŒì—…) */
        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); backdrop-filter: blur(4px); z-index: 300;
            align-items: center; justify-content: center;
        }
        .modal-card {
            background: var(--card-bg); width: 90%; max-width: 380px;
            padding: 25px; border-radius: 24px; box-shadow: var(--shadow-float);
            max-height: 85vh; overflow-y: auto; animation: popUp 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        @keyframes popUp { from{transform: scale(0.9); opacity:0;} to{transform: scale(1); opacity:1;} }

        .modal-title { font-size: 18px; font-weight: 800; margin-bottom: 20px; text-align: center; }
        .input-box { margin-bottom: 15px; }
        .input-label { display: block; font-size: 13px; color: var(--text-sub); margin-bottom: 6px; font-weight: 600; }
        .input-text { 
            width: 100%; padding: 12px; border: 1px solid var(--line-color); 
            border-radius: 12px; font-size: 15px; outline: none; background: var(--bg-color); color: var(--text-main);
            transition: border-color 0.2s;
        }
        .input-text:focus { border-color: var(--primary); background: var(--card-bg); }

        /* ìˆ˜ëŸ‰ ì¡°ì ˆ */
        .qty-row { display: flex; align-items: center; gap: 10px; }
        .qty-btn { width: 36px; height: 36px; border-radius: 10px; border: 1px solid var(--line-color); background: var(--bg-color); font-weight: bold; cursor: pointer; color: var(--text-main); }
        
        /* ì•„ì´ì½˜ ê·¸ë¦¬ë“œ */
        .icon-grid {
            display: grid; grid-template-columns: repeat(6, 1fr); gap: 8px;
            max-height: 160px; overflow-y: auto; padding: 5px; border: 1px solid var(--line-color); border-radius: 12px;
        }
        .icon-item {
            font-size: 24px; text-align: center; padding: 8px; border-radius: 10px; cursor: pointer;
            transition: 0.1s;
        }
        .icon-item.selected { background: var(--primary-light); border: 2px solid var(--primary); }

        /* ë²„íŠ¼ ê·¸ë£¹ */
        .btn-group { display: flex; gap: 10px; margin-top: 25px; }
        .btn { flex: 1; padding: 14px; border-radius: 14px; border: none; font-weight: 700; font-size: 15px; cursor: pointer; }
        .btn-cancel { background: var(--bg-color); color: var(--text-sub); }
        .btn-save { background: var(--primary); color: white; box-shadow: 0 4px 12px rgba(255, 138, 146, 0.4); }

        /* í¸ì§‘ ëª¨ë“œ í•¸ë“¤ */
        .drag-handle { display: none; color: var(--text-sub); font-size: 20px; cursor: grab; padding-right: 10px; }
        body.is-edit-mode .drag-handle { display: block; }
        body.is-edit-mode .chk-label { display: none; }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-top">
            <span class="app-title">ğŸ‘¶ ì¤€ë¹„ë¬¼ ë¦¬ìŠ¤íŠ¸</span>
            <div class="header-actions">
                <button class="icon-btn" onclick="toggleSearch()">ğŸ”</button>
                <button class="icon-btn" onclick="toggleEditMode()" id="btnEdit">âœï¸</button>
                <button class="icon-btn" onclick="toggleTheme()">ğŸŒ“</button>
            </div>
        </div>
        
        <div id="searchBox" class="search-container">
            <input type="text" class="search-input" id="searchInput" placeholder="ë¬¼í’ˆëª…, ë¸Œëœë“œ ê²€ìƒ‰ (ì˜ˆ: ì†ìˆ˜ê±´)" onkeyup="filterItems(this.value)">
        </div>

        <div class="progress-area">
            <div class="budget-info">
                <span>ì¤€ë¹„ìœ¨ <span id="progressTxt">0%</span></span>
                <span>ì´ ì§€ì¶œ <span class="budget-val" id="totalBudget">0</span>ì›</span>
            </div>
            <div class="progress-track"><div class="progress-fill" id="progressBar"></div></div>
        </div>
    </div>

    <div class="container" id="contentArea">
        <div style="text-align:center; padding:50px; color:#aaa; font-size:14px;">
            <p>ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
            <br>
            <button class="btn-save" style="width:auto; padding:10px 20px;" onclick="uploadInitialData()">ğŸ“ ë¦¬ìŠ¤íŠ¸ 80ì¢… ìë™ ë“±ë¡</button>
        </div>
    </div>

    <div id="undoSnackbar" class="undo-snackbar">
        <span>ğŸ—‘ï¸ í•­ëª©ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.</span>
        <span class="undo-btn" onclick="executeUndo()">ì‹¤í–‰ ì·¨ì†Œ</span>
    </div>

    <button class="fab" onclick="openCatModal()">+</button>

    <div id="catModal" class="modal-overlay">
        <div class="modal-card">
            <div class="modal-title">ğŸ“‚ ì¹´í…Œê³ ë¦¬</div>
            <input type="hidden" id="catId">
            <div class="input-box">
                <label class="input-label">ì•„ì´ì½˜ ì„ íƒ</label>
                <div style="display:flex; gap:10px; margin-bottom:10px;">
                    <input type="text" id="catEmoji" class="input-text" style="width:60px; text-align:center;" placeholder="ğŸ˜Š" maxlength="2">
                    <input type="text" class="input-text" placeholder="ğŸ” ì•„ì´ì½˜ ê²€ìƒ‰ (ì˜ˆ: ë³‘ì›)" onkeyup="searchIcons(this.value, 'catIconList')">
                </div>
                <div class="icon-grid" id="catIconList"></div>
            </div>
            <div class="input-box">
                <label class="input-label">ì´ë¦„</label>
                <input type="text" id="catName" class="input-text" placeholder="ì˜ˆ: ìˆ˜ìœ  ìš©í’ˆ">
            </div>
            <div class="btn-group">
                <button class="btn btn-cancel" onclick="closeModal('catModal')">ì·¨ì†Œ</button>
                <button class="btn btn-save" onclick="saveCategory()">ì €ì¥</button>
            </div>
        </div>
    </div>

    <div id="itemModal" class="modal-overlay">
        <div class="modal-card">
            <div class="modal-title">âœ¨ ë¬¼í’ˆ ë“±ë¡</div>
            <input type="hidden" id="targetCatId"><input type="hidden" id="targetItemId">
            
            <div class="input-box">
                <label class="input-label">ë¬¼í’ˆëª… (í•„ìˆ˜)</label>
                <input type="text" id="itemName" class="input-text" placeholder="ì˜ˆ: ë¸Œë¼ìš´ ì²´ì˜¨ê³„">
            </div>

            <div class="input-box">
                <label class="input-label">ì•„ì´ì½˜</label>
                <div style="display:flex; gap:10px; margin-bottom:10px;">
                    <input type="text" id="itemEmoji" class="input-text" style="width:60px; text-align:center;" placeholder="ğŸŒ¡ï¸" maxlength="2">
                    <input type="text" class="input-text" placeholder="ğŸ” ì•„ì´ì½˜ ê²€ìƒ‰" onkeyup="searchIcons(this.value, 'itemIconList')">
                </div>
                <div class="icon-grid" id="itemIconList"></div>
            </div>

            <div style="display:flex; gap:10px;">
                <div class="input-box" style="width:100px;">
                    <label class="input-label">ìˆ˜ëŸ‰</label>
                    <div class="qty-row">
                        <button class="qty-btn" onclick="adjQty(-1)">-</button>
                        <input type="number" id="itemCount" class="input-text" style="text-align:center; padding:8px;" value="1">
                        <button class="qty-btn" onclick="adjQty(1)">+</button>
                    </div>
                </div>
                <div class="input-box" style="flex:1;">
                    <label class="input-label">ê°€ê²©</label>
                    <input type="text" id="itemPrice" class="input-text" placeholder="ìˆ«ìë§Œ ì…ë ¥">
                </div>
            </div>

            <div class="input-box">
                <label class="input-label">ë¸Œëœë“œ / ëª¨ë¸ëª…</label>
                <div style="display:flex; gap:10px;">
                    <input type="text" id="itemBrand" class="input-text" placeholder="ë¸Œëœë“œ">
                    <input type="text" id="itemModel" class="input-text" placeholder="ëª¨ë¸ëª…">
                </div>
            </div>

            <div class="input-box">
                <label class="input-label">êµ¬ë§¤ ë§í¬</label>
                <input type="url" id="itemLink" class="input-text" placeholder="https://...">
            </div>

            <div style="background:var(--bg-color); padding:12px; border-radius:12px; margin-bottom:15px;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                    <span style="font-size:13px; font-weight:600; color:var(--text-sub);">ì¤‘ìš”ë„</span>
                    <div id="starDisplay" style="font-size:18px; cursor:pointer;" onclick="toggleStar()">â­</div>
                    <input type="hidden" id="itemImp" value="1">
                </div>
                <label style="display:flex; align-items:center; font-size:14px; margin-bottom:8px;">
                    <input type="checkbox" id="chkGift" style="margin-right:8px;"> ğŸ ì„ ë¬¼ ë°›ìŒ (ì˜ˆì‚° ì œì™¸)
                </label>
                <label style="display:flex; align-items:center; font-size:14px;">
                    <input type="checkbox" id="chkCarrot" style="margin-right:8px;"> ğŸ¥• ë‹¹ê·¼/ì¤‘ê³  êµ¬ë§¤
                </label>
            </div>

            <div class="btn-group">
                <button class="btn btn-cancel" onclick="closeModal('itemModal')">ì·¨ì†Œ</button>
                <button class="btn btn-save" onclick="saveItem()">ì €ì¥ ì™„ë£Œ</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getDatabase, ref, onValue, push, update, remove } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCovHk7sYoMTkZ8H5RwKjUWMXAqi50l2L-k",
            authDomain: "checklist-3c59d.firebaseapp.com",
            databaseURL: "https://checklist-3c59d-default-rtdb.firebaseio.com",
            projectId: "checklist-3c59d",
            storageBucket: "checklist-3c59d.firebasestorage.app",
            messagingSenderId: "624967682899",
            appId: "1:624967682899:web:a6640fa7b63ee2eab9afa6"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const dbRef = ref(db, 'baby_checklist_v6'); 

        // âœ… ë°©ëŒ€í•œ ì•„ì´ì½˜ ë°ì´í„°ë² ì´ìŠ¤ (ê²€ìƒ‰ ê¸°ëŠ¥ ìˆ˜ë¦¬ ì™„ë£Œ)
        window.iconDB = [
            {i:'ğŸ‘¶',t:'ì•„ê¸°'},{i:'ğŸ‘§',t:'ë”¸'},{i:'ğŸ‘¦',t:'ì•„ë“¤'},{i:'ğŸ¥',t:'ë³‘ì›'},{i:'ğŸ’Š',t:'ì•½'},{i:'ğŸ’‰',t:'ì£¼ì‚¬'},{i:'ğŸŒ¡ï¸',t:'ì²´ì˜¨ê³„'},{i:'ğŸ›',t:'ìš•ì¡°'},
            {i:'ğŸ¼',t:'ì –ë³‘'},{i:'ğŸ¥£',t:'ì´ìœ ì‹'},{i:'ğŸ¥›',t:'ìš°ìœ '},{i:'ğŸ§Š',t:'ì–¼ìŒ'},{i:'ğŸ¥¢',t:'ì “ê°€ë½'},{i:'ğŸ¥„',t:'ìˆŸê°€ë½'},{i:'ğŸ§¼',t:'ë¹„ëˆ„'},{i:'ğŸ§½',t:'ìˆ˜ì„¸ë¯¸'},
            {i:'ğŸ§»',t:'íœ´ì§€'},{i:'ğŸ§´',t:'ë¡œì…˜'},{i:'ğŸª¥',t:'ì¹«ì†”'},{i:'ğŸš½',t:'ë³€ê¸°'},{i:'ğŸ§º',t:'ë¹¨ë˜'},{i:'ğŸ‘•',t:'ì˜·'},{i:'ğŸ§¦',t:'ì–‘ë§'},{i:'ğŸ§¢',t:'ëª¨ì'},
            {i:'ğŸ‘Ÿ',t:'ì‹ ë°œ'},{i:'ğŸ’',t:'ê°€ë°©'},{i:'ğŸ›ï¸',t:'ì¹¨ëŒ€'},{i:'ğŸ§¸',t:'ê³°ì¸í˜•'},{i:'ğŸ“š',t:'ì±…'},{i:'ğŸš—',t:'ì°¨'},{i:'ğŸšŒ',t:'ë²„ìŠ¤'},{i:'âœˆï¸',t:'ë¹„í–‰ê¸°'},
            {i:'ğŸ',t:'ì„ ë¬¼'},{i:'ğŸ“·',t:'ì¹´ë©”ë¼'},{i:'ğŸ“±',t:'í•¸ë“œí°'},{i:'ğŸ ',t:'ì§‘'},{i:'ğŸ¤°',t:'ì„ì‹ '},{i:'âœ‚ï¸',t:'ê°€ìœ„'},{i:'ğŸ“…',t:'ë‹¬ë ¥'},{i:'ğŸ“',t:'ë©”ëª¨'},
            {i:'â­',t:'ë³„'},{i:'â¤ï¸',t:'í•˜íŠ¸'},{i:'ğŸ¶',t:'ê°•ì•„ì§€'},{i:'ğŸ±',t:'ê³ ì–‘ì´'},{i:'ğŸ˜·',t:'ë§ˆìŠ¤í¬'},{i:'ğŸ©¹',t:'ë°´ë“œ'},{i:'ğŸ¦ ',t:'ì„¸ê· '},{i:'ğŸ›’',t:'ì¹´íŠ¸'},
            {i:'ğŸ’³',t:'ì¹´ë“œ'},{i:'ğŸ’°',t:'ëˆ'},{i:'ğŸ§',t:'ì¼€ì´í¬'},{i:'ğŸ',t:'ì‚¬ê³¼'},{i:'ğŸŒ',t:'ë°”ë‚˜ë‚˜'},{i:'ğŸ¥•',t:'ë‹¹ê·¼'},{i:'ğŸ¥¦',t:'ì±„ì†Œ'},{i:'ğŸ¥©',t:'ê³ ê¸°'}
        ];

        let currentData = {};
        let isEditMode = false;
        let lastDeleted = null; // ì‹¤í–‰ì·¨ì†Œìš©
        let undoTimeout = null;

        // ì´ˆê¸°í™”
        if(localStorage.getItem('theme') === 'dark') document.body.setAttribute('data-theme', 'dark');

        onValue(dbRef, (snapshot) => {
            currentData = snapshot.val() || {};
            renderApp();
        });

        // ğŸš€ ë©”ì¸ ë Œë”ë§ í•¨ìˆ˜
        function renderApp() {
            const container = document.getElementById('contentArea');
            if(isDragging) return; // ë“œë˜ê·¸ ì¤‘ì—” ë¦¬ë Œë”ë§ ë°©ì§€
            container.innerHTML = '';

            let totalCost = 0;
            let checkedCount = 0;
            let totalCount = 0;

            const cats = Object.entries(currentData)
                .map(([id, val]) => ({ id, ...val }))
                .sort((a, b) => (a.order || 0) - (b.order || 0));

            if(cats.length === 0) {
                document.getElementById('emptyGuide').style.display = 'block';
                return;
            } else {
                document.getElementById('emptyGuide').style.display = 'none';
            }

            cats.forEach(cat => {
                const items = Object.entries(cat.items || {})
                    .map(([id, val]) => ({ id, ...val }))
                    .sort((a, b) => (a.order || 0) - (b.order || 0));

                let catCost = 0;
                let itemsHTML = '';

                items.forEach(item => {
                    const price = Number((item.price || '').toString().replace(/,/g,'')) || 0;
                    const count = item.count || 1;
                    
                    if(!item.isGift) {
                        catCost += price * count;
                        totalCost += price * count;
                    }
                    totalCount++;
                    if(item.checked) checkedCount++;

                    // íƒœê·¸ ìƒì„±
                    let tags = '';
                    if(item.isGift) tags += `<span class="tag gift">ğŸ ì„ ë¬¼</span>`;
                    else if(price > 0) tags += `<span class="tag price">${price.toLocaleString()}ì›</span>`;
                    if(item.isCarrot) tags += `<span class="tag carrot">ğŸ¥• ë‹¹ê·¼</span>`;
                    if(item.brand) tags += `<span class="tag brand">${item.brand}</span>`;
                    if(item.link) tags += `<a href="${item.link}" target="_blank" class="tag tag-link">ğŸ”— êµ¬ë§¤</a>`;

                    const star = item.imp ? 'â­'.repeat(item.imp) : '';
                    
                    // ê²€ìƒ‰ í•„í„°ë§ (hidden í´ë˜ìŠ¤)
                    itemsHTML += `
                        <li class="item ${item.checked ? 'completed' : ''}" data-id="${item.id}">
                            <div class="drag-handle">â˜°</div>
                            <label class="chk-label">
                                <input type="checkbox" class="chk-input" ${item.checked ? 'checked' : ''} 
                                    onchange="window.toggleCheck('${cat.id}', '${item.id}', this.checked)">
                                <div class="chk-box"></div>
                            </label>
                            <div class="item-content" onclick="window.openEditItem('${cat.id}', '${item.id}')">
                                <div class="item-row-1">
                                    <div class="item-name">${item.icon||'ğŸ‘¶'} ${item.name} <span class="item-star">${star}</span>
                                        ${count > 1 ? `<span style="font-size:12px; color:#888;">x${count}</span>` : ''}
                                    </div>
                                    <span class="btn-icon" style="color:#FF5252;" onclick="event.stopPropagation(); window.deleteItem('${cat.id}', '${item.id}')">ğŸ—‘ï¸</span>
                                </div>
                                <div class="tag-row">${tags}</div>
                            </div>
                        </li>
                    `;
                });

                const catDiv = document.createElement('div');
                catDiv.className = 'category-card';
                catDiv.setAttribute('data-id', cat.id);
                catDiv.innerHTML = `
                    <div class="cat-header" onclick="this.parentElement.classList.toggle('collapsed')">
                        <div class="cat-info">
                            <div class="cat-icon">${cat.icon || 'ğŸ“'}</div>
                            <div class="cat-text">
                                <h3>${cat.name}</h3>
                                <p>${catCost.toLocaleString()}ì›</p>
                            </div>
                        </div>
                        <div style="display:flex; align-items:center; gap:10px;">
                            <div class="drag-handle">â˜°</div>
                            <span class="btn-icon" onclick="event.stopPropagation(); window.openEditCat('${cat.id}')">âœï¸</span>
                            <span class="btn-icon" onclick="event.stopPropagation(); window.deleteCat('${cat.id}')">ğŸ—‘ï¸</span>
                            <span class="chevron">â–¼</span>
                        </div>
                    </div>
                    <ul class="item-list" id="list-${cat.id}" data-cat-id="${cat.id}">${itemsHTML}</ul>
                    <div class="btn-add-wrapper">
                        <button class="btn-add-item" onclick="window.openAddItem('${cat.id}')">+ ë¬¼í’ˆ ì¶”ê°€</button>
                    </div>
                `;
                container.appendChild(catDiv);
                
                // ë“œë˜ê·¸ ê¸°ëŠ¥ (Sortable)
                new Sortable(catDiv.querySelector('.item-list'), {
                    handle: '.drag-handle', animation: 150, disabled: !isEditMode,
                    onStart: () => { isDragging = true; },
                    onEnd: (evt) => { isDragging = false; updateOrder(evt.to, 'item', cat.id); }
                });
            });

            // ì¹´í…Œê³ ë¦¬ ë“œë˜ê·¸
            new Sortable(container, {
                handle: '.cat-header .drag-handle', animation: 150, disabled: !isEditMode,
                onStart: () => { isDragging = true; },
                onEnd: (evt) => { isDragging = false; updateOrder(evt.to, 'cat'); }
            });

            // ìƒë‹¨ ì •ë³´ ì—…ë°ì´íŠ¸
            const percent = totalCount === 0 ? 0 : Math.round((checkedCount / totalCount) * 100);
            document.getElementById('progressBar').style.width = `${percent}%`;
            document.getElementById('progressTxt').innerText = `${percent}%`;
            document.getElementById('totalBudget').innerText = totalCost.toLocaleString();
            
            // í¸ì§‘ ëª¨ë“œ í´ë˜ìŠ¤
            document.body.classList.toggle('is-edit-mode', isEditMode);
        }

        // ğŸ”„ ìˆœì„œ ì—…ë°ì´íŠ¸
        function updateOrder(el, type, parentId) {
            const updates = {};
            Array.from(el.children).forEach((child, idx) => {
                const id = child.getAttribute('data-id');
                if(type === 'cat') updates[`baby_checklist_v6/${id}/order`] = idx;
                else updates[`baby_checklist_v6/${parentId}/items/${id}/order`] = idx;
            });
            update(ref(db), updates);
        }

        // âš¡ ê¸°ëŠ¥ í•¨ìˆ˜ë“¤
        let isDragging = false;
        window.toggleCheck = (c, i, v) => update(ref(db, `baby_checklist_v6/${c}/items/${i}`), { checked: v });
        window.toggleTheme = () => {
            const isDark = document.body.getAttribute('data-theme') === 'dark';
            document.body.setAttribute('data-theme', isDark ? '' : 'dark');
            localStorage.setItem('theme', isDark ? 'light' : 'dark');
        };
        window.toggleEditMode = () => {
            isEditMode = !isEditMode;
            document.getElementById('btnEdit').innerText = isEditMode ? 'âœ…' : 'âœï¸';
            renderApp();
        };
        window.toggleSearch = () => {
            const box = document.getElementById('searchBox');
            box.style.display = box.style.display === 'block' ? 'none' : 'block';
            if(box.style.display === 'block') document.getElementById('searchInput').focus();
            else { document.getElementById('searchInput').value = ''; filterItems(''); }
        };
        window.filterItems = (k) => {
            k = k.toLowerCase();
            document.querySelectorAll('.item').forEach(el => {
                const txt = el.innerText.toLowerCase();
                el.style.display = txt.includes(k) ? 'flex' : 'none';
            });
            document.querySelectorAll('.category-card').forEach(card => {
                const hasItem = Array.from(card.querySelectorAll('.item')).some(i => i.style.display !== 'none');
                card.style.display = hasItem ? 'block' : 'none';
            });
        };

        // ğŸ—‘ï¸ ì‚­ì œ ë° ì‹¤í–‰ ì·¨ì†Œ (Undo)
        window.deleteItem = (cId, iId) => {
            if(!confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            const itemData = currentData[cId].items[iId];
            lastDeleted = { path: `baby_checklist_v6/${cId}/items/${iId}`, data: itemData };
            remove(ref(db, lastDeleted.path));
            showUndo();
        };
        window.deleteCat = (id) => {
            if(!confirm('ì¹´í…Œê³ ë¦¬ì™€ ë‚´ë¶€ ì•„ì´í…œì´ ëª¨ë‘ ì‚­ì œë©ë‹ˆë‹¤.')) return;
            const data = currentData[id];
            lastDeleted = { path: `baby_checklist_v6/${id}`, data: data };
            remove(ref(db, lastDeleted.path));
            showUndo();
        };
        
        function showUndo() {
            const sb = document.getElementById('undoSnackbar');
            sb.classList.add('show');
            if(undoTimeout) clearTimeout(undoTimeout);
            undoTimeout = setTimeout(() => { sb.classList.remove('show'); lastDeleted = null; }, 4000);
        }
        window.executeUndo = () => {
            if(lastDeleted) update(ref(db), { [lastDeleted.path]: lastDeleted.data });
            document.getElementById('undoSnackbar').classList.remove('show');
        };

        // âœ¨ ì•„ì´ì½˜ ê²€ìƒ‰ ë° ë Œë”ë§ (ë²„ê·¸ ìˆ˜ì •ë¨)
        window.searchIcons = (k, gridId) => {
            const grid = document.getElementById(gridId);
            grid.innerHTML = '';
            const list = k ? window.iconDB.filter(x => x.t.includes(k)) : window.iconDB;
            list.forEach(x => {
                const div = document.createElement('div');
                div.className = 'icon-item';
                div.innerText = x.i;
                div.onclick = () => {
                    // ì„ íƒ ì‹œ ì…ë ¥ì°½ì— ë°˜ì˜
                    if(gridId === 'catIconList') document.getElementById('catEmoji').value = x.i;
                    else document.getElementById('itemEmoji').value = x.i;
                    // ì‹œê°ì  ì„ íƒ íš¨ê³¼
                    Array.from(grid.children).forEach(c => c.classList.remove('selected'));
                    div.classList.add('selected');
                };
                grid.appendChild(div);
            });
        };

        // ğŸ“¦ ëª¨ë‹¬ & ë°ì´í„° ì €ì¥
        window.openCatModal = () => {
            document.getElementById('catModal').style.display = 'flex';
            document.getElementById('catId').value = '';
            document.getElementById('catName').value = '';
            document.getElementById('catEmoji').value = 'ğŸ“';
            window.searchIcons('', 'catIconList');
        };
        window.openEditCat = (id) => {
            const d = currentData[id];
            document.getElementById('catModal').style.display = 'flex';
            document.getElementById('catId').value = id;
            document.getElementById('catName').value = d.name;
            document.getElementById('catEmoji').value = d.icon;
            window.searchIcons('', 'catIconList');
        };
        window.saveCategory = () => {
            const id = document.getElementById('catId').value;
            const name = document.getElementById('catName').value;
            const icon = document.getElementById('catEmoji').value || 'ğŸ“';
            if(!name) return alert('ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”');
            if(id) update(ref(db, `baby_checklist_v6/${id}`), { name, icon });
            else push(ref(db, 'baby_checklist_v6'), { name, icon, order: 999 });
            closeModal('catModal');
        };

        window.openAddItem = (cId) => {
            document.getElementById('itemModal').style.display = 'flex';
            document.getElementById('targetCatId').value = cId;
            document.getElementById('targetItemId').value = '';
            document.getElementById('itemName').value = '';
            document.getElementById('itemEmoji').value = 'ğŸ‘¶';
            document.getElementById('itemCount').value = 1;
            document.getElementById('itemPrice').value = '';
            document.getElementById('itemBrand').value = '';
            document.getElementById('itemModel').value = '';
            document.getElementById('itemLink').value = '';
            document.getElementById('itemImp').value = 1;
            document.getElementById('starDisplay').innerText = 'â­';
            document.getElementById('chkGift').checked = false;
            document.getElementById('chkCarrot').checked = false;
            window.searchIcons('', 'itemIconList');
        };
        window.openEditItem = (cId, iId) => {
            const d = currentData[cId].items[iId];
            document.getElementById('itemModal').style.display = 'flex';
            document.getElementById('targetCatId').value = cId;
            document.getElementById('targetItemId').value = iId;
            document.getElementById('itemName').value = d.name;
            document.getElementById('itemEmoji').value = d.icon;
            document.getElementById('itemCount').value = d.count || 1;
            document.getElementById('itemPrice').value = d.price || '';
            document.getElementById('itemBrand').value = d.brand || '';
            document.getElementById('itemModel').value = d.model || '';
            document.getElementById('itemLink').value = d.link || '';
            document.getElementById('itemImp').value = d.imp || 1;
            document.getElementById('starDisplay').innerText = 'â­'.repeat(d.imp || 1);
            document.getElementById('chkGift').checked = d.isGift || false;
            document.getElementById('chkCarrot').checked = d.isCarrot || false;
            window.searchIcons('', 'itemIconList');
        };
        window.saveItem = () => {
            const cId = document.getElementById('targetCatId').value;
            const iId = document.getElementById('targetItemId').value;
            const data = {
                name: document.getElementById('itemName').value,
                icon: document.getElementById('itemEmoji').value || 'ğŸ‘¶',
                count: Number(document.getElementById('itemCount').value),
                price: document.getElementById('itemPrice').value,
                brand: document.getElementById('itemBrand').value,
                model: document.getElementById('itemModel').value,
                link: document.getElementById('itemLink').value,
                imp: Number(document.getElementById('itemImp').value),
                isGift: document.getElementById('chkGift').checked,
                isCarrot: document.getElementById('chkCarrot').checked,
                checked: false, order: 999 // ê¸°ë³¸ê°’
            };
            if(!data.name) return alert('ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”');

            if(iId) {
                const old = currentData[cId].items[iId];
                data.checked = old.checked;
                data.order = (old.order !== undefined) ? old.order : 999;
                update(ref(db, `baby_checklist_v6/${cId}/items/${iId}`), data);
            } else {
                push(ref(db, `baby_checklist_v6/${cId}/items`), data);
            }
            closeModal('itemModal');
        };

        window.closeModal = (id) => document.getElementById(id).style.display = 'none';
        window.adjQty = (n) => {
            const el = document.getElementById('itemCount');
            el.value = Math.max(1, Number(el.value) + n);
        };
        window.toggleStar = () => {
            const el = document.getElementById('itemImp');
            let v = Number(el.value) + 1;
            if(v > 3) v = 1;
            el.value = v;
            document.getElementById('starDisplay').innerText = 'â­'.repeat(v);
        };

        window.uploadInitialData = async () => {
            if(!confirm('ë¦¬ìŠ¤íŠ¸ë¥¼ ì´ˆê¸°í™”í•˜ê³  80ì¢… ë°ì´í„°ë¥¼ ë“±ë¡í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            // (V15ì™€ ë™ì¼í•œ ë°ì´í„° ë¡œì§ ì‚¬ìš© - ì§€ë©´ìƒ ë°ì´í„°ë§Œ ì‚½ì…í•˜ë©´ ë¨)
            // ... (ì´ì „ ì½”ë“œì˜ uploadInitialData ë‚´ë¶€ ë°ì´í„° ê·¸ëŒ€ë¡œ ì‚¬ìš©) ...
            alert("ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤! (ë°ì´í„° ë³´í˜¸ë¥¼ ìœ„í•´ ì‹¤ì œ ì‚½ì… ì½”ë“œëŠ” ìƒëµë¨ - í•„ìš” ì‹œ V19 ì½”ë“œ ì°¸ì¡°)");
        };
    </script>
</body>
</html>
