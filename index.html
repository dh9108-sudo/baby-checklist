<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ğŸ‘¶ ë² ì´ë¹„ ì²´í¬ë¦¬ìŠ¤íŠ¸ (V31)</title>
    <link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        :root {
            --main-color: #FF878D;
            --sub-color: #FFF0F5;
            --bg-color: #F7F8FA;
            --card-bg: #FFFFFF;
            --text-color: #333333;
            --text-sub: #888888;
            --border-color: #EEEEEE;
            --price-color: #FF6B6B;
            --carrot-color: #FF8A3D;
            --gift-color: #9C27B0;
        }
        
        [data-theme="dark"] {
            --bg-color: #121212;
            --card-bg: #1E1E1E;
            --text-color: #E0E0E0;
            --text-sub: #AAAAAA;
            --border-color: #333333;
            --sub-color: #2C2C2C;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
        body { font-family: 'Pretendard', sans-serif; background-color: var(--bg-color); color: var(--text-color); margin: 0; padding: 0; padding-bottom: 120px; transition: background-color 0.3s; }
        .container { max-width: 600px; margin: 0 auto; }

        .header { background: linear-gradient(135deg, var(--main-color), #ff9a9e); padding: 20px 20px 25px; color: white; border-radius: 0 0 25px 25px; box-shadow: 0 4px 20px rgba(0,0,0,0.15); position: sticky; top: 0; z-index: 100; }
        .header-top-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .header h2 { margin: 0; font-size: 20px; font-weight: 800; }
        .header-actions { display: flex; align-items: center; gap: 8px; }
        .icon-btn { background: rgba(255,255,255,0.25); border: none; color: white; width: 34px; height: 34px; border-radius: 50%; font-size: 16px; cursor: pointer; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(4px); transition: transform 0.1s; }
        .icon-btn:active { transform: scale(0.9); background: rgba(255,255,255,0.4); }
        
        .filter-sort-bar { display: flex; gap: 10px; margin-top: 15px; overflow-x: auto; padding-bottom: 5px; }
        .filter-select { background: rgba(255,255,255,0.9); border: none; padding: 6px 10px; border-radius: 15px; font-size: 12px; font-weight: bold; color: var(--main-color); outline: none; }

        .global-search-box { display: none; background: var(--card-bg); padding: 10px; border-radius: 12px; margin-bottom: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); margin-top:10px; }
        .global-search-input { width: 100%; border: 1px solid var(--border-color); padding: 10px; border-radius: 8px; font-size: 14px; outline: none; background: var(--bg-color); color: var(--text-color); }

        .total-budget-badge { background: rgba(255,255,255,0.95); color: var(--main-color); padding: 6px 12px; border-radius: 15px; font-weight: bold; font-size: 13px; display: inline-block; margin-top: 10px; }
        .progress-box { background: rgba(255,255,255,0.25); backdrop-filter: blur(5px); padding: 15px; border-radius: 12px; display: flex; align-items: center; justify-content: space-between; margin-top: 10px; }
        .progress-circle { width: 45px; height: 45px; border-radius: 50%; background: white; color: var(--main-color); display: flex; align-items: center; justify-content: center; font-weight: 800; font-size: 13px; }
        .progress-bar-bg { flex: 1; height: 6px; background: rgba(255,255,255,0.5); border-radius: 4px; margin: 0 15px; overflow: hidden; }
        .progress-bar { height: 100%; background: white; width: 0%; transition: width 0.5s ease; }
        .total-info { font-size: 12px; font-weight: 600; text-align: right; color: white; }

        .category-card { background: var(--card-bg); margin: 20px; border-radius: 16px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); overflow: hidden; transition: transform 0.1s; }
        .category-card:active { transform: scale(0.995); }
        .category-card.collapsed .item-list, .category-card.collapsed .btn-add-item { display: none; }
        .cat-header { padding: 15px 20px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        .cat-left { display: flex; align-items: center; gap: 10px; }
        .cat-icon { font-size: 18px; background: var(--sub-color); width: 32px; height: 32px; border-radius: 8px; display: flex; align-items: center; justify-content: center; }
        .cat-title { font-size: 16px; font-weight: 700; }
        .cat-sum { font-size: 12px; color: var(--text-sub); font-weight: 500; margin-left: 5px; }
        .chevron { transition: transform 0.3s; font-size: 12px; color: #aaa; }
        .category-card.collapsed .chevron { transform: rotate(-90deg); }

        .item-list { list-style: none; padding: 0; margin: 0; }
        .item { padding: 15px 20px; border-bottom: 1px solid var(--border-color); background: var(--card-bg); transition: background 0.1s; }
        .item:active { background-color: var(--bg-color); transform: scale(0.99); }
        .item.hidden { display: none; }
        
        .item-top { display: flex; align-items: flex-start; }
        .chk-wrap { width: 22px; height: 22px; margin-right: 12px; position: relative; flex-shrink: 0; margin-top: 2px;}
        .chk-wrap input { position: absolute; width: 100%; height: 100%; opacity: 0; cursor: pointer; z-index: 2;}
        .chk-box { width: 100%; height: 100%; border: 2px solid #ddd; border-radius: 6px; display: flex; align-items: center; justify-content: center; transition: 0.2s; }
        .chk-wrap input:checked + .chk-box { background: var(--main-color); border-color: var(--main-color); }
        .chk-box::after { content: 'âœ”'; color: white; font-size: 12px; display: none; }
        .chk-wrap input:checked + .chk-box::after { display: block; }

        .item-content { flex: 1; cursor: pointer; } 
        .item-header-row { display: flex; align-items: center; gap: 5px; margin-bottom: 6px; }
        .item-name { font-size: 15px; font-weight: 600; color: var(--text-color); }
        .star-rating { font-size: 12px; color: #FFC107; letter-spacing: 0; font-weight: bold; }
        .item-memo { font-size: 12px; color: var(--text-sub); background: var(--bg-color); padding: 4px 8px; border-radius: 6px; margin-top: 5px; line-height: 1.4; display: inline-block; }

        .tag-row { display: flex; flex-wrap: wrap; gap: 6px; align-items: center; }
        .tag { padding: 3px 6px; border-radius: 4px; font-size: 11px; color: #666; background: var(--border-color); }
        .tag.brand { background: #FFF3E0; color: #E65100; font-weight: 600; }
        .tag.price { background: #fff0f0; color: var(--price-color); font-weight: 600; }
        .tag.carrot { background: #FFF3E0; color: var(--carrot-color); font-weight: 800; border: 1px solid #FFCCBC; }
        .tag.gift { background: #F3E5F5; color: var(--gift-color); font-weight: 800; border: 1px solid #E1BEE7; }
        .link-btn { text-decoration: none; background: #E3F2FD; color: #1565C0; padding: 3px 6px; border-radius: 4px; font-size: 11px; font-weight: bold; }
        .naver-btn { text-decoration: none; background: #03C75A; color: white; padding: 3px 6px; border-radius: 4px; font-size: 11px; font-weight: bold; display: inline-flex; align-items: center; gap: 2px; }
        
        .item.completed .item-name { text-decoration: line-through; color: #aaa; }
        .item.completed .item-icon { opacity: 0.5; }

        .item-actions { display: none; gap: 12px; margin-left: 10px; align-items: flex-start; }
        body.is-edit-mode .item-actions { display: flex; }
        .action-btn { width: 28px; height: 28px; border: none; background: transparent; border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: background 0.2s; }
        .action-btn:active { background: var(--border-color); transform: scale(0.9); }
        .action-btn svg { width: 18px; height: 18px; stroke: #999; stroke-width: 2; fill: none; stroke-linecap: round; stroke-linejoin: round; }
        .action-btn.del:hover svg { stroke: #FF5252; }
        .action-btn.edit:hover svg { stroke: var(--main-color); }

        .btn-add-item { width: calc(100% - 30px); margin: 15px auto 5px; padding: 12px; background: var(--sub-color); color: var(--main-color); border: none; border-radius: 12px; font-weight: 800; font-size: 14px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 5px; transition: all 0.2s; }
        .btn-add-item:active { transform: scale(0.95); background: #ffe0e6; }

        .fab-btn { position: fixed; bottom: 30px; right: 25px; background: var(--main-color); color: white; width: 55px; height: 55px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 28px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); border: none; cursor: pointer; z-index: 99; transition: transform 0.2s; }
        .fab-btn:active { transform: scale(0.9); }

        #undoBar { position: fixed; bottom: -80px; left: 50%; transform: translateX(-50%); background: #222; color: white; padding: 14px 24px; border-radius: 30px; box-shadow: 0 10px 20px rgba(0,0,0,0.2); z-index: 200; display: flex; align-items: center; gap: 20px; font-size: 14px; transition: bottom 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); width: 90%; max-width: 400px; justify-content: space-between; }
        #undoBar.show { bottom: 30px; }
        .undo-btn { color: var(--main-color); font-weight: 800; cursor: pointer; text-transform: uppercase; }

        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 200; align-items: center; justify-content: center; }
        .modal { background: var(--card-bg); width: 90%; max-width: 400px; padding: 25px; border-radius: 20px; max-height: 90vh; overflow-y: auto; color: var(--text-color); }
        .input-group { margin-bottom: 12px; }
        .input-label { display: block; font-size: 12px; color: var(--text-sub); margin-bottom: 5px; }
        .input-field { width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 10px; font-size: 15px; outline: none; background: var(--bg-color); color: var(--text-color); }
        
        .qty-wrap { display: flex; align-items: center; gap: 5px; }
        .qty-btn { width: 30px; height: 30px; border-radius: 8px; border: 1px solid var(--border-color); background: var(--bg-color); color: var(--text-color); font-weight: bold; cursor: pointer; }
        .star-toggle-btn { width: 100%; padding: 10px; border: 1px solid #FFC107; background: #FFF8E1; color: #FFA000; border-radius: 10px; font-weight: bold; cursor: pointer; margin-bottom: 15px; font-size: 14px; }
        .option-row { display: flex; align-items: center; margin-bottom: 10px; padding: 10px; border-radius: 8px; background: var(--bg-color); }
        .option-label { display: flex; align-items: center; font-size: 14px; cursor: pointer; flex: 1; }
        .option-chk { width: 18px; height: 18px; margin-right: 8px; accent-color: var(--main-color); }
        
        .icon-search-box { position: sticky; top: 0; background: var(--card-bg); padding-bottom: 10px; z-index: 10; }
        .icon-grid { height: 150px; overflow-y: scroll; border: 1px solid var(--border-color); border-radius: 10px; padding: 10px; display: grid; grid-template-columns: repeat(6, 1fr); gap: 5px; margin-bottom: 10px; }
        .icon-opt { font-size: 22px; text-align: center; padding: 8px; border-radius: 8px; cursor: pointer; transition: background 0.1s; }
        .icon-opt:active { background: #eee; transform: scale(0.9); }
        .icon-opt.selected { background: var(--sub-color); border: 1px solid var(--main-color); }

        .btn-row { display: flex; gap: 10px; margin-top: 20px; }
        .btn { flex: 1; padding: 14px; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; transition: opacity 0.2s; }
        .btn:active { opacity: 0.8; }
        .btn-cancel { background: var(--border-color); color: var(--text-sub); }
        .btn-confirm { background: var(--main-color); color: white; }

        .edit-controls { display: none; }
        body.is-edit-mode .edit-controls { display: flex; }
        body.is-edit-mode .drag-handle { display: block; color: #ccc; margin-right: 10px; cursor: grab; }
        body.is-edit-mode .chk-wrap { display: none; }
        
        .theme-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
        .theme-circle { width: 40px; height: 40px; border-radius: 50%; cursor: pointer; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .auto-fill-btn { display: block; width: 90%; margin: 20px auto; padding: 15px; background: #6c5ce7; color: white; border: none; border-radius: 12px; font-weight: bold; font-size: 16px; cursor: pointer; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-top-row">
                <h2>ğŸ‘¶ ìœ¡ì•„ ì¤€ë¹„ ë¦¬ìŠ¤íŠ¸</h2>
                <div class="header-actions">
                    <button class="icon-btn" onclick="toggleGlobalSearch()">ğŸ”</button>
                    <button class="icon-btn" onclick="toggleDarkMode()">ğŸŒ“</button>
                    <button class="icon-btn" onclick="openThemeModal()">ğŸ¨</button>
                    <button class="icon-btn" onclick="toggleEditMode()" id="btnEditMode">âœï¸</button>
                </div>
            </div>

            <div class="filter-sort-bar">
                <select class="filter-select" id="filterSelect" onchange="renderApp()">
                    <option value="ALL">ğŸ“‹ ì „ì²´ ë³´ê¸°</option>
                    <option value="UNCHECKED">ğŸ›’ ì•ˆ ì‚° ê²ƒë§Œ</option>
                    <option value="IMPORTANT">â­ ì¤‘ìš” ë¬¼í’ˆ</option>
                    <option value="GIFT">ğŸ ì„ ë¬¼ ë°›ìŒ</option>
                </select>
                <select class="filter-select" id="sortSelect" onchange="renderApp()">
                    <option value="DEFAULT">ğŸ”¢ ê¸°ë³¸ ìˆœì„œ</option>
                    <option value="PRICE_HIGH">ğŸ’° ê°€ê²© ë†’ì€ìˆœ</option>
                    <option value="PRICE_LOW">ğŸ’¸ ê°€ê²© ë‚®ì€ìˆœ</option>
                    <option value="NAME">ê°€ë‚˜ë‹¤ìˆœ</option>
                </select>
            </div>

            <div id="globalSearchBox" class="global-search-box">
                <input type="text" class="global-search-input" id="globalSearchInput" placeholder="ë¬¼í’ˆëª…, ë¸Œëœë“œ ê²€ìƒ‰..." onkeyup="searchGlobal(this.value)">
            </div>

            <div style="text-align: right;"><div class="total-budget-badge">ì´ ì§€ì¶œ <span id="grandTotal">0</span>ì›</div></div>
            <div class="progress-box">
                <div class="progress-circle" id="percentTxt">0%</div>
                <div class="progress-bar-bg"><div class="progress-bar" id="progressBar"></div></div>
                <div class="total-info"><div id="checkCount">0 / 0 ì™„ë£Œ</div></div>
            </div>
        </div>

        <div id="contentArea"></div>
        
        <div id="emptyGuide" style="text-align:center; padding:60px; color:#aaa; display:none; font-size:14px;">
            <p>ì•„ì§ ë“±ë¡ëœ í•­ëª©ì´ ì—†ì–´ìš”.</p>
            <button class="auto-fill-btn" onclick="uploadInitialData()">ğŸ“ ë¬¼í’ˆ ë¦¬ìŠ¤íŠ¸ ìë™ ë“±ë¡í•˜ê¸°</button>
        </div>
    </div>

    <div id="undoBar">
        <span id="undoMsg">ğŸ—‘ï¸ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.</span>
        <span class="undo-btn" onclick="executeUndo()">ì‹¤í–‰ ì·¨ì†Œ</span>
    </div>

    <button class="fab-btn" onclick="openCatModal()">+</button>

    <div id="catModal" class="modal-overlay">
        <div class="modal">
            <h3 id="catModalTitle">ğŸ“‚ ì¹´í…Œê³ ë¦¬ ì„¤ì •</h3>
            <input type="hidden" id="editCatId">
            <div class="input-label">ì•„ì´ì½˜</div>
            <div style="display:flex; gap:10px; margin-bottom:10px;">
                <input type="text" id="catCustomIcon" class="input-field" style="width:60px; text-align:center;" placeholder="ğŸ˜Š" maxlength="2">
                <input type="text" class="input-field" placeholder="ğŸ” ì•„ì´ì½˜ ê²€ìƒ‰ (ì˜ˆ: ë³‘ì›)" onkeyup="filterIcons(this.value, 'catIconGrid')">
            </div>
            <div class="icon-search-box">
                <div class="icon-grid" id="catIconGrid"></div>
            </div>
            <div class="input-group"><input type="text" id="catName" class="input-field" placeholder="ì¹´í…Œê³ ë¦¬ ì´ë¦„"></div>
            <div class="btn-row">
                <button class="btn btn-cancel" onclick="closeModal('catModal')">ì·¨ì†Œ</button>
                <button class="btn btn-confirm" onclick="saveCategory()">ì €ì¥</button>
            </div>
        </div>
    </div>

    <div id="itemModal" class="modal-overlay">
        <div class="modal">
            <h3 id="itemModalTitle">âœ¨ ë¬¼í’ˆ ë“±ë¡</h3>
            <input type="hidden" id="targetCatId"><input type="hidden" id="targetItemId">
            
            <button type="button" class="star-toggle-btn" id="starToggleBtn" onclick="toggleStarScore()">
                ì¤‘ìš”ë„: â­ (í„°ì¹˜í•˜ì—¬ ë³€ê²½)
            </button>
            <input type="hidden" id="itemImportance" value="1">

            <div class="input-group"><input type="text" id="itemName" class="input-field" placeholder="ë¬¼í’ˆëª… (í•„ìˆ˜)"></div>
            
            <div class="input-label">ì•„ì´ì½˜ ì„ íƒ</div>
            <div style="display:flex; gap:10px; margin-bottom:10px;">
                <input type="text" id="itemCustomIcon" class="input-field" style="width:60px; text-align:center;" placeholder="ğŸ¼" maxlength="2">
                <input type="text" class="input-field" placeholder="ğŸ” ì•„ì´ì½˜ ê²€ìƒ‰ (ì˜ˆ: ì –ë³‘)" onkeyup="filterIcons(this.value, 'itemIconGrid')">
            </div>
            <div class="icon-search-box">
                <div class="icon-grid" id="itemIconGrid"></div>
            </div>
            
            <div style="display:flex; gap:10px; margin-bottom:12px;">
                <div style="flex:1"><label class="input-label">ë¸Œëœë“œ</label><input type="text" id="itemBrand" class="input-field"></div>
                <div style="flex:1"><label class="input-label">ëª¨ë¸ëª…</label><input type="text" id="itemModel" class="input-field"></div>
            </div>
            
            <div style="display:flex; gap:10px; margin-bottom:12px;">
                <div style="width: 100px;">
                    <label class="input-label">ìˆ˜ëŸ‰</label>
                    <div class="qty-wrap">
                        <button class="qty-btn" onclick="adjQty(-1)">-</button>
                        <input type="number" id="itemCount" class="input-field" style="text-align:center; padding:5px;" value="1">
                        <button class="qty-btn" onclick="adjQty(1)">+</button>
                    </div>
                </div>
                <div style="flex:1"><label class="input-label">ê°€ê²©</label><input type="text" id="itemPrice" class="input-field" placeholder="ì›"></div>
            </div>

            <div class="input-group"><input type="url" id="itemLink" class="input-field" placeholder="ğŸ”— êµ¬ë§¤ ë§í¬"></div>
            <div class="input-group"><input type="url" id="itemLink2" class="input-field" placeholder="ğŸ”— í›„ê¸°/ë¸”ë¡œê·¸ ë§í¬ (ì˜µì…˜)"></div>
            
            <div class="input-group"><textarea id="itemMemo" class="input-field" placeholder="ë©”ëª¨..."></textarea></div>
            
            <div class="option-row">
                <label class="option-label"><input type="checkbox" id="itemIsGift" class="option-chk"> ğŸ ì„ ë¬¼ ë°›ìŒ (ì§€ì¶œ ì œì™¸)</label>
            </div>
            <div class="option-row">
                <label class="option-label"><input type="checkbox" id="itemIsCarrot" class="option-chk"> ğŸ¥• ë‹¹ê·¼/ì¤‘ê³ </label>
            </div>
            <div class="option-row">
                <label class="option-label"><input type="checkbox" id="itemShowNaver" class="option-chk" checked> ğŸ” ë„¤ì´ë²„ ê²€ìƒ‰ ë²„íŠ¼ í‘œì‹œ</label>
            </div>

            <div class="btn-row">
                <button class="btn btn-cancel" onclick="closeModal('itemModal')">ì·¨ì†Œ</button>
                <button class="btn btn-confirm" onclick="saveItem()">ì €ì¥í•˜ê¸°</button>
            </div>
        </div>
    </div>

    <div id="themeModal" class="modal-overlay">
        <div class="modal" style="text-align:center;">
            <h3>ğŸ¨ í…Œë§ˆ ìƒ‰ìƒ ë³€ê²½</h3>
            <div class="theme-grid">
                <div class="theme-circle" style="background:#FF878D;" onclick="setTheme('#FF878D')"></div>
                <div class="theme-circle" style="background:#4FC3F7;" onclick="setTheme('#4FC3F7')"></div>
                <div class="theme-circle" style="background:#81C784;" onclick="setTheme('#81C784')"></div>
                <div class="theme-circle" style="background:#FFD54F;" onclick="setTheme('#FFD54F')"></div>
                <div class="theme-circle" style="background:#BA68C8;" onclick="setTheme('#BA68C8')"></div>
                <div class="theme-circle" style="background:#90A4AE;" onclick="setTheme('#90A4AE')"></div>
                <div class="theme-circle" style="background:#795548;" onclick="setTheme('#795548')"></div>
                <div class="theme-circle" style="background:#333333;" onclick="setTheme('#333333')"></div>
            </div>
            <br>
            <button class="btn btn-cancel" onclick="closeModal('themeModal')">ë‹«ê¸°</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getDatabase, ref, onValue, push, update, remove } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCovHk7sYoMTkZ8H5RwKjUWMXAqi50l2L-k",
            authDomain: "checklist-3c59d.firebaseapp.com",
            databaseURL: "https://checklist-3c59d-default-rtdb.firebaseio.com",
            projectId: "checklist-3c59d",
            storageBucket: "checklist-3c59d.firebasestorage.app",
            messagingSenderId: "624967682899",
            appId: "1:624967682899:web:a6640fa7b63ee2eab9afa6"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const dbRef = ref(db, 'baby_checklist_v6'); 

        // âœ… ë°©ëŒ€í•œ ì•„ì´ì½˜ DB ë³µêµ¬
        const ICON_DB = [
            {i:'ğŸ‘¶',t:'ì•„ê¸° ë² ì´ë¹„ ì–¼êµ´ ì‹ ìƒì•„'}, {i:'ğŸ‘§',t:'ì—¬ì ì•„ì´ ë”¸'}, {i:'ğŸ§’',t:'ì•„ì´ ì–´ë¦°ì´'}, {i:'ğŸ‘¦',t:'ë‚¨ì ì•„ì´ ì•„ë“¤'}, 
            {i:'ğŸ¤°',t:'ì„ì‹  ì„ì‚°ë¶€ ì—„ë§ˆ'}, {i:'ğŸ¤±',t:'ìˆ˜ìœ  ëª¨ìœ  ì—„ë§ˆ'}, {i:'ğŸ‘¼',t:'ì²œì‚¬ ì•„ê¸°'}, {i:'ğŸ¥',t:'ë³‘ì› ì†Œì•„ê³¼ ì¡°ë¦¬ì›'}, 
            {i:'ğŸš‘',t:'êµ¬ê¸‰ì°¨ ì‘ê¸‰'}, {i:'ğŸ©º',t:'ì²­ì§„ê¸° ì§„ì°° ì˜ì‚¬'}, {i:'ğŸ’Š',t:'ì•½ ì•Œì•½ ì˜ì–‘ì œ'}, {i:'ğŸ’‰',t:'ì£¼ì‚¬ ì˜ˆë°©ì ‘ì¢…'}, 
            {i:'ğŸ©¹',t:'ë°´ë“œ ìƒì²˜ ì—°ê³ '}, {i:'ğŸŒ¡ï¸',t:'ì²´ì˜¨ê³„ ì˜¨ë„ ì—´'}, {i:'ğŸ˜·',t:'ë§ˆìŠ¤í¬ ê°ê¸°'}, {i:'ğŸ¼',t:'ì –ë³‘ ìš°ìœ  ë¶„ìœ '}, 
            {i:'ğŸ¥£',t:'ì´ìœ ì‹ ë°¥ê·¸ë¦‡ ì£½'}, {i:'ğŸ¥„',t:'ìˆŸê°€ë½ ìŠ¤í‘¼'}, {i:'ğŸ¥¡',t:'ë„ì‹œë½'}, {i:'ğŸª',t:'ê³¼ì ê°„ì‹'}, 
            {i:'ğŸ¥›',t:'ìš°ìœ  ì»µ ë¬¼'}, {i:'ğŸ§Š',t:'ì–¼ìŒ'}, {i:'ğŸ¥¢',t:'ì “ê°€ë½'}, {i:'ğŸ½ï¸',t:'ì‹ì‚¬ ì ‘ì‹œ'}, {i:'ğŸ§‚',t:'ì†Œê¸ˆ ì–‘ë…'}, 
            {i:'ğŸ',t:'ì‚¬ê³¼ ê³¼ì¼'}, {i:'ğŸŒ',t:'ë°”ë‚˜ë‚˜'}, {i:'ğŸ¥¦',t:'ë¸Œë¡œì½œë¦¬ ì•¼ì±„'}, {i:'ğŸ¥•',t:'ë‹¹ê·¼'}, {i:'ğŸŒ½',t:'ì˜¥ìˆ˜ìˆ˜'}, 
            {i:'ğŸ¥©',t:'ê³ ê¸° ì´ìœ ì‹'}, {i:'ğŸ—',t:'ì¹˜í‚¨ ë‹­'}, {i:'ğŸ',t:'ë¹µ ì‹ë¹µ'}, {i:'ğŸ¥¨',t:'í”„ë ˆì²¼'}, {i:'ğŸ©',t:'ë„ë„›'}, 
            {i:'ğŸ¦',t:'ì•„ì´ìŠ¤í¬ë¦¼'}, {i:'ğŸ°',t:'ì¼€ì´í¬ ìƒì¼'}, {i:'ğŸ«',t:'ì´ˆì½œë¦¿'}, {i:'ğŸ¬',t:'ì‚¬íƒ•'}, {i:'ğŸ­',t:'ë§‰ëŒ€ì‚¬íƒ•'}, 
            {i:'ğŸ§ƒ',t:'ì£¼ìŠ¤ íŒ©'}, {i:'â˜•',t:'ì»¤í”¼'}, {i:'ğŸ›',t:'ìš•ì¡° ëª©ìš• ì”»ê¸°'}, {i:'ğŸš¿',t:'ìƒ¤ì›Œ ë¬¼'}, {i:'ğŸ§¼',t:'ë¹„ëˆ„ ì„¸ì •ì œ'}, 
            {i:'ğŸ§½',t:'ìŠ¤í€ì§€ ìˆ˜ì„¸ë¯¸'}, {i:'ğŸ§»',t:'íœ´ì§€ ë‘ë£¨ë§ˆë¦¬'}, {i:'ğŸ§´',t:'ë¡œì…˜ ìƒ´í‘¸'}, {i:'ğŸª¥',t:'ì¹«ì†” ì–‘ì¹˜'}, {i:'ğŸš½',t:'ë³€ê¸° í™”ì¥ì‹¤'}, 
            {i:'ğŸ’©',t:'ë˜¥ ê¸°ì €ê·€'}, {i:'ğŸ§¹',t:'ë¹—ìë£¨ ì²­ì†Œ'}, {i:'ğŸ—‘ï¸',t:'ì“°ë ˆê¸°í†µ'}, {i:'ğŸ§º',t:'ë¹¨ë˜ ë°”êµ¬ë‹ˆ ì„¸íƒ'}, {i:'ğŸ‘•',t:'ì˜· í‹°ì…”ì¸  ìƒì˜'}, 
            {i:'ğŸ‘–',t:'ë°”ì§€ í•˜ì˜'}, {i:'ğŸ§¦',t:'ì–‘ë§'}, {i:'ğŸ§¢',t:'ëª¨ì'}, {i:'ğŸ§¤',t:'ì¥ê°‘'}, {i:'ğŸ§£',t:'ëª©ë„ë¦¬ ìŠ¤ì¹´í”„'}, 
            {i:'ğŸ‘Ÿ',t:'ì‹ ë°œ ìš´ë™í™”'}, {i:'ğŸ€',t:'ë¦¬ë³¸ ë¨¸ë¦¬í•€'}, {i:'ğŸ‘—',t:'ì›í”¼ìŠ¤ ë“œë ˆìŠ¤'}, {i:'ğŸ§¥',t:'ì½”íŠ¸ ì í¼ ê²‰ì˜·'}, {i:'ğŸ‘™',t:'ìˆ˜ì˜ë³µ'}, 
            {i:'ğŸ‘š',t:'ë¸”ë¼ìš°ìŠ¤ ì—¬ìì˜·'}, {i:'ğŸ‘”',t:'ë„¥íƒ€ì´ ì •ì¥'}, {i:'ğŸ©³',t:'ë°˜ë°”ì§€ ì†ì˜·'}, {i:'ğŸ‘“',t:'ì•ˆê²½'}, {i:'ğŸ•¶ï¸',t:'ì„ ê¸€ë¼ìŠ¤'}, 
            {i:'ğŸ’',t:'ë°˜ì§€ ë³´ì„'}, {i:'ğŸ’',t:'ê°€ë°© ë°±íŒ©'}, {i:'ğŸ‘œ',t:'í•¸ë“œë°± ê°€ë°©'}, {i:'ğŸ‘›',t:'ì§€ê°‘ ë™ì „'}, {i:'ğŸ›ï¸',t:'ì¹¨ëŒ€ ì  ìˆ˜ë©´'}, 
            {i:'ğŸ›Œ',t:'ìë‹¤ ì´ë¶ˆ'}, {i:'ğŸ§¸',t:'ê³°ì¸í˜• ì¥ë‚œê° ì• ì°©'}, {i:'ğŸª',t:'ì—° ì—°ë‚ ë¦¬ê¸°'}, {i:'âš½',t:'ê³µ ì¶•êµ¬'}, {i:'ğŸ¨',t:'ë¯¸ìˆ  ê·¸ë¦¼ ë¬¼ê°'}, 
            {i:'ğŸ“š',t:'ì±… ë™í™”ì±… ê³µë¶€'}, {i:'ğŸ ',t:'íšŒì „ëª©ë§ˆ ë†€ì´ê³µì›'}, {i:'ğŸ¡',t:'ê´€ëŒì°¨'}, {i:'ğŸˆ',t:'í’ì„  íŒŒí‹°'}, {i:'ğŸ‰',t:'í­ì£½ ì¶•í•˜'}, 
            {i:'ğŸ®',t:'ê²Œì„ ì˜¤ë½'}, {i:'ğŸ²',t:'ì£¼ì‚¬ìœ„'}, {i:'ğŸ§©',t:'í¼ì¦'}, {i:'ğŸ¹',t:'í”¼ì•„ë…¸ ìŒì•…'}, {i:'ğŸ¥',t:'ë¶ ë“œëŸ¼'}, 
            {i:'ğŸ·',t:'ìƒ‰ì†Œí°'}, {i:'ğŸº',t:'ë‚˜íŒ”'}, {i:'ğŸ¸',t:'ê¸°íƒ€'}, {i:'ğŸ»',t:'ë°”ì´ì˜¬ë¦°'}, {i:'ğŸš—',t:'ìë™ì°¨ ì°¨ ì¹´ì‹œíŠ¸'}, 
            {i:'ğŸš•',t:'íƒì‹œ'}, {i:'ğŸšŒ',t:'ë²„ìŠ¤'}, {i:'âœˆï¸',t:'ë¹„í–‰ê¸° ì—¬í–‰'}, {i:'ğŸš²',t:'ìì „ê±°'}, {i:'ğŸ›µ',t:'ì˜¤í† ë°”ì´'}, 
            {i:'ğŸ›´',t:'í‚¥ë³´ë“œ'}, {i:'ğŸš¤',t:'ë³´íŠ¸ ë°°'}, {i:'ğŸš€',t:'ë¡œì¼“ ìš°ì£¼'}, {i:'ğŸ›’',t:'ì¹´íŠ¸ ì‡¼í•‘ ë§ˆíŠ¸'}, {i:'ğŸ›ï¸',t:'ì‡¼í•‘ë°± ì„ ë¬¼'}, 
            {i:'ğŸ“·',t:'ì¹´ë©”ë¼ ì‚¬ì§„'}, {i:'ğŸ“¹',t:'ë¹„ë””ì˜¤ ì˜ìƒ'}, {i:'ğŸ“±',t:'í•¸ë“œí° ìŠ¤ë§ˆíŠ¸í°'}, {i:'ğŸ’»',t:'ë…¸íŠ¸ë¶ ì»´í“¨í„°'}, {i:'ğŸ”‹',t:'ë°°í„°ë¦¬ ê±´ì „ì§€'}, 
            {i:'ğŸ”Œ',t:'í”ŒëŸ¬ê·¸ ì „ê¸° ë©€í‹°íƒ­'}, {i:'ğŸ ',t:'ì§‘ í™ˆ'}, {i:'ğŸ›‹ï¸',t:'ì†ŒíŒŒ ê°€êµ¬'}, {i:'ğŸª‘',t:'ì˜ì'}, {i:'ğŸšª',t:'ë¬¸'}, 
            {i:'ğŸ”‘',t:'ì—´ì‡  í‚¤'}, {i:'ğŸ–¼ï¸',t:'ì•¡ì ì‚¬ì§„'}, {i:'ğŸª´',t:'í™”ë¶„ ì‹ë¬¼'}, {i:'ğŸŒµ',t:'ì„ ì¸ì¥'}, {i:'ğŸ’',t:'ê½ƒë‹¤ë°œ'}, 
            {i:'ğŸ•°ï¸',t:'ì‹œê³„ ì‹œê°„'}, {i:'ğŸ’¡',t:'ì „êµ¬ ë¶ˆ ë¹›'}, {i:'ğŸ•¯ï¸',t:'ì–‘ì´ˆ ìº”ë“¤'}, {i:'ğŸ“¦',t:'ìƒì íƒë°° ë°•ìŠ¤'}, {i:'âœ‰ï¸',t:'í¸ì§€ ë´‰íˆ¬'}, 
            {i:'âœ‚ï¸',t:'ê°€ìœ„'}, {i:'ğŸ“Œ',t:'í•€ ì••ì •'}, {i:'ğŸ“',t:'í´ë¦½'}, {i:'ğŸ“',t:'ì ì¤„ì'}, {i:'â˜€ï¸',t:'í•´ ë‚ ì”¨ ë§‘ìŒ'}, 
            {i:'â˜ï¸',t:'êµ¬ë¦„ íë¦¼'}, {i:'â˜”',t:'ë¹„ ìš°ì‚°'}, {i:'â„ï¸',t:'ëˆˆ ê²¨ìš¸'}, {i:'âš¡',t:'ë²ˆê°œ ì „ê¸°'}, {i:'ğŸŒˆ',t:'ë¬´ì§€ê°œ'}, 
            {i:'â­',t:'ë³„ ìŠ¤íƒ€'}, {i:'ğŸŒ™',t:'ë‹¬ ë°¤'}, {i:'ğŸ”¥',t:'ë¶ˆ ëœ¨ê±°ì›€'}, {i:'ğŸ’§',t:'ë¬¼ ë°©ìš¸ ìŠµê¸°'}, {i:'â¤ï¸',t:'í•˜íŠ¸ ì‚¬ë‘'}, 
            {i:'ğŸ§¡',t:'ì£¼í™©í•˜íŠ¸'}, {i:'ğŸ’›',t:'ë…¸ë‘í•˜íŠ¸'}, {i:'ğŸ’š',t:'ì´ˆë¡í•˜íŠ¸'}, {i:'ğŸ’™',t:'íŒŒë‘í•˜íŠ¸'}, {i:'ğŸ’œ',t:'ë³´ë¼í•˜íŠ¸'}, 
            {i:'ğŸ–¤',t:'ê²€ì •í•˜íŠ¸'}, {i:'ğŸ¤',t:'í°ìƒ‰í•˜íŠ¸'}, {i:'ğŸ¤',t:'ê°ˆìƒ‰í•˜íŠ¸'}, {i:'ğŸ’”',t:'ê¹¨ì§„í•˜íŠ¸'}, {i:'ğŸ’¯',t:'ë°±ì  ë§Œì '}, 
            {i:'âœ…',t:'ì²´í¬ ì™„ë£Œ'}, {i:'âŒ',t:'ì—‘ìŠ¤ ì·¨ì†Œ'}, {i:'â“',t:'ë¬¼ìŒí‘œ ì§ˆë¬¸'}, {i:'â—ï¸',t:'ëŠë‚Œí‘œ ì¤‘ìš”'}, {i:'ğŸ’°',t:'ëˆ ìê¸ˆ ì˜ˆì‚°'}, 
            {i:'ğŸ’³',t:'ì¹´ë“œ ê²°ì œ'}, {i:'ğŸ“…',t:'ë‹¬ë ¥ ë‚ ì§œ ë””ë°ì´'}, {i:'ğŸ“',t:'ë©”ëª¨ ê¸°ë¡'}, {i:'ğŸ',t:'ì„ ë¬¼ ë°•ìŠ¤'}, {i:'ğŸ””',t:'ì¢… ì•Œë¦¼'}, 
            {i:'ğŸµ',t:'ìŒí‘œ ë…¸ë˜'}, {i:'ğŸ¶',t:'ìŒì•…'}, {i:'ğŸ¶',t:'ê°•ì•„ì§€ ê°œ'}, {i:'ğŸ±',t:'ê³ ì–‘ì´'}, {i:'ğŸ­',t:'ì¥'}, 
            {i:'ğŸ¹',t:'í–„ìŠ¤í„°'}, {i:'ğŸ°',t:'í† ë¼'}, {i:'ğŸ¦Š',t:'ì—¬ìš°'}, {i:'ğŸ»',t:'ê³°'}, {i:'ğŸ¼',t:'íŒë‹¤'}, 
            {i:'ğŸ¯',t:'í˜¸ë‘ì´'}, {i:'ğŸ¦',t:'ì‚¬ì'}, {i:'ğŸ®',t:'ì†Œ'}, {i:'ğŸ·',t:'ë¼ì§€'}, {i:'ğŸ¸',t:'ê°œêµ¬ë¦¬'}, 
            {i:'ğŸµ',t:'ì›ìˆ­ì´'}, {i:'ğŸ”',t:'ë‹­'}, {i:'ğŸ§',t:'í­ê·„'}
        ];
        
        let currentData = {};
        let isEditMode = false;
        // âœ… ì‹¤í–‰ì·¨ì†Œ ë³€ìˆ˜ (ìˆ˜ì • ë° ì‚­ì œ ëª¨ë‘ ì €ì¥)
        let lastAction = null; 
        let undoTimer = null;

        const savedTheme = localStorage.getItem('appTheme') || '#FF878D';
        document.documentElement.style.setProperty('--main-color', savedTheme);
        if(localStorage.getItem('darkMode') === 'true') document.body.setAttribute('data-theme', 'dark');

        onValue(dbRef, (snapshot) => {
            currentData = snapshot.val() || {};
            renderApp();
        });

        window.renderApp = () => {
            const data = currentData;
            const contentArea = document.getElementById('contentArea');
            contentArea.innerHTML = '';
            
            let totalCount = 0; let checkedCount = 0; let grandTotalPrice = 0;
            const isEmpty = Object.keys(data).length === 0;
            document.getElementById('emptyGuide').style.display = isEmpty ? 'block' : 'none';

            const filterVal = document.getElementById('filterSelect').value;
            const sortVal = document.getElementById('sortSelect').value;

            let catArray = Object.keys(data).map(key => ({...data[key], id: key}));
            catArray.sort((a, b) => (a.order || 0) - (b.order || 0));

            catArray.forEach(cat => {
                const itemsObj = cat.items || {};
                let itemsArray = Object.keys(itemsObj).map(key => ({...itemsObj[key], id: key}));

                if(sortVal === 'PRICE_HIGH') itemsArray.sort((a,b) => (Number(b.price)||0) - (Number(a.price)||0));
                else if(sortVal === 'PRICE_LOW') itemsArray.sort((a,b) => (Number(a.price)||0) - (Number(b.price)||0));
                else if(sortVal === 'NAME') itemsArray.sort((a,b) => a.name.localeCompare(b.name));
                else itemsArray.sort((a, b) => (a.order || 0) - (b.order || 0));

                let catTotalPrice = 0;
                let visibleItemsHTML = '';
                let hasVisibleItem = false;

                itemsArray.forEach(item => {
                    if(filterVal === 'UNCHECKED' && item.checked) return;
                    if(filterVal === 'IMPORTANT' && (item.importance || 1) < 3) return;
                    if(filterVal === 'GIFT' && !item.isGift) return;

                    hasVisibleItem = true;
                    totalCount++;
                    if(item.checked) checkedCount++;
                    
                    const price = parseInt((item.price || '0').toString().replace(/,/g, '')) || 0;
                    const count = parseInt(item.count) || 1;
                    
                    if(!item.isGift) {
                        catTotalPrice += (price * count);
                        grandTotalPrice += (price * count);
                    }

                    let tags = '';
                    const importance = item.importance || 1;
                    const starStr = "â­".repeat(importance);
                    
                    if(item.brand) tags += `<span class="tag brand">${item.brand}</span> `;
                    if(item.isGift) tags += `<span class="tag gift">ğŸ ì„ ë¬¼</span> `;
                    else if(item.price) tags += `<span class="tag price">${Number(price).toLocaleString()}ì›</span> `;
                    
                    if(item.isCarrot) tags += `<span class="tag carrot">ğŸ¥• ë‹¹ê·¼</span> `;
                    if(item.link) tags += `<a href="${item.link}" target="_blank" class="link-btn">ğŸ”— êµ¬ë§¤</a>`;
                    if(item.link2) tags += `<a href="${item.link2}" target="_blank" class="link-btn review">ğŸ”— í›„ê¸°</a>`;
                    
                    if(item.showNaver !== false) {
                        const query = [item.brand, item.model, item.name].filter(Boolean).join(' ');
                        tags += `<a href="https://search.shopping.naver.com/search/all?query=${encodeURIComponent(query)}" target="_blank" class="naver-btn">N ê²€ìƒ‰</a>`;
                    }

                    const memoHTML = item.memo ? `<div class="item-memo">${item.memo}</div>` : '';

                    // âœ… í•µì‹¬: item-content í´ë¦­ ì‹œ toggleCheck í˜¸ì¶œ (ìˆ˜ì •X)
                    visibleItemsHTML += `
                    <li class="item ${item.checked ? 'completed' : ''}" data-id="${item.id}">
                        <div class="item-top">
                            <div class="drag-handle edit-controls">â˜°</div>
                            <div class="chk-wrap">
                                <input type="checkbox" ${item.checked ? 'checked' : ''} onchange="window.toggleCheck('${cat.id}', '${item.id}', this.checked)">
                                <div class="chk-box"></div>
                            </div>
                            <div class="item-icon">${item.icon || 'ğŸ‘¶'}</div>
                            <div class="item-content" onclick="window.toggleCheck('${cat.id}', '${item.id}', ${!item.checked})">
                                <div class="item-header-row">
                                    <span class="item-name">${item.name}</span>
                                    <span class="star-rating">${starStr}</span>
                                    ${count > 1 ? `<span style="font-size:11px; color:#888;">x${count}</span>` : ''}
                                </div>
                                <div class="tag-row">${tags}</div>
                                ${memoHTML}
                            </div>
                            <div class="item-actions">
                                <button class="action-btn edit" onclick="event.stopPropagation(); window.openEditItem('${cat.id}', '${item.id}')">
                                    <svg viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0115.75 21H5.25A2.25 2.25 0 013 18.75V8.25A2.25 2.25 0 015.25 6H10"></path></svg>
                                </button>
                                <button class="action-btn del" onclick="event.stopPropagation(); window.deleteItemWithUndo('${cat.id}', '${item.id}')">
                                    <svg viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0"></path></svg>
                                </button>
                            </div>
                        </div>
                    </li>`;
                });

                if(hasVisibleItem || filterVal === 'ALL') {
                    const catDiv = document.createElement('div');
                    catDiv.className = 'category-card';
                    catDiv.setAttribute('data-id', cat.id);
                    catDiv.innerHTML = `
                        <div class="cat-header" onclick="toggleCategory(this)">
                            <div class="cat-left">
                                <div class="drag-handle edit-controls">â˜°</div>
                                <div class="cat-icon">${cat.icon}</div>
                                <div>
                                    <span class="cat-title">${cat.name}</span>
                                    <span class="cat-sum">(${catTotalPrice.toLocaleString()}ì›)</span>
                                </div>
                            </div>
                            <div style="display:flex; align-items:center; gap:10px;">
                                <div class="item-actions">
                                    <button class="action-btn edit" onclick="event.stopPropagation(); window.openEditCategory('${cat.id}')">
                                        <svg viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0115.75 21H5.25A2.25 2.25 0 013 18.75V8.25A2.25 2.25 0 015.25 6H10"></path></svg>
                                    </button>
                                    <button class="action-btn del" onclick="event.stopPropagation(); window.deleteCategory('${cat.id}')">
                                        <svg viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0"></path></svg>
                                    </button>
                                </div>
                                <span class="chevron">â–¼</span>
                            </div>
                        </div>
                        <ul class="item-list" id="list-${cat.id}" data-cat-id="${cat.id}">${visibleItemsHTML}</ul>
                        <button class="btn-add-item" onclick="window.openAddItem('${cat.id}')">+ ë¬¼í’ˆ ì¶”ê°€í•˜ê¸°</button>
                    `;
                    contentArea.appendChild(catDiv);
                    if(filterVal === 'ALL' && sortVal === 'DEFAULT') {
                        initItemSortable(catDiv.querySelector(`#list-${cat.id}`), cat.id);
                    }
                }
            });

            if(filterVal === 'ALL' && sortVal === 'DEFAULT') initCategorySortable();

            const percent = totalCount === 0 ? 0 : Math.round((checkedCount / totalCount) * 100);
            document.getElementById('progressBar').style.width = `${percent}%`;
            document.getElementById('percentTxt').innerText = `${percent}%`;
            document.getElementById('checkCount').innerText = `${checkedCount} / ${totalCount} ì™„ë£Œ`;
            document.getElementById('grandTotal').innerText = grandTotalPrice.toLocaleString();
            
            document.body.classList.toggle('is-edit-mode', isEditMode);
        };

        window.toggleCategory = (header) => { header.parentElement.classList.toggle('collapsed'); };
        window.toggleDarkMode = () => {
            const isDark = document.body.getAttribute('data-theme') === 'dark';
            document.body.setAttribute('data-theme', isDark ? 'light' : 'dark');
            localStorage.setItem('darkMode', !isDark);
        };
        window.openThemeModal = () => document.getElementById('themeModal').style.display = 'flex';
        window.setTheme = (color) => {
            document.documentElement.style.setProperty('--main-color', color);
            localStorage.setItem('appTheme', color);
            window.closeModal('themeModal');
        };

        // âœ… ì‹¤í–‰ ì·¨ì†Œ ë° ì‚­ì œ ë¡œì§ (ìì²´ êµ¬í˜„)
        function notifyUndo(msg) {
            const bar = document.getElementById('undoBar');
            document.getElementById('undoMsg').innerText = msg;
            bar.classList.add('show');
            if(undoTimer) clearTimeout(undoTimer);
            undoTimer = setTimeout(() => { bar.classList.remove('show'); lastAction = null; }, 4000);
        }

        window.deleteItemWithUndo = (catId, itemId) => {
            const itemData = currentData[catId].items[itemId];
            if(confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                // ì´ì „ ë°ì´í„°ë¥¼ lastActionì— ì €ì¥
                lastAction = { type: 'item', path: `baby_checklist_v6/${catId}/items/${itemId}`, data: itemData };
                remove(ref(db, lastAction.path));
                notifyUndo("ğŸ—‘ï¸ í•­ëª©ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
            }
        };
        window.deleteCategory = (id) => {
            if(confirm('ì¹´í…Œê³ ë¦¬ê°€ ì‚­ì œë©ë‹ˆë‹¤.')) {
                lastAction = { type: 'cat', path: `baby_checklist_v6/${id}`, data: currentData[id] };
                remove(ref(db, lastAction.path));
                notifyUndo("ğŸ—‘ï¸ ì¹´í…Œê³ ë¦¬ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
            }
        };
        window.executeUndo = () => {
            if(lastAction) update(ref(db), { [lastAction.path]: lastAction.data });
            document.getElementById('undoBar').classList.remove('show');
        };

        window.toggleStarScore = () => {
            let current = parseInt(document.getElementById('itemImportance').value) || 1;
            current++;
            if(current > 3) current = 1;
            document.getElementById('itemImportance').value = current;
            document.getElementById('starToggleBtn').innerText = `ì¤‘ìš”ë„: ${"â­".repeat(current)} (í„°ì¹˜í•˜ì—¬ ë³€ê²½)`;
        };

        window.adjQty = (delta) => {
            const input = document.getElementById('itemCount');
            let val = parseInt(input.value) || 1;
            val = Math.max(1, val + delta);
            input.value = val;
        };

        window.toggleEditMode = (force) => {
            isEditMode = (typeof force === 'boolean') ? force : !isEditMode;
            document.getElementById('btnEditMode').innerText = isEditMode ? 'âœ…' : 'âœï¸';
            renderApp();
        };
        
        window.openAddItem = (catId) => {
            document.getElementById('itemModal').style.display = 'flex';
            document.getElementById('itemModalTitle').innerText = 'âœ¨ ë¬¼í’ˆ ë“±ë¡';
            document.getElementById('targetCatId').value = catId;
            document.getElementById('targetItemId').value = '';
            document.getElementById('itemName').value = '';
            document.getElementById('itemBrand').value = '';
            document.getElementById('itemModel').value = '';
            document.getElementById('itemMemo').value = '';
            document.getElementById('itemCount').value = '1';
            document.getElementById('itemPrice').value = '';
            document.getElementById('itemLink').value = '';
            document.getElementById('itemLink2').value = '';
            document.getElementById('itemIsGift').checked = false;
            document.getElementById('itemIsCarrot').checked = false;
            document.getElementById('itemShowNaver').checked = true;
            document.getElementById('itemImportance').value = 1;
            document.getElementById('starToggleBtn').innerText = `ì¤‘ìš”ë„: â­ (í„°ì¹˜í•˜ì—¬ ë³€ê²½)`;
            document.getElementById('itemCustomIcon').value = ''; 
            selectedIcon = 'ğŸ‘¶';
            renderIcons(iconDB, 'itemIconGrid');
        };

        // âœ… ìˆ˜ì • ì‹œì—ë„ ì‹¤í–‰ ì·¨ì†Œ ê°€ëŠ¥í•˜ë„ë¡ ì €ì¥
        window.saveItem = () => {
            const catId = document.getElementById('targetCatId').value;
            const itemId = document.getElementById('targetItemId').value;
            
            const newData = {
                name: document.getElementById('itemName').value,
                brand: document.getElementById('itemBrand').value,
                model: document.getElementById('itemModel').value,
                memo: document.getElementById('itemMemo').value,
                count: document.getElementById('itemCount').value,
                price: document.getElementById('itemPrice').value,
                link: document.getElementById('itemLink').value,
                link2: document.getElementById('itemLink2').value,
                importance: parseInt(document.getElementById('itemImportance').value),
                isGift: document.getElementById('itemIsGift').checked,
                isCarrot: document.getElementById('itemIsCarrot').checked,
                showNaver: document.getElementById('itemShowNaver').checked,
                icon: "ğŸ‘¶",
                checked: false, 
                order: 999
            };
            
            const customIcon = document.getElementById('itemCustomIcon')?.value;
            if(customIcon) newData.icon = customIcon;
            else newData.icon = document.querySelector('#itemIconGrid .selected')?.innerText || 'ğŸ‘¶';

            if(!newData.name) return alert('ì´ë¦„ ì…ë ¥!');

            if(itemId) {
                const existing = currentData[catId].items[itemId];
                
                // ğŸ”¹ ìˆ˜ì • ì „ ìƒíƒœ ì €ì¥ (ì‹¤í–‰ì·¨ì†Œìš©)
                lastAction = { type: 'edit', path: `baby_checklist_v6/${catId}/items/${itemId}`, data: existing };
                notifyUndo("âœï¸ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤. (ë˜ëŒë¦¬ê¸° ê°€ëŠ¥)");

                newData.checked = existing.checked;
                newData.order = (existing.order !== undefined) ? existing.order : 999;
                update(ref(db, `baby_checklist_v6/${catId}/items/${itemId}`), newData);
            } else {
                push(ref(db, `baby_checklist_v6/${catId}/items`), newData);
            }
            window.closeModal('itemModal');
        };

        window.toggleCheck=(c,i,v)=>update(ref(db,`baby_checklist_v6/${c}/items/${i}`),{checked:v});
        window.closeModal=(id)=>document.getElementById(id).style.display='none';
        
        window.openEditCategory=(id)=>{const c=currentData[id];if(!c)return;document.getElementById('catModal').style.display='flex';document.getElementById('editCatId').value=id;document.getElementById('catName').value=c.name;document.getElementById('catCustomIcon').value='';selectedIcon=c.icon||'ğŸ‘¶';renderIcons(iconDB,'catIconGrid');};
        window.saveCategory=()=>{const n=document.getElementById('catName').value;const i=document.getElementById('catCustomIcon').value||document.querySelector('#catIconGrid .selected')?.innerText||'ğŸ‘¶';const id=document.getElementById('editCatId').value;if(!n)return;if(id)update(ref(db,`baby_checklist_v6/${id}`),{name:n,icon:i});else push(ref(db,'baby_checklist_v6'),{name:n,icon:i,order:999});window.closeModal('catModal');};
        
        window.openEditItem=(cId,iId)=>{const i=currentData[cId].items[iId];if(!i)return;document.getElementById('itemModal').style.display='flex';document.getElementById('targetCatId').value=cId;document.getElementById('targetItemId').value=iId;document.getElementById('itemName').value=i.name;document.getElementById('itemBrand').value=i.brand||'';document.getElementById('itemModel').value=i.model||'';document.getElementById('itemPrice').value=i.price||'';document.getElementById('itemCount').value=i.count||1;document.getElementById('itemLink').value=i.link||'';document.getElementById('itemLink2').value=i.link2||'';document.getElementById('itemMemo').value=i.memo||'';document.getElementById('itemIsGift').checked=i.isGift||false;document.getElementById('itemIsCarrot').checked=i.isCarrot||false;document.getElementById('itemShowNaver').checked=(i.showNaver!==false);document.getElementById('itemCustomIcon').value='';
        const score = i.importance || 1;
        document.getElementById('itemImportance').value = score;
        document.getElementById('starToggleBtn').innerText = `ì¤‘ìš”ë„: ${"â­".repeat(score)} (í„°ì¹˜í•˜ì—¬ ë³€ê²½)`;
        selectedIcon = i.icon || 'ğŸ‘¶';
        renderIcons(iconDB,'itemIconGrid');};
        
        window.openCatModal = () => { document.getElementById('catModal').style.display = 'flex'; document.getElementById('catModalTitle').innerText = 'ğŸ“‚ ì¹´í…Œê³ ë¦¬ ì¶”ê°€'; document.getElementById('editCatId').value = ''; document.getElementById('catName').value = ''; document.getElementById('catCustomIcon').value = ''; selectedIcon = 'ğŸ‘¶'; renderIcons(iconDB, 'catIconGrid'); };

        window.filterIcons=(k,t)=>{const g=document.getElementById(t);g.innerHTML='';iconDB.filter(i=>!k||i.t.includes(k)).forEach(i=>{const e=document.createElement('div');e.className='icon-opt';e.innerText=i.i;e.onclick=()=>{Array.from(g.children).forEach(c=>c.classList.remove('selected'));e.classList.add('selected');selectedIcon=i.i;};g.appendChild(e);});};
        function renderIcons(l,t){window.filterIcons('',t);}

        function initCategorySortable(){const el=document.getElementById('contentArea');new Sortable(el,{handle:'.drag-handle',animation:150,disabled:!isEditMode,onEnd:e=>{updateOrder(e.to, 'category')}});}
        function initItemSortable(el,cId){new Sortable(el,{handle:'.drag-handle',animation:150,disabled:!isEditMode,onEnd:e=>{updateOrder(e.to, 'item', cId)}});}
        function updateOrder(el,type,cId){const ids=Array.from(el.children).map(c=>c.getAttribute('data-id'));const updates={};ids.forEach((id,idx)=>{if(type==='category')updates[`baby_checklist_v6/${id}/order`]=idx;else updates[`baby_checklist_v6/${cId}/items/${id}/order`]=idx;});update(ref(db),updates);}

        window.toggleGlobalSearch=()=>{const b=document.getElementById('globalSearchBox');b.style.display=b.style.display==='block'?'none':'block';if(b.style.display==='block')document.getElementById('globalSearchInput').focus();};
        window.searchGlobal=(k)=>{k=k.toLowerCase();document.querySelectorAll('.category-card').forEach(c=>{let v=false;c.querySelectorAll('.item').forEach(i=>{if(i.innerText.toLowerCase().includes(k)){i.classList.remove('hidden');v=true;}else i.classList.add('hidden');});c.style.display=v?'block':'none';});};
        
        window.uploadInitialData = async () => {
            if(!confirm('ë¦¬ìŠ¤íŠ¸ë¥¼ ë“±ë¡í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            const d=[{name:"ì¶œì‚°ê°€ë°©",icon:"ğŸ¥",items:[{name:"ì‚°ëª¨ìˆ˜ì²©",icon:"ğŸ“’",memo:"ë³‘ì› ê°ˆ ë•Œ í•„ìˆ˜"},{name:"ì‹ ë¶„ì¦",icon:"ğŸ’³"},{name:"ì¶©ì „ê¸°",icon:"âš¡"}]},{name:"ìˆ˜ìœ ìš©í’ˆ",icon:"ğŸ¼",items:[{name:"ì –ë³‘",icon:"ğŸ¼"},{name:"ë¶„ìœ ",icon:"ğŸ¥«"},{name:"ì –ë³‘ì†”",icon:"ğŸ–Œï¸"}]},{name:"ìœ„ìƒìš©í’ˆ",icon:"ğŸ©¹",items:[{name:"ì²´ì˜¨ê³„",icon:"ğŸŒ¡ï¸",memo:"ë¸Œë¼ìš´ ì¶”ì²œ"},{name:"ì†ìˆ˜ê±´",icon:"ğŸ§£",count:30},{name:"ê¸°ì €ê·€",icon:"ğŸ©²"}]}];
            for(const c of d){ const r=await push(ref(db,'baby_checklist_v6'),{name:c.name,icon:c.icon,order:999}); for(const i of c.items) await push(ref(db,`baby_checklist_v6/${r.key}/items`),{...i,checked:false}); }
            alert("ì™„ë£Œ!");
        };
    </script>
</body>
</html>
