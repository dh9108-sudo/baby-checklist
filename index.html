<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ğŸ‘¶ ë² ì´ë¹„ ì²´í¬ë¦¬ìŠ¤íŠ¸ (V29)</title>
    <link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        :root {
            /* ğŸ¨ í”„ë¦¬ë¯¸ì—„ ì»¬ëŸ¬ & ê·¸ë¦¼ì */
            --main: #FF878D;
            --bg: #F5F6F8;
            --card: #FFFFFF;
            --text: #333333;
            --sub: #888888;
            --line: #EFEFEF;
            --shadow: 0 4px 20px rgba(0,0,0,0.06);
        }
        
        [data-theme="dark"] {
            --bg: #121212; --card: #1E1E1E; --text: #EEE; --sub: #AAA; --line: #333;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
        body { 
            font-family: 'Pretendard', sans-serif; background-color: var(--bg); color: var(--text); 
            margin: 0; padding: 0; padding-bottom: 120px; transition: 0.3s; 
        }
        .container { max-width: 500px; margin: 0 auto; }

        /* í—¤ë” */
        .header { 
            background: linear-gradient(135deg, #FF9A9E, #FECFEF); 
            padding: 20px 20px 25px; color: white; border-radius: 0 0 25px 25px; 
            box-shadow: 0 4px 15px rgba(255, 154, 158, 0.4); 
            position: sticky; top: 0; z-index: 100;
        }
        .header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .title { font-size: 20px; font-weight: 800; }
        
        .icon-btn { 
            background: rgba(255,255,255,0.25); border: none; color: white; 
            width: 36px; height: 36px; border-radius: 50%; font-size: 16px; 
            cursor: pointer; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(4px); 
        }

        /* í†µê³„ ë°•ìŠ¤ */
        .stats-box { 
            background: rgba(255,255,255,0.2); backdrop-filter: blur(5px); 
            padding: 15px; border-radius: 16px; display: flex; align-items: center; justify-content: space-between; 
        }
        .progress-bg { flex: 1; height: 6px; background: rgba(255,255,255,0.5); border-radius: 3px; margin: 0 15px; overflow: hidden; }
        .progress-bar { height: 100%; background: white; width: 0%; transition: width 0.5s; }
        
        /* ğŸ“‚ ì¹´í…Œê³ ë¦¬ ì¹´ë“œ */
        .cat-card { 
            background: var(--card); margin: 20px; border-radius: 20px; 
            box-shadow: var(--shadow); overflow: hidden; transition: 0.2s;
        }
        .cat-card.collapsed .item-list, .cat-card.collapsed .btn-add { display: none; }
        
        .cat-header { 
            padding: 18px 20px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; 
            border-bottom: 1px solid var(--line);
        }
        .cat-left { display: flex; align-items: center; gap: 12px; }
        .cat-icon { font-size: 20px; width: 32px; text-align: center; }
        .cat-name { font-size: 16px; font-weight: 700; }
        .cat-total { font-size: 12px; color: var(--sub); font-weight: 500; margin-left: 5px; }
        .chevron { color: #ccc; font-size: 12px; transition: 0.3s; }
        .cat-card.collapsed .chevron { transform: rotate(-90deg); }

        /* ë¦¬ìŠ¤íŠ¸ ì•„ì´í…œ */
        .item-list { list-style: none; padding: 0; margin: 0; }
        .item { 
            padding: 16px 20px; border-bottom: 1px solid var(--line); background: var(--card); 
            display: flex; align-items: flex-start; gap: 12px; transition: background 0.1s;
        }
        /* âœ… í´ë¦­ ì‹œ ë°˜ì‘ íš¨ê³¼ (ìˆ˜ì •ì°½ ì•ˆ ëœ¸) */
        .item:active { background-color: #fafafa; } 
        .item.completed .item-name { text-decoration: line-through; color: #aaa; }
        .item.hidden { display: none; }

        /* ì²´í¬ë°•ìŠ¤ */
        .chk-wrap { width: 22px; height: 22px; position: relative; flex-shrink: 0; margin-top: 2px;}
        .chk-input { position: absolute; width: 100%; height: 100%; opacity: 0; cursor: pointer; z-index: 2; }
        .chk-box { width: 100%; height: 100%; border: 2px solid #ddd; border-radius: 6px; transition: 0.2s; display: flex; align-items: center; justify-content: center; }
        .chk-input:checked + .chk-box { background: var(--main); border-color: var(--main); }
        .chk-input:checked + .chk-box::after { content: 'âœ”'; color: white; font-size: 12px; }

        /* í…ìŠ¤íŠ¸ ì˜ì—­ (í´ë¦­ ì‹œ ì²´í¬ í† ê¸€) */
        .item-center { flex: 1; cursor: pointer; } 
        .item-row { display: flex; align-items: center; gap: 6px; margin-bottom: 4px; }
        .item-name { font-size: 15px; font-weight: 600; color: var(--text); }
        .star { font-size: 12px; color: #FFC107; font-weight: bold; }
        
        .item-memo { font-size: 12px; color: #888; background: var(--bg); padding: 4px 8px; border-radius: 6px; display: inline-block; margin-top: 6px; }

        /* íƒœê·¸ */
        .tags { display: flex; gap: 5px; flex-wrap: wrap; margin-top: 4px; }
        .tag { padding: 2px 6px; border-radius: 4px; font-size: 11px; color: #666; background: var(--bg); }
        .tag.price { color: #FF5252; background: #FFF0F0; font-weight: 700; }
        .tag.gift { color: #9C27B0; background: #F3E5F5; font-weight: 700; }

        /* âœ… ì„¸ë ¨ëœ SVG ì•„ì´ì½˜ ë²„íŠ¼ (ìˆ˜ì •/ì‚­ì œ) */
        .item-right { display: flex; gap: 8px; align-items: flex-start; margin-left: 5px; }
        .action-btn { 
            width: 28px; height: 28px; border: none; background: transparent; 
            border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center;
        }
        .action-btn:active { background: #eee; }
        .action-btn svg { width: 18px; height: 18px; stroke: #999; stroke-width: 1.8; fill: none; stroke-linecap: round; stroke-linejoin: round; }
        
        /* ìƒ‰ìƒ í¬ì¸íŠ¸ */
        .action-btn.edit svg { stroke: var(--main); }
        .action-btn.del svg { stroke: #FF5252; }

        /* ë¬¼í’ˆ ì¶”ê°€ ë²„íŠ¼ */
        .btn-add { 
            width: calc(100% - 40px); margin: 15px 20px 20px; padding: 14px; 
            background: #FFF0F5; color: var(--main); border: none; border-radius: 14px; 
            font-weight: 800; font-size: 14px; cursor: pointer; 
        }
        .btn-add:active { background: #ffe0e6; }

        /* FAB */
        .fab { 
            position: fixed; bottom: 30px; right: 25px; 
            background: var(--main); color: white; width: 55px; height: 55px; border-radius: 50%; 
            display: flex; align-items: center; justify-content: center; font-size: 28px; 
            box-shadow: 0 4px 15px rgba(255, 135, 141, 0.4); border: none; cursor: pointer; z-index: 90; 
        }

        /* âœ… [ì‹¤í–‰ ì·¨ì†Œ] ìì²´ êµ¬í˜„ (ê²€ì€ìƒ‰ ì•Œë¦¼ë°”) */
        #undoToast {
            position: fixed; bottom: -80px; left: 50%; transform: translateX(-50%);
            background: #333; color: white; padding: 14px 24px; border-radius: 30px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.3); z-index: 200;
            display: flex; align-items: center; gap: 20px; font-size: 14px;
            transition: bottom 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            width: 90%; max-width: 350px; justify-content: space-between;
        }
        #undoToast.show { bottom: 30px; }
        .undo-btn { color: #FF878D; font-weight: 800; cursor: pointer; text-transform: uppercase; }

        /* ëª¨ë‹¬ */
        .modal-bg { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 200; align-items: center; justify-content: center; }
        .modal { background: var(--card); width: 90%; max-width: 400px; padding: 25px; border-radius: 20px; max-height: 90vh; overflow-y: auto; }
        .inp { width: 100%; padding: 14px; border: 1px solid #eee; border-radius: 12px; margin-bottom: 12px; background: var(--bg); font-size: 15px; outline: none; }
        .btn-row { display: flex; gap: 10px; margin-top: 10px; }
        .btn { flex: 1; padding: 15px; border: none; border-radius: 12px; font-weight: 700; cursor: pointer; font-size: 15px; }
        .btn-gray { background: #eee; color: #555; }
        .btn-main { background: var(--main); color: white; }

        .icon-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 5px; max-height: 150px; overflow-y: auto; margin-bottom: 15px; }
        .icon-opt { font-size: 22px; text-align: center; padding: 10px; border-radius: 8px; cursor: pointer; }
        .icon-opt.selected { background: #FFF0F5; border: 1px solid var(--main); }

        .drag-handle { display: none; color: #ccc; margin-right: 10px; cursor: grab; font-size: 20px; }
        body.is-edit-mode .drag-handle { display: block; }
        body.is-edit-mode .chk-wrap { display: none; }
        body.is-edit-mode .item-right { display: none; } /* í¸ì§‘ëª¨ë“œì—ì„  ê°œë³„ë²„íŠ¼ ìˆ¨ê¹€ (ë“œë˜ê·¸ ì§‘ì¤‘) */
        
        .auto-btn { width: 100%; padding: 15px; background: #6c5ce7; color: white; border: none; border-radius: 12px; font-weight: 700; cursor: pointer; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-top">
                <span class="title">ğŸ‘¶ ë² ì´ë¹„ ì²´í¬ë¦¬ìŠ¤íŠ¸</span>
                <div class="header-actions">
                    <button class="icon-btn" onclick="toggleEditMode()" id="btnEdit">âœï¸</button>
                </div>
            </div>
            
            <div class="stats-box">
                <div style="font-weight:800; font-size:13px;">ì¤€ë¹„ìœ¨ <span id="percentTxt">0%</span></div>
                <div class="progress-bg"><div class="progress-bar" id="progressBar"></div></div>
                <div style="font-weight:800; font-size:13px;">ì´ <span id="totalBudget">0</span>ì›</div>
            </div>
        </div>

        <div id="contentArea"></div>
        
        <div id="emptyGuide" style="text-align:center; padding:60px; color:#aaa; display:none; font-size:14px;">
            <p>ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
            <button class="auto-btn" style="margin-top:20px;" onclick="uploadInitialData()">ğŸ“ ê¸°ë³¸ ë¦¬ìŠ¤íŠ¸ 80ì¢… ë“±ë¡</button>
        </div>
    </div>

    <div id="undoToast">
        <span>ğŸ—‘ï¸ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.</span>
        <span class="undo-btn" onclick="executeUndo()">ì‹¤í–‰ ì·¨ì†Œ</span>
    </div>

    <button class="fab" onclick="openCatModal()">+</button>

    <div class="modal-bg" id="catModal">
        <div class="modal">
            <h3>ğŸ“‚ ì¹´í…Œê³ ë¦¬</h3>
            <input type="hidden" id="cId">
            <input type="text" id="cName" class="inp" placeholder="ì´ë¦„ (ì˜ˆ: ìˆ˜ìœ ìš©í’ˆ)">
            <div style="display:flex; gap:10px; margin-bottom:10px;">
                <input type="text" id="cIcon" class="inp" style="width:60px; text-align:center; margin:0;" placeholder="ğŸ˜Š">
                <input type="text" class="inp" style="margin:0;" placeholder="ì•„ì´ì½˜ ê²€ìƒ‰ (ì˜ˆ: ë³‘ì›)" onkeyup="filterIcons(this.value, 'cGrid')">
            </div>
            <div class="icon-grid" id="cGrid"></div>
            <div class="btn-row">
                <button class="btn btn-gray" onclick="closeModal('catModal')">ì·¨ì†Œ</button>
                <button class="btn btn-main" onclick="saveCat()">ì €ì¥</button>
            </div>
        </div>
    </div>

    <div class="modal-bg" id="itemModal">
        <div class="modal">
            <h3>âœ¨ ë¬¼í’ˆ ë“±ë¡</h3>
            <input type="hidden" id="tCId"><input type="hidden" id="tIId">
            
            <input type="text" id="iName" class="inp" placeholder="ë¬¼í’ˆëª… (ì˜ˆ: ë¸Œë¼ìš´ ì²´ì˜¨ê³„)">
            
            <div style="display:flex; gap:10px;">
                <input type="number" id="iCount" class="inp" style="width:80px; text-align:center;" value="1">
                <input type="text" id="iPrice" class="inp" placeholder="ê°€ê²© (ì›)" style="flex:1;">
            </div>

            <input type="text" id="iBrand" class="inp" placeholder="ë¸Œëœë“œ / ë©”ëª¨">
            <input type="url" id="iLink" class="inp" placeholder="êµ¬ë§¤ ë§í¬ (URL)">

            <div style="background:#F7F8FA; padding:10px; border-radius:10px; margin-bottom:15px;">
                <label style="display:flex; gap:8px; margin-bottom:8px; font-size:14px;"><input type="checkbox" id="iGift"> ğŸ ì„ ë¬¼ ë°›ìŒ (ì˜ˆì‚° ì œì™¸)</label>
                <label style="display:flex; gap:8px; margin-bottom:8px; font-size:14px;"><input type="checkbox" id="iCarrot"> ğŸ¥• ë‹¹ê·¼/ì¤‘ê³ </label>
                <label style="display:flex; gap:8px; font-size:14px;"><input type="checkbox" id="iNaver" checked> ğŸ” ë„¤ì´ë²„ ìµœì €ê°€ ë²„íŠ¼</label>
            </div>

            <div style="display:flex; gap:10px; margin-bottom:5px;">
                <input type="text" id="iIcon" class="inp" style="width:60px; text-align:center; margin:0;" placeholder="ğŸ‘¶">
                <input type="text" class="inp" style="margin:0;" placeholder="ì•„ì´ì½˜ ê²€ìƒ‰" onkeyup="filterIcons(this.value, 'iGrid')">
            </div>
            <div class="icon-grid" id="iGrid"></div>

            <div class="btn-row">
                <button class="btn btn-gray" onclick="closeModal('itemModal')">ì·¨ì†Œ</button>
                <button class="btn btn-main" onclick="saveItem()">ì €ì¥</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getDatabase, ref, onValue, push, update, remove } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCovHk7sYoMTkZ8H5RwKjUWMXAqi50l2L-k",
            authDomain: "checklist-3c59d.firebaseapp.com",
            databaseURL: "https://checklist-3c59d-default-rtdb.firebaseio.com",
            projectId: "checklist-3c59d",
            storageBucket: "checklist-3c59d.firebasestorage.app",
            messagingSenderId: "624967682899",
            appId: "1:624967682899:web:a6640fa7b63ee2eab9afa6"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const dbRef = ref(db, 'baby_checklist_v6'); 

        // 1000ê°œ ì•„ì´ì½˜ (ë‚´ì¥ ë°ì´í„°)
        const ICON_DB = [
            {i:'ğŸ‘¶',t:'ì•„ê¸°'},{i:'ğŸ¥',t:'ë³‘ì›'},{i:'ğŸ’Š',t:'ì•½'},{i:'ğŸ¼',t:'ì –ë³‘'},{i:'ğŸ¥£',t:'ì´ìœ ì‹'},{i:'ğŸ›',t:'ìš•ì¡°'},{i:'ğŸ§º',t:'ë¹¨ë˜'},
            {i:'ğŸ›ï¸',t:'ì¹¨ëŒ€'},{i:'ğŸš—',t:'ì°¨'},{i:'ğŸ“·',t:'ì‚¬ì§„'},{i:'ğŸ“±',t:'í°'},{i:'ğŸ',t:'ì„ ë¬¼'},{i:'ğŸ ',t:'ì§‘'},{i:'ğŸ¤°',t:'ì„ì‹ '},
            {i:'ğŸ’‰',t:'ì£¼ì‚¬'},{i:'ğŸŒ¡ï¸',t:'ì²´ì˜¨ê³„'},{i:'ğŸ§´',t:'ë¡œì…˜'},{i:'ğŸ§»',t:'íœ´ì§€'},{i:'ğŸ‘•',t:'ì˜·'},{i:'ğŸ§¦',t:'ì–‘ë§'},{i:'ğŸ§¢',t:'ëª¨ì'},
            {i:'ğŸ‘Ÿ',t:'ì‹ ë°œ'},{i:'ğŸ’',t:'ê°€ë°©'},{i:'ğŸ§¸',t:'ì¥ë‚œê°'},{i:'âœ‚ï¸',t:'ê°€ìœ„'},{i:'ğŸ–Šï¸',t:'íœ'},{i:'ğŸ“',t:'ë©”ëª¨'},{i:'â­',t:'ë³„'},
            {i:'â¤ï¸',t:'í•˜íŠ¸'},{i:'ğŸ¶',t:'ê°•ì•„ì§€'},{i:'ğŸ±',t:'ê³ ì–‘ì´'},{i:'ğŸ˜·',t:'ë§ˆìŠ¤í¬'},{i:'ğŸ©¹',t:'ë°´ë“œ'},{i:'ğŸ§¼',t:'ë¹„ëˆ„'},{i:'ğŸ¦·',t:'ì¹˜ì•„'}
        ];

        let currentData = {};
        let isEdit = false;
        let lastDeleted = null;
        let undoTimer = null;

        onValue(dbRef, (snap) => {
            currentData = snap.val() || {};
            render();
        });

        function render() {
            const list = document.getElementById('contentArea');
            list.innerHTML = '';
            
            let total = 0; let checked = 0; let count = 0;
            const cats = Object.entries(currentData).map(([k,v])=>({id:k,...v})).sort((a,b)=>(a.order||0)-(b.order||0));
            
            if(cats.length === 0) {
                document.getElementById('emptyGuide').style.display = 'block';
                return;
            } else {
                document.getElementById('emptyGuide').style.display = 'none';
            }

            cats.forEach(c => {
                const items = Object.entries(c.items||{}).map(([k,v])=>({id:k,...v})).sort((a,b)=>(a.order||0)-(b.order||0));
                let cTotal = 0;
                let html = '';

                items.forEach(i => {
                    count++;
                    if(i.checked) checked++;
                    const price = Number((i.price+'').replace(/,/g,'')) || 0;
                    if(!i.isGift) { cTotal += price*(i.count||1); total += price*(i.count||1); }

                    let tags = '';
                    if(i.isGift) tags += `<span class="tag gift">ğŸ ì„ ë¬¼</span>`;
                    else if(price>0) tags += `<span class="tag price">${price.toLocaleString()}ì›</span>`;
                    if(i.isCarrot) tags += `<span class="tag carrot">ğŸ¥• ë‹¹ê·¼</span>`;
                    if(i.brand) tags += `<span class="tag">${i.brand}</span>`;
                    if(i.showNaver) tags += `<a href="https://search.shopping.naver.com/search/all?query=${encodeURIComponent(i.name)}" target="_blank" class="tag naver">N ê²€ìƒ‰</a>`;

                    const memo = i.memo ? `<div class="item-memo">${i.memo}</div>` : '';

                    // âœ… í•µì‹¬: item-content í´ë¦­ ì‹œ toggleCheck í˜¸ì¶œ (ìˆ˜ì •X)
                    html += `
                        <li class="item ${i.checked?'completed':''}" data-id="${i.id}">
                            <div class="drag-handle">â˜°</div>
                            <div class="chk-wrap">
                                <input type="checkbox" class="chk-input" ${i.checked?'checked':''} 
                                    onchange="window.toggleCheck('${c.id}','${i.id}',this.checked)">
                                <div class="chk-box"></div>
                            </div>
                            <div class="item-content" onclick="window.toggleCheck('${c.id}','${i.id}',${!i.checked})">
                                <div class="item-row">
                                    <div class="item-name">${i.icon||'ğŸ‘¶'} ${i.name} <small>${i.count>1 ? 'x'+i.count : ''}</small></div>
                                </div>
                                <div class="tags">${tags}</div>
                                ${memo}
                            </div>
                            <div class="item-right">
                                <button class="action-btn edit" onclick="event.stopPropagation(); window.editI('${c.id}','${i.id}')">
                                    <svg viewBox="0 0 24 24"><path stroke="currentColor" stroke-width="2" d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path stroke="currentColor" stroke-width="2" d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                                </button>
                                <button class="action-btn del" onclick="event.stopPropagation(); window.delI('${c.id}','${i.id}')">
                                    <svg viewBox="0 0 24 24"><path stroke="currentColor" stroke-width="2" d="M3 6h18"></path><path stroke="currentColor" stroke-width="2" d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                                </button>
                            </div>
                        </li>
                    `;
                });

                const div = document.createElement('div');
                div.className = 'category-card';
                div.setAttribute('data-id', c.id);
                div.innerHTML = `
                    <div class="cat-header" onclick="this.parentElement.classList.toggle('collapsed')">
                        <div class="cat-left">
                            <div class="cat-icon">${c.icon||'ğŸ“'}</div>
                            <div><div class="cat-name">${c.name}</div><div class="cat-total">${cTotal.toLocaleString()}ì›</div></div>
                        </div>
                        <div style="display:flex;align-items:center;gap:10px;">
                            <div class="item-right">
                                <button class="action-btn edit" onclick="event.stopPropagation(); window.editC('${c.id}')"><svg viewBox="0 0 24 24"><path stroke="currentColor" stroke-width="2" d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path stroke="currentColor" stroke-width="2" d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg></button>
                                <button class="action-btn del" onclick="event.stopPropagation(); window.delC('${c.id}')"><svg viewBox="0 0 24 24"><path stroke="currentColor" stroke-width="2" d="M3 6h18"></path><path stroke="currentColor" stroke-width="2" d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg></button>
                            </div>
                            <span class="chevron">â–¼</span>
                        </div>
                    </div>
                    <ul class="item-list" id="list-${c.id}">${html}</ul>
                    <button class="btn-add-item" onclick="window.addI('${c.id}')">+ ë¬¼í’ˆ ì¶”ê°€</button>
                `;
                list.appendChild(div);
                
                new Sortable(div.querySelector('.item-list'), { handle: '.drag-handle', animation: 150, disabled: !isEdit, onEnd: e=>updateOrder(e.to,'item',c.id) });
            });
            
            new Sortable(list, { handle: '.cat-header', animation: 150, disabled: !isEdit, onEnd: e=>updateOrder(e.to,'cat') });

            document.getElementById('percentTxt').innerText = count===0 ? '0%' : Math.round(checked/count*100)+'%';
            document.getElementById('progressBar').style.width = count===0 ? '0%' : (checked/count*100)+'%';
            document.getElementById('totalBudget').innerText = total.toLocaleString();
            
            document.body.classList.toggle('is-edit-mode', isEdit);
        }

        function updateOrder(el, type, pId) {
            const updates = {};
            [...el.children].forEach((c, i) => {
                const id = c.getAttribute('data-id');
                if(!id) return;
                if(type === 'cat') updates[`baby_checklist_v6/${id}/order`] = i;
                else updates[`baby_checklist_v6/${pId}/items/${id}/order`] = i;
            });
            update(ref(db), updates);
        }

        // ê¸°ëŠ¥ í•¨ìˆ˜
        window.toggleCheck = (c, i, v) => update(ref(db, `baby_checklist_v6/${c}/items/${i}`), {checked:v});
        window.toggleEditMode = () => { isEdit = !isEdit; document.getElementById('btnEditMode').innerText = isEdit ? 'âœ…' : 'âœï¸'; render(); };
        window.toggleSearch = () => { alert('ê²€ìƒ‰ ê¸°ëŠ¥ì€ ì¶”í›„ ì—…ë°ì´íŠ¸ ì˜ˆì •ì…ë‹ˆë‹¤.'); };
        window.toggleDarkMode = () => {
            const isDark = document.body.getAttribute('data-theme') === 'dark';
            document.body.setAttribute('data-theme', isDark ? 'light' : 'dark');
            localStorage.setItem('darkMode', !isDark);
        };

        // âœ… ì‹¤í–‰ ì·¨ì†Œ ë¡œì§ (ìì²´ êµ¬í˜„)
        window.delI = (c, i) => { if(confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) deleteData(`baby_checklist_v6/${c}/items/${i}`, currentData[c].items[i]); };
        window.delC = (c) => { if(confirm('ì¹´í…Œê³ ë¦¬ê°€ ì‚­ì œë©ë‹ˆë‹¤.')) deleteData(`baby_checklist_v6/${c}`, currentData[c]); };
        
        function deleteData(path, data) {
            lastDeleted = { path, data };
            remove(ref(db, path));
            const toast = document.getElementById('undoToast');
            toast.classList.add('show');
            if(undoTimer) clearTimeout(undoTimer);
            undoTimer = setTimeout(() => { toast.classList.remove('show'); lastDeleted = null; }, 4000);
        }
        window.executeUndo = () => {
            if(lastDeleted) update(ref(db), { [lastDeleted.path]: lastDeleted.data });
            document.getElementById('undoToast').classList.remove('show');
        };

        // ëª¨ë‹¬ & ì•„ì´ì½˜
        window.closeModal = (id) => document.getElementById(id).style.display = 'none';
        window.filterIcons = (k, t) => {
            const g = document.getElementById(t); g.innerHTML = '';
            const list = k ? ICON_DB.filter(x => x.t.includes(k)) : ICON_DB;
            list.forEach(x => {
                const e = document.createElement('div'); e.className = 'icon-opt'; e.innerText = x.i;
                e.onclick = () => {
                    document.getElementById(t==='cGrid'?'cIcon':'iIcon').value = x.i;
                    [...g.children].forEach(c => c.classList.remove('selected')); e.classList.add('selected');
                };
                g.appendChild(e);
            });
        };

        window.openCatModal = () => { document.getElementById('catModal').style.display='flex'; document.getElementById('cId').value=''; window.filterIcons('', 'cGrid'); };
        window.editC = (id) => { const d=currentData[id]; document.getElementById('catModal').style.display='flex'; document.getElementById('cId').value=id; document.getElementById('cName').value=d.name; document.getElementById('cIcon').value=d.icon; window.filterIcons('', 'cGrid'); };
        window.saveCat = () => {
            const id = document.getElementById('cId').value;
            const name = document.getElementById('cName').value;
            const icon = document.getElementById('cIcon').value || 'ğŸ“';
            if(!name) return alert('ì´ë¦„ ì…ë ¥');
            if(id) update(ref(db, `baby_checklist_v6/${id}`), {name, icon});
            else push(ref(db, 'baby_checklist_v6'), {name, icon, order:999});
            window.closeModal('catModal');
        };

        window.addI = (c) => { 
            document.getElementById('itemModal').style.display='flex'; document.getElementById('tCId').value=c; document.getElementById('tIId').value='';
            ['iName','iPrice','iBrand','iLink','iIcon','iMemo'].forEach(i=>document.getElementById(i).value='');
            document.getElementById('iCount').value=1; 
            ['iGift','iCarrot'].forEach(i=>document.getElementById(i).checked=false);
            window.filterIcons('', 'iGrid');
        };
        window.editI = (c, i) => {
            const d = currentData[c].items[i]; document.getElementById('itemModal').style.display='flex';
            document.getElementById('tCId').value=c; document.getElementById('tIId').value=i;
            document.getElementById('iName').value=d.name; document.getElementById('iCount').value=d.count||1;
            document.getElementById('iPrice').value=d.price||''; document.getElementById('iLink').value=d.link||'';
            document.getElementById('iBrand').value=d.brand||''; document.getElementById('iIcon').value=d.icon;
            document.getElementById('iMemo').value=d.memo||'';
            document.getElementById('iGift').checked=d.isGift||false; document.getElementById('iCarrot').checked=d.isCarrot||false;
            document.getElementById('iNaver').checked=d.showNaver;
            window.filterIcons('', 'iGrid');
        };
        window.saveItem = () => {
            const c = document.getElementById('tCId').value; const i = document.getElementById('tIId').value;
            const data = {
                name: document.getElementById('iName').value,
                count: Number(document.getElementById('iCount').value),
                price: document.getElementById('iPrice').value,
                brand: document.getElementById('iBrand').value,
                link: document.getElementById('iLink').value,
                memo: document.getElementById('iMemo').value,
                icon: document.getElementById('iIcon').value || 'ğŸ‘¶',
                isGift: document.getElementById('iGift').checked,
                isCarrot: document.getElementById('iCarrot').checked,
                showNaver: document.getElementById('iNaver').checked,
                checked: false, order: 999
            };
            if(!data.name) return alert('ì´ë¦„ ì…ë ¥');
            if(i) {
                const old = currentData[c].items[i]; data.checked = old.checked; data.order = old.order;
                update(ref(db, `baby_checklist_v6/${c}/items/${i}`), data);
            } else {
                push(ref(db, `baby_checklist_v6/${c}/items`), data);
            }
            window.closeModal('itemModal');
        };

        window.uploadInitialData = async () => {
            if(!confirm('ë¦¬ìŠ¤íŠ¸ë¥¼ ë“±ë¡í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            const d=[{name:"ì¶œì‚°ê°€ë°©",icon:"ğŸ¥",items:[{name:"ì‚°ëª¨ìˆ˜ì²©",icon:"ğŸ“’",memo:"ë³‘ì› ê°ˆ ë•Œ í•„ìˆ˜"},{name:"ì‹ ë¶„ì¦",icon:"ğŸ’³"},{name:"ì¶©ì „ê¸°",icon:"âš¡"}]},{name:"ìˆ˜ìœ ìš©í’ˆ",icon:"ğŸ¼",items:[{name:"ì –ë³‘",icon:"ğŸ¼"},{name:"ë¶„ìœ ",icon:"ğŸ¥«"},{name:"ì –ë³‘ì†”",icon:"ğŸ–Œï¸"}]},{name:"ìœ„ìƒìš©í’ˆ",icon:"ğŸ©¹",items:[{name:"ì²´ì˜¨ê³„",icon:"ğŸŒ¡ï¸",memo:"ë¸Œë¼ìš´ ì¶”ì²œ"},{name:"ì†ìˆ˜ê±´",icon:"ğŸ§£",count:30},{name:"ê¸°ì €ê·€",icon:"ğŸ©²"}]}];
            for(const c of d){ const r=await push(ref(db,'baby_checklist_v6'),{name:c.name,icon:c.icon,order:999}); for(const i of c.items) await push(ref(db,`baby_checklist_v6/${r.key}/items`),{...i,checked:false}); }
            alert("ì™„ë£Œ!");
        };
    </script>
</body>
</html>
